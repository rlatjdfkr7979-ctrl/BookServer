<script>
// ✅ 설정값 (Python 코드 동일)
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdGuoHeUW-37RFCBgMH7ZUNL0tt_yHQiIFMrif85mrV428Omg/viewform";
const ENTRY_IDS = {
  code: "entry.32105598",
  title: "entry.1234176416",
  author: "entry.628826984",
  status: "entry.12641564",
  renter: "entry.615776096"
};

// CSV 로드
async function loadCSV(file){
  const res = await fetch(file+'?v='+Date.now());
  if(!res.ok) throw new Error(file+' 로드 실패');
  const text = await res.text();
  const parsed = Papa.parse(text.trim(), {skipEmptyLines:true});
  return parsed.data;
}

// 표 렌더링 (QR 버튼 포함)
function renderTable(rows, id, withQR=false){
  const header = rows[0];
  const table = document.getElementById(id);
  const finalHeader = withQR ? [...header, 'QR 생성'] : header;
  table.innerHTML = '<tr>'+finalHeader.map(h=>`<th>${h}</th>`).join('')+'</tr>';

  for(let i=1;i<rows.length;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = rows[i].map(c=>`<td>${c}</td>`).join('');

    // QR 버튼 추가
    if(withQR){
      const code = rows[i].find((_,idx)=>header[idx].replace(/\s/g,'').includes('코드'));
      const title = rows[i].find((_,idx)=>{
        const h = header[idx].replace(/\s/g,'');
        return h.includes('제목') || h.includes('도서명');
      }) || '';
      const author = rows[i].find((_,idx)=>header[idx].replace(/\s/g,'').includes('지은이')) || '';
      const status = rows[i].find((_,idx)=>{
        const h = header[idx].replace(/\s/g,'');
        return h.includes('상태') || h.includes('대출여부');
      }) || '';
      const renter = rows[i].find((_,idx)=>{
        const h = header[idx].replace(/\s/g,'');
        return h.includes('대출자') || h.includes('대여자');
      }) || '';

      const qrCell = document.createElement('td');
      const qrBtn = document.createElement('button');
      qrBtn.textContent = '📷 QR';
      qrBtn.className = 'qr-btn';
      qrBtn.onclick = ()=>generateQR({code, title, author, renter, status});
      qrCell.appendChild(qrBtn);
      tr.appendChild(qrCell);
    }

    table.appendChild(tr);
  }
}

// ✅ QR 생성 (Python 버전과 동일한 URL 구성)
function generateQR(row){
  const {code, title, author, renter, status} = row;
  const statusEncoded = {
    "대출": "%EB%8C%80%EC%B6%9C",
    "반납": "%EB%B0%98%EB%82%A9"
  }[status] || "";

  const qrUrl =
    `${FORM_URL}?usp=pp_url` +
    `&${ENTRY_IDS.code}=${encodeURIComponent(code)}` +
    `&${ENTRY_IDS.title}=${encodeURIComponent(title)}` +
    `&${ENTRY_IDS.author}=${encodeURIComponent(author)}` +
    `&${ENTRY_IDS.renter}=${encodeURIComponent(renter)}` +
    `&${ENTRY_IDS.status}=${statusEncoded}`;

  // 팝업 생성
  const popup = document.createElement('div');
  popup.style = `
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;
  `;
  popup.innerHTML = `
    <div style="background:white;padding:20px;border-radius:10px;text-align:center;">
      <h3>📷 QR 코드 (${code})</h3>
      <div id="qrcode"></div>
      <p style="margin-top:10px;"><a href="${qrUrl}" target="_blank">${qrUrl}</a></p>
      <button id="closePopup" style="margin-top:10px;background:#444;color:white;padding:5px 10px;border:none;border-radius:6px;">닫기</button>
      <button id="downloadQR" style="margin-top:10px;background:#2563eb;color:white;padding:5px 10px;border:none;border-radius:6px;">QR 다운로드</button>
    </div>`;
  document.body.appendChild(popup);

  // QR 생성
  const qrDiv = popup.querySelector("#qrcode");
  new QRCode(qrDiv, {
    text: qrUrl,
    width: 200,
    height: 200,
    colorDark: "#000",
    colorLight: "#fff",
    correctLevel: QRCode.CorrectLevel.H
  });

  popup.querySelector("#closePopup").onclick = ()=>popup.remove();
  popup.querySelector("#downloadQR").onclick = ()=>{
    const img = qrDiv.querySelector("img");
    const a = document.createElement("a");
    a.href = img.src;
    a.download = `${code}.png`;
    a.click();
  };
}

// ✅ 검색
function addSearch(inputId, tableId){
  const input = document.getElementById(inputId);
  let timer;
  input.addEventListener('input', e=>{
    clearTimeout(timer);
    timer = setTimeout(()=>{
      const val = e.target.value.trim();
      const trs = document.querySelectorAll(`#${tableId} tr`);
      for(let i=1;i<trs.length;i++){
        const tr = trs[i];
        const text = tr.textContent;
        tr.style.display = text.includes(val)?'':'none';
      }
    },150);
  });
}

// ✅ 실행 (대출현황 + 도서목록)
Promise.all([loadCSV('books.csv'), loadCSV('library.csv')]).then(([books, library])=>{
  renderTable(books, 'loanTable');
  renderTable(library, 'libraryTable', true);
  addSearch('searchLoans','loanTable');
  addSearch('searchLibrary','libraryTable');

  // ✅ 대출 중 도서만 보기 (수정된 버전)
  const btnFilter = document.getElementById('btnBorrowed');
  let filterActive = false;
  btnFilter.onclick = ()=>{
    filterActive = !filterActive;
    btnFilter.classList.toggle('active', filterActive);
    const trs = document.querySelectorAll('#libraryTable tr');
    const header = library[0];
    const statusIdx = header.findIndex(h => h.replace(/\s/g,'').includes('대출여부') || h.includes('상태'));
    for(let i=1;i<trs.length;i++){
      const td = trs[i].querySelectorAll('td')[statusIdx];
      const isBorrowed = td && /(대출|대여)/.test(td.textContent);
      trs[i].style.display = (filterActive && !isBorrowed)?'none':'';
      trs[i].classList.toggle('borrowed', isBorrowed);
    }
  };
});
</script>
