<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<style>
  body{font-family:'Pretendard','Noto Sans KR',sans-serif;background:#f8fafc;margin:0;padding:24px;color:#222}
  h1{text-align:center;color:#004080;margin-bottom:10px}
  nav{text-align:center;margin-bottom:16px}
  button{background:#004080;color:#fff;border:none;border-radius:8px;padding:8px 14px;margin:0 6px;cursor:pointer;font-size:14px}
  button.active{background:#2563eb}
  button.filter{background:#6b7280}
  button.filter.active{background:#16a34a}
  button.qr-btn{background:#0d9488;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:13px}
  input{display:block;margin:12px auto 16px;padding:8px 14px;font-size:14px;border:1px solid #cbd5e1;border-radius:6px;width:260px}
  .table-wrap{max-height:70vh;overflow:auto;border-radius:8px;background:#fff;box-shadow:0 0 5px rgba(0,0,0,.08)}
  table{width:100%;border-collapse:collapse;min-width:960px}
  th,td{border:1px solid #e2e8f0;padding:7px 10px;text-align:left;font-size:13.5px}
  th{background:#f1f5f9;color:#004080;position:sticky;top:0;z-index:10}
  tr:nth-child(even){background:#fafafa}
  tr:hover{background:#eef6ff}
  tr.borrowed td{background:#fff8e1}
  tr.overdue td{background:#ffe4e1 !important;} /* âœ… ì—°ì²´ í‘œì‹œ */
  .hidden{display:none}
  footer{text-align:center;color:#667085;font-size:13px;margin-top:18px}
  #historyModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;}
  #historyModal .inner{background:#fff;border-radius:10px;max-width:800px;width:95%;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);}
  #historyModal .content{padding:24px;overflow:auto;flex:1;}
  #historyModal .buttons{padding:16px 24px;border-top:1px solid #e2e8f0;background:#fff;border-radius:0 0 10px 10px;position:sticky;bottom:0;}
  #historyModal h3{margin:0 0 16px 0;font-size:18px;color:#004080;border-bottom:2px solid #e2e8f0;padding-bottom:8px;}
  #historyModal table{font-size:14px !important;min-width:auto !important;table-layout:fixed;width:100%;}
  #historyModal th{background:#f8fafc;padding:10px 12px;font-weight:600;word-wrap:break-word;}
  #historyModal td{padding:10px 12px;word-wrap:break-word;overflow-wrap:break-word;}
  #historyModal th:first-child, #historyModal td:first-child{width:30%;}
  #historyModal th:nth-child(2), #historyModal td:nth-child(2){width:25%;}
  #historyModal th:last-child, #historyModal td:last-child{width:45%;}
</style>
</head>
<body>

<h1>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
<nav>
  <button id="btnLoans" class="active">ğŸ“˜ ëŒ€ì¶œ í˜„í™©</button>
  <button id="btnLibrary">ğŸ“— ì „ì²´ ë„ì„œëª©ë¡</button>
  <button id="btnBorrowed" class="filter">ğŸ“• ëŒ€ì¶œ ì¤‘ ë„ì„œë§Œ ë³´ê¸°</button>
  <button id="btnNewest" class="filter" style="background:#7c3aed;">ğŸ“ˆ ìµœì‹  ë„ì„œ ìˆœìœ¼ë¡œ ë³´ê¸°</button>
  <button id="btnRecent" style="background:#15803d;">ğŸ†• ìµœê·¼ 30ì¼ ë„ì„œë§Œ ë³´ê¸°</button>
  <button id="btnAddBook" style="background:#059669;">â• ë„ì„œ ì¶”ê°€</button>
</nav>

<div id="loanSection">
  <input type="text" id="searchLoans" placeholder="ë„ì„œëª…, ëŒ€ì—¬ì, ì½”ë“œë²ˆí˜¸ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="loanTable"></table></div>
</div>

<div id="librarySection" class="hidden">
  <input type="text" id="searchLibrary" placeholder="ì œëª©/ë„ì„œëª…, ì €ì, ì¶œíŒì‚¬ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="libraryTable"></table></div>
</div>

<!-- ë„ì„œ ì´ë ¥ íŒì—… -->
<div id="historyModal">
  <div class="inner">
    <div class="content">
      <h3 id="histTitle">ğŸ“– ë„ì„œ ì´ë ¥</h3>
      <div id="histContent"></div>
    </div>
    <div class="buttons">
      <button onclick="closeHistory()" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<footer>Â© ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ | ì‹œìŠ¤í…œ ë¬¸ì˜(ê¹€ì„±ë½ ëŒ€ë¦¬ 417)</footer>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
/* ====== 0) í™˜ê²½ ì„¤ì • ====== */
const FORM_URL="https://docs.google.com/forms/d/e/1FAIpQLSdGuoHeUW-37RFCBgMH7ZUNL0tt_yHQiIFMrif85mrV428Omg/viewform";
const ENTRY_IDS={code:"entry.32105598",title:"entry.1234176416",author:"entry.628826984",status:"entry.12641564",renter:"entry.615776096"};

/* ====== ìœ í‹¸ ====== */
const norm=s=>String(s||'').replace(/\uFEFF/g,'').trim();
const normHead=s=>norm(s).replace(/\s/g,'');
const includesAny=(h,keys)=>keys.some(k=>normHead(h).includes(k));
function findColIndex(header,candidates){return header.findIndex(h=>includesAny(h,candidates));}

/* ====== CSV ë¡œë“œ ====== */
async function loadCSV(file){
  const res=await fetch(file+'?v='+Date.now());
  if(!res.ok) throw new Error(file+' ë¡œë“œ ì‹¤íŒ¨');
  const text=await res.text();
  return Papa.parse(text.trim(),{skipEmptyLines:true}).data;
}

/* ====== QR ìƒì„± ====== */
function generateQR({code,title,author,renter,status}){
  // ìƒíƒœì— ë”°ë¥¸ ë¼ë””ì˜¤ë°•ìŠ¤ ì„ íƒ ë¡œì§ ê°œì„ 
  let statusEncoded = "";
  if(status.includes('ë°˜ë‚©')){
    statusEncoded = "%EB%B0%98%EB%82%A9"; // ë°˜ë‚©
  } else if(status.includes('ëŒ€ì¶œ') || status.includes('ëŒ€ì—¬') || status.includes('ì—°ì²´')){
    statusEncoded = "%EB%8C%80%EC%B6%9C"; // ëŒ€ì¶œ (ì—°ì²´ í¬í•¨)
  }
  
  const url=`${FORM_URL}?usp=pp_url&${ENTRY_IDS.code}=${encodeURIComponent(code)}&${ENTRY_IDS.title}=${encodeURIComponent(title)}&${ENTRY_IDS.author}=${encodeURIComponent(author)}&${ENTRY_IDS.renter}=${encodeURIComponent(renter)}&${ENTRY_IDS.status}=${statusEncoded}`;
  const layer=document.createElement('div');
  layer.style=`position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;`;
  layer.innerHTML=`<div style="background:#fff;padding:18px 22px;border-radius:10px;text-align:center;max-width:420px"><h3 style="margin:6px 0 12px">ğŸ“· QR ì½”ë“œ (${code})</h3><div id="qrbox" style="margin:0 auto 10px;width:220px;height:220px"></div><p style="word-break:break-all;font-size:12px;"><a href="${url}" target="_blank">${url}</a></p><div style="margin-top:10px"><button id="qrClose" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:6px 10px;margin-right:6px">ë‹«ê¸°</button><button id="qrDown"  style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px">QR ë‹¤ìš´ë¡œë“œ</button></div></div>`;
  document.body.appendChild(layer);
  new QRCode(layer.querySelector('#qrbox'),{text:url,width:220,height:220,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.H});
  layer.querySelector('#qrClose').onclick=()=>layer.remove();
  layer.querySelector('#qrDown').onclick=()=>{const img=layer.querySelector('#qrbox img');const a=document.createElement('a');a.href=img.src;a.download=`${code}.png`;a.click();};
}

/* ====== í‘œ ë Œë”ë§ ====== */
function renderTable(rows,id,withQR=false){
  const header=rows[0];
  const table=document.getElementById(id);
  const finalHeader=withQR?[...header,'QR ìƒì„±']:header;
  
  // í—¤ë” ìƒì„± (ì •ë ¬ ê¸°ëŠ¥ í¬í•¨)
  const headerRow=document.createElement('tr');
  finalHeader.forEach((h,idx)=>{
    const th=document.createElement('th');
    th.textContent=h;
    
    // QR ìƒì„± ì—´ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì •ë ¬ ê¸°ëŠ¥ ì¶”ê°€
    if(idx<header.length){
      th.style.cursor='pointer';
      th.style.userSelect='none';
      th.onclick=()=>sortTable(rows,id,idx,withQR);
      
      // ì •ë ¬ í‘œì‹œë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼
      th.addEventListener('mouseenter',()=>{
        if(!th.textContent.includes('â†‘')&&!th.textContent.includes('â†“')){
          th.style.background='#e2e8f0';
        }
      });
      th.addEventListener('mouseleave',()=>{
        if(!th.textContent.includes('â†‘')&&!th.textContent.includes('â†“')){
          th.style.background='#f1f5f9';
        }
      });
    }
    headerRow.appendChild(th);
  });
  
  table.innerHTML='';
  table.appendChild(headerRow);
  
  for(let i=1;i<rows.length;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=rows[i].map((c,j)=>`<td>${c}</td>`).join('');
    // ì œëª© í´ë¦­ ì‹œ ì´ë ¥ ë³´ê¸°
    if(withQR){
      const titleIdx=findColIndex(header,['ì œëª©','ë„ì„œëª…']);
      const codeIdx=findColIndex(header,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
      const tdTitle=tr.children[titleIdx];
      if(tdTitle){
        tdTitle.style.color='#2563eb';
        tdTitle.style.cursor='pointer';
        tdTitle.onclick=()=>showHistory(norm(rows[i][codeIdx]),norm(rows[i][titleIdx]));
      }
      const tdQR=document.createElement('td');
      const code=rows[i][codeIdx];
      const author=rows[i][findColIndex(header,['ì§€ì€ì´','ì €ì'])];
      const renter=rows[i][findColIndex(header,['ëŒ€ì¶œì','ëŒ€ì—¬ì'])];
      const status=rows[i][findColIndex(header,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€'])];
      const btn=document.createElement('button');
      btn.className='qr-btn';btn.textContent='ğŸ“· QR';
      btn.onclick=()=>generateQR({code,title:rows[i][titleIdx],author,renter,status});
      tdQR.appendChild(btn);tr.appendChild(tdQR);
    }
    table.appendChild(tr);
  }
}

/* ====== í…Œì´ë¸” ì •ë ¬ ====== */
let sortState={}; // ê° í…Œì´ë¸”ì˜ ì •ë ¬ ìƒíƒœ ì €ì¥
function sortTable(originalRows,tableId,colIdx,withQR=false){
  const table=document.getElementById(tableId);
  const rows=Array.from(table.querySelectorAll('tr')).slice(1); // í—¤ë” ì œì™¸í•œ ë°ì´í„° í–‰ë“¤
  const header=originalRows[0];
  
  // ì •ë ¬ ìƒíƒœ í™•ì¸ (ê¸°ë³¸: ì˜¤ë¦„ì°¨ìˆœ)
  const sortKey=`${tableId}_${colIdx}`;
  const isAsc=!sortState[sortKey]; // í˜„ì¬ ìƒíƒœì˜ ë°˜ëŒ€ë¡œ ì„¤ì •
  sortState[sortKey]=isAsc;
  
  // ëª¨ë“  í—¤ë”ì—ì„œ ì •ë ¬ í‘œì‹œ ì œê±°
  table.querySelectorAll('th').forEach(th=>{
    th.textContent=th.textContent.replace(/\s*[â†‘â†“]\s*/g,'');
    th.style.background='#f1f5f9';
  });
  
  // í˜„ì¬ ì •ë ¬ ì—´ì— í‘œì‹œ ì¶”ê°€
  const currentTh=table.querySelectorAll('th')[colIdx];
  currentTh.textContent+=isAsc?' â†‘':' â†“';
  currentTh.style.background='#dbeafe';
  
  // ë°ì´í„° ì •ë ¬
  rows.sort((a,b)=>{
    const aVal=a.cells[colIdx]?.textContent||'';
    const bVal=b.cells[colIdx]?.textContent||'';
    
    // ìˆ«ìì¸ì§€ í™•ì¸
    const aNum=parseFloat(aVal.replace(/[^\d.-]/g,''));
    const bNum=parseFloat(bVal.replace(/[^\d.-]/g,''));
    
    let result;
    if(!isNaN(aNum)&&!isNaN(bNum)){
      result=aNum-bNum; // ìˆ«ì ì •ë ¬
    }else{
      result=aVal.localeCompare(bVal,'ko',{numeric:true}); // ë¬¸ìì—´ ì •ë ¬ (í•œêµ­ì–´ ì§€ì›)
    }
    
    return isAsc?result:-result;
  });
  
  // ì •ë ¬ëœ í–‰ë“¤ì„ ë‹¤ì‹œ í…Œì´ë¸”ì— ì¶”ê°€
  rows.forEach(row=>table.appendChild(row));
  
  // ì •ë ¬ í›„ ì—°ì²´ ìƒ‰ìƒ ë‹¤ì‹œ ì ìš© (ë„ì„œëª©ë¡ì˜ ê²½ìš°)
  if(withQR){
    const statusIdx=findColIndex(header,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
    rows.forEach(tr=>{
      const td=tr.querySelectorAll('td')[statusIdx];
      if(td&&td.textContent.includes('ì—°ì²´')){
        tr.classList.add('overdue');
      }
    });
  }
}

/* ====== ê²€ìƒ‰ ====== */
function addSearch(inputId,tableId){
  const input=document.getElementById(inputId);
  let timer;
  input.addEventListener('input',e=>{
    clearTimeout(timer);
    timer=setTimeout(()=>{
      const val=e.target.value.trim();
      const trs=document.querySelectorAll(`#${tableId} tr`);
      for(let i=1;i<trs.length;i++){
        const tr=trs[i];
        const text=tr.textContent;
        tr.style.display=text.includes(val)?'':'none';
      }
    },150);
  });
}

/* ====== ì—°ì²´ íŒë³„ ====== */
function isOverdue(dateStr,status){
  if(!dateStr||status.includes('ë°˜ë‚©'))return false;
  const d=new Date(dateStr);
  if(isNaN(d))return false;
  const diff=(Date.now()-d.getTime())/(1000*60*60*24);
  return diff>14;
}

/* ====== ë„ì„œ ì´ë ¥ íŒì—… ====== */
function showHistory(code,title){
  const modal=document.getElementById('historyModal');
  const histTitle=document.getElementById('histTitle');
  const histContent=document.getElementById('histContent');
  histTitle.textContent=`ğŸ“– ${title} (${code})`;
  const recs=window.booksData.filter(r=>norm(r[1])===code);
  if(recs.length===0){histContent.innerHTML='<p>ì´ë ¥ ì—†ìŒ</p>';}
  else{
    histContent.innerHTML='<table style="width:100%;border-collapse:collapse;font-size:13px"><tr><th>ë“±ë¡ì¼</th><th>ëŒ€ì—¬ì</th><th>ìƒíƒœ</th></tr>'+recs.map(r=>`<tr><td>${r[0]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`).join('')+'</table>';
  }
  modal.style.display='flex';
  
  // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° ê¸°ëŠ¥
  modal.onclick=(e)=>{
    if(e.target===modal){
      closeHistory();
    }
  };
  
  // íŒì—… ë‚´ë¶€ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
  modal.querySelector('.inner').onclick=(e)=>{
    e.stopPropagation();
  };
}
function closeHistory(){
  const modal=document.getElementById('historyModal');
  modal.style.display='none';
  modal.onclick=null; // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
}

/* ====== ë©”ì¸ ì‹¤í–‰ ====== */
Promise.all([loadCSV('books.csv'),loadCSV('library.csv')]).then(([books,library])=>{
  window.booksData=books; // ì´ë ¥ íŒì—…ìš© ì €ì¥
  renderTable(books,'loanTable');

  const bh=books[0].map(norm);
  const bDateIdx=findColIndex(bh,['ë“±ë¡ì¼','ëŒ€ì¶œì¼','ì¼ì']);
  const bCodeIdx=findColIndex(bh,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
  const bStatusIdx=findColIndex(bh,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
  const bUserIdx=findColIndex(bh,['ëŒ€ì—¬ì','ëŒ€ì¶œì']);
  const latestByCode={};

  for(let i=1;i<books.length;i++){
    const date=norm(books[i][bDateIdx]);
    const code=norm(books[i][bCodeIdx]);
    const status=norm(books[i][bStatusIdx]);
    const borrower=norm(books[i][bUserIdx]);
    if(!code)continue;
    if(!latestByCode[code])latestByCode[code]={status:'',borrower:'',lastReturn:''};
    if(status.includes('ë°˜ë‚©'))latestByCode[code].lastReturn=date;
    latestByCode[code].status=status;
    latestByCode[code].borrower=borrower;
  }

  const lh=library[0].map(norm);
  const lCodeIdx=findColIndex(lh,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
  let lStatusIdx=findColIndex(lh,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
  let lUserIdx=findColIndex(lh,['ëŒ€ì—¬ì','ëŒ€ì¶œì']);
  if(lStatusIdx===-1){library[0].push('ëŒ€ì¶œì—¬ë¶€');lStatusIdx=library[0].length-1;}
  if(lUserIdx===-1){library[0].push('ëŒ€ì¶œì');lUserIdx=library[0].length-1;}

  for(let i=1;i<library.length;i++){
    const code=norm(library[i][lCodeIdx]);
    const rec=latestByCode[code];
    if(!rec){library[i][lStatusIdx]='';library[i][lUserIdx]='';continue;}
    if(rec.status.includes('ë°˜ë‚©')){
      library[i][lStatusIdx]='ë°˜ë‚©';
      library[i][lUserIdx]='';
    }else{
      library[i][lStatusIdx]=rec.status||'ëŒ€ì¶œ';
      library[i][lUserIdx]=rec.borrower||'';
      // âœ… ì—°ì²´ ê³„ì‚° ì¶”ê°€
      const loanRow=books.find(b=>norm(b[bCodeIdx])===code);
      const loanDate=loanRow?loanRow[bDateIdx]:'';
      if(isOverdue(loanDate,rec.status))library[i][lStatusIdx]='ì—°ì²´';
    }
  }

  renderTable(library,'libraryTable',true);
  addSearch('searchLoans','loanTable');
  addSearch('searchLibrary','libraryTable');

  // âœ… ì—°ì²´ ìƒ‰ìƒ í‘œì‹œ
  const trs=document.querySelectorAll('#libraryTable tr');
  const statusIdx=findColIndex(library[0],['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
  for(let i=1;i<trs.length;i++){
    const td=trs[i].querySelectorAll('td')[statusIdx];
    if(td&&td.textContent.includes('ì—°ì²´'))trs[i].classList.add('overdue');
  }

  // âœ… ëŒ€ì¶œ ì¤‘ í•„í„°
  const btnBorrowed=document.getElementById('btnBorrowed');
  let borrowedOn=false;
  btnBorrowed.onclick=()=>{
    // ëŒ€ì¶œ í˜„í™© í™”ë©´ì—ì„œ í´ë¦­í•œ ê²½ìš° ì „ì²´ ë„ì„œëª©ë¡ìœ¼ë¡œ ìë™ ì „í™˜
    if(!document.getElementById('librarySection').classList.contains('hidden')==false){
      document.getElementById('librarySection').classList.remove('hidden');
      document.getElementById('loanSection').classList.add('hidden');
      document.getElementById('btnLibrary').classList.add('active');
      document.getElementById('btnLoans').classList.remove('active');
    }
    
    borrowedOn=!borrowedOn;btnBorrowed.classList.toggle('active',borrowedOn);
    const header=library[0];
    const statusIdx=findColIndex(header,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
    const trs=document.querySelectorAll('#libraryTable tr');
    for(let i=1;i<trs.length;i++){
      const td=trs[i].querySelectorAll('td')[statusIdx];
      const isBorrowed=td&&/(ëŒ€ì¶œ|ëŒ€ì—¬|ì—°ì²´)/.test(td.textContent);
      trs[i].style.display=(borrowedOn&&!isBorrowed)?'none':'';
      trs[i].classList.toggle('borrowed',isBorrowed);
    }
  };

  // âœ… ìµœì‹  ë„ì„œ ìˆœ í•„í„° (library.csv ë°ì´í„° ì—­ìˆœ ì¶œë ¥)
  const btnNewest=document.getElementById('btnNewest');
  let newestOn=false;
  let originalLibraryData=[...library]; // ì›ë³¸ ë°ì´í„° ë³´ì¡´
  btnNewest.onclick=()=>{
    // ëŒ€ì¶œ í˜„í™© í™”ë©´ì—ì„œ í´ë¦­í•œ ê²½ìš° ì „ì²´ ë„ì„œëª©ë¡ìœ¼ë¡œ ìë™ ì „í™˜
    if(!document.getElementById('librarySection').classList.contains('hidden')==false){
      document.getElementById('librarySection').classList.remove('hidden');
      document.getElementById('loanSection').classList.add('hidden');
      document.getElementById('btnLibrary').classList.add('active');
      document.getElementById('btnLoans').classList.remove('active');
    }
    
    newestOn=!newestOn;btnNewest.classList.toggle('active',newestOn);
    
    if(newestOn){
      // ë°ì´í„° í–‰ë“¤ì„ ì—­ìˆœìœ¼ë¡œ ì •ë ¬ (í—¤ë”ëŠ” ê·¸ëŒ€ë¡œ)
      const reversedLibrary=[library[0],...library.slice(1).reverse()];
      renderTable(reversedLibrary,'libraryTable',true);
      
      // ì—°ì²´ ìƒ‰ìƒ ë‹¤ì‹œ ì ìš©
      const trs=document.querySelectorAll('#libraryTable tr');
      const statusIdx=findColIndex(library[0],['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
      for(let i=1;i<trs.length;i++){
        const td=trs[i].querySelectorAll('td')[statusIdx];
        if(td&&td.textContent.includes('ì—°ì²´'))trs[i].classList.add('overdue');
      }
      
      // ëŒ€ì¶œ ì¤‘ í•„í„°ê°€ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ë‹¤ì‹œ ì ìš©
      if(borrowedOn){
        for(let i=1;i<trs.length;i++){
          const td=trs[i].querySelectorSAll('td')[statusIdx];
          const isBorrowed=td&&/(ëŒ€ì¶œ|ëŒ€ì—¬|ì—°ì²´)/.test(td.textContent);
          trs[i].style.display=(!isBorrowed)?'none':'';
          trs[i].classList.toggle('borrowed',isBorrowed);
        }
      }
    }else{
      // ì›ë³¸ ìˆœì„œë¡œ ë³µì›
      renderTable(originalLibraryData,'libraryTable',true);
      
      // ì—°ì²´ ìƒ‰ìƒ ë‹¤ì‹œ ì ìš©
      const trs=document.querySelectorAll('#libraryTable tr');
      const statusIdx=findColIndex(library[0],['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
      for(let i=1;i<trs.length;i++){
        const td=trs[i].querySelectorAll('td')[statusIdx];
        if(td&&td.textContent.includes('ì—°ì²´'))trs[i].classList.add('overdue');
      }
      
      // ëŒ€ì¶œ ì¤‘ í•„í„°ê°€ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ë‹¤ì‹œ ì ìš©
      if(borrowedOn){
        for(let i=1;i<trs.length;i++){
          const td=trs[i].querySelectorAll('td')[statusIdx];
          const isBorrowed=td&&/(ëŒ€ì¶œ|ëŒ€ì—¬|ì—°ì²´)/.test(td.textContent);
          trs[i].style.display=(!isBorrowed)?'none':'';
          trs[i].classList.toggle('borrowed',isBorrowed);
        }
      }
    }
    
    // ê²€ìƒ‰ ê¸°ëŠ¥ ë‹¤ì‹œ ë°”ì¸ë”©
    addSearch('searchLibrary','libraryTable');
  };

  // âœ… ìµœê·¼ 30ì¼ ë„ì„œë§Œ ë³´ê¸° í•„í„° (ë“±ë¡ì¼ ì»¬ëŸ¼ í™•ì¸)
  const btnRecent=document.getElementById('btnRecent');
  let recentOn=false;
  
  // ë“±ë¡ì¼ ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸
  const dateIdx=findColIndex(library[0],['ë“±ë¡ì¼','ì¼ì','ë‚ ì§œ','ì…ê³ ì¼','êµ¬ì…ì¼']);
  
  if(dateIdx===-1){
    // ë“±ë¡ì¼ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
    btnRecent.style.opacity='0.5';
    btnRecent.style.cursor='not-allowed';
    btnRecent.title='ë“±ë¡ì¼ ì •ë³´ê°€ ì—†ì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
    btnRecent.onclick=()=>{
      alert('ğŸ“… ë“±ë¡ì¼ ì •ë³´ê°€ ì—†ì–´ì„œ ìµœê·¼ 30ì¼ í•„í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nCSV íŒŒì¼ì— "ë“±ë¡ì¼", "ì¼ì", "ë‚ ì§œ" ë“±ì˜ ì»¬ëŸ¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
    };
  }else{
    // ë“±ë¡ì¼ ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ ì •ìƒ ë™ì‘
    btnRecent.onclick=()=>{
      // ëŒ€ì¶œ í˜„í™© í™”ë©´ì—ì„œ í´ë¦­í•œ ê²½ìš° ì „ì²´ ë„ì„œëª©ë¡ìœ¼ë¡œ ìë™ ì „í™˜
      if(!document.getElementById('librarySection').classList.contains('hidden')==false){
        document.getElementById('librarySection').classList.remove('hidden');
        document.getElementById('loanSection').classList.add('hidden');
        document.getElementById('btnLibrary').classList.add('active');
        document.getElementById('btnLoans').classList.remove('active');
      }
      
      recentOn=!recentOn;btnRecent.classList.toggle('active',recentOn);
      
      const trs=document.querySelectorAll('#libraryTable tr');
      const now=new Date();
      const thirtyDaysAgo=new Date(now.getTime()-30*24*60*60*1000);
      
      for(let i=1;i<trs.length;i++){
        const tr=trs[i];
        
        if(recentOn){
          // ë“±ë¡ì¼ í™•ì¸
          const dateText=tr.querySelectorAll('td')[dateIdx]?.textContent||'';
          const bookDate=new Date(dateText);
          const isRecent=!isNaN(bookDate)&&bookDate>=thirtyDaysAgo;
          tr.style.display=isRecent?'':'none';
        }else{
          // í•„í„° í•´ì œ - ëª¨ë“  í–‰ í‘œì‹œ
          tr.style.display='';
        }
      }
      
      // ë‹¤ë¥¸ í•„í„°ì™€ì˜ í˜¸í™˜ì„±ì„ ìœ„í•´ ëŒ€ì¶œ ì¤‘ í•„í„°ê°€ í™œì„±í™”ëœ ê²½ìš° ì¬ì ìš©
      if(borrowedOn){
        const statusIdx=findColIndex(library[0],['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
        for(let i=1;i<trs.length;i++){
          if(trs[i].style.display!=='none'){ // 30ì¼ í•„í„°ë¥¼ í†µê³¼í•œ ê²½ìš°ì—ë§Œ
            const td=trs[i].querySelectorAll('td')[statusIdx];
            const isBorrowed=td&&/(ëŒ€ì¶œ|ëŒ€ì—¬|ì—°ì²´)/.test(td.textContent);
            if(!isBorrowed){
              trs[i].style.display='none';
            }
          }
        }
      }
    };
  }
});

document.getElementById('btnLoans').onclick=()=>{
  document.getElementById('loanSection').classList.remove('hidden');
  document.getElementById('librarySection').classList.add('hidden');
  document.getElementById('btnLoans').classList.add('active');
  document.getElementById('btnLibrary').classList.remove('active');
};
document.getElementById('btnLibrary').onclick=()=>{
  document.getElementById('librarySection').classList.remove('hidden');
  document.getElementById('loanSection').classList.add('hidden');
  document.getElementById('btnLibrary').classList.add('active');
  document.getElementById('btnLoans').classList.remove('active');
};
document.getElementById('btnAddBook').onclick=()=>{
  window.open('https://docs.google.com/forms/d/e/1FAIpQLSdOFZRt4o-bw6UNmBB6JtdDQ6PR5f7eW0dpfIs8KwyUysL5ag/viewform?usp=header');
};
</script>
</body>
</html>
