<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<style>
  body{font-family:'Pretendard','Noto Sans KR',sans-serif;background:#f8fafc;margin:0;padding:24px;color:#222}
  h1{text-align:center;color:#004080;margin-bottom:10px}
  nav{text-align:center;margin-bottom:16px}
  button{background:#004080;color:#fff;border:none;border-radius:8px;padding:8px 14px;margin:0 6px;cursor:pointer;font-size:14px}
  button.active{background:#2563eb}
  button.filter{background:#6b7280}
  button.filter.active{background:#16a34a}
  button.qr-btn{background:#0d9488;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:13px}
  input{display:block;margin:12px auto 16px;padding:8px 14px;font-size:14px;border:1px solid #cbd5e1;border-radius:6px;width:260px}
  .table-wrap{max-height:70vh;overflow:auto;border-radius:8px;background:#fff;box-shadow:0 0 5px rgba(0,0,0,.08)}
  table{width:100%;border-collapse:collapse;min-width:960px}
  th,td{border:1px solid #e2e8f0;padding:7px 10px;text-align:left;font-size:13.5px}
  th{background:#f1f5f9;color:#004080;position:sticky;top:0;z-index:10}
  tr:nth-child(even){background:#fafafa}
  tr:hover{background:#eef6ff}
  tr.borrowed td{background:#fff8e1}
  tr.overdue td{background:#ffe4e1}
  tr.recent td{background:#e6ffed}
  .hidden{display:none}
  #chartWrap{max-width:800px;margin:20px auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,.1)}
  footer{text-align:center;color:#667085;font-size:13px;margin-top:18px}
</style>
</head>
<body>

<h1>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
<nav>
  <button id="btnLoans" class="active">ğŸ“˜ ëŒ€ì¶œ í˜„í™©</button>
  <button id="btnLibrary">ğŸ“— ì „ì²´ ë„ì„œëª©ë¡</button>
  <button id="btnBorrowed" class="filter">ğŸ“• ëŒ€ì¶œ ì¤‘ ë„ì„œë§Œ ë³´ê¸°</button>
  <button id="btnRecent" class="filter">ğŸ†• ìµœê·¼ 30ì¼ ë„ì„œë§Œ ë³´ê¸°</button>
  <button id="sortBtn" style="background:#475569;">â¬‡ï¸ ìµœì‹ ìˆœ ë³´ê¸°</button>
  <button id="btnAddBook" style="background:#059669;">â• ë„ì„œ ì¶”ê°€</button>
</nav>

<div id="loanSection">
  <input type="text" id="searchLoans" placeholder="ë„ì„œëª…, ëŒ€ì—¬ì, ì½”ë“œë²ˆí˜¸ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="loanTable"></table></div>
</div>

<div id="librarySection" class="hidden">
  <input type="text" id="searchLibrary" placeholder="ì œëª©/ë„ì„œëª…, ì €ì, ì¶œíŒì‚¬ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="libraryTable"></table></div>
  <div id="chartWrap" class="hidden">
    <canvas id="chartBorrowTop" height="200"></canvas>
  </div>
</div>

<footer>Â© ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ | ì‹œìŠ¤í…œ ë¬¸ì˜(ê¹€ì„±ë½ ëŒ€ë¦¬ 417)</footer>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ====== 0) í™˜ê²½ ì„¤ì • ====== */
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdGuoHeUW-37RFCBgMH7ZUNL0tt_yHQiIFMrif85mrV428Omg/viewform";
const ENTRY_IDS = { code:"entry.32105598", title:"entry.1234176416", author:"entry.628826984", status:"entry.12641564", renter:"entry.615776096" };

/* ====== ìœ í‹¸ ====== */
const norm = s => String(s||'').replace(/\uFEFF/g,'').trim();
const normHead = s => norm(s).replace(/\s/g,'');
const includesAny = (h, keys) => keys.some(k => normHead(h).includes(k));
const findColIndex = (header, candidates) => header.findIndex(h => includesAny(h, candidates));
const isRecent = dateStr => { const d=new Date(dateStr); return (Date.now()-d.getTime())<30*24*60*60*1000; };

/* ====== CSV ë¡œë“œ ====== */
async function loadCSV(file){ const res=await fetch(file+'?v='+Date.now()); if(!res.ok)throw new Error(file+' ë¡œë“œ ì‹¤íŒ¨'); const text=await res.text(); return Papa.parse(text.trim(),{skipEmptyLines:true}).data; }

/* ====== í‘œ ë Œë”ë§ ====== */
function renderTable(rows, id, withQR=false, books=[]){
  const header = rows[0]; const table = document.getElementById(id);
  const finalHeader = withQR ? [...header, 'QR ìƒì„±'] : header;
  table.innerHTML = '<tr>'+finalHeader.map(h=>`<th>${h}</th>`).join('')+'</tr>';

  for(let i=1;i<rows.length;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = rows[i].map(c=>`<td>${c}</td>`).join('');

    const status = rows[i][findColIndex(header,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€'])] || '';
    const dateStr = rows[i][findColIndex(header,['ë“±ë¡ì¼','ë‚ ì§œ','ì¼ì'])] || '';

    // â‘  ìë™ ìƒ‰ ê°•ì¡°
    if(status.includes('ëŒ€ì¶œ')) tr.classList.add('borrowed');
    if(status.includes('ì—°ì²´')) tr.classList.add('overdue');
    if(isRecent(dateStr)) tr.classList.add('recent');

    // â‘¥ ë„ì„œ ì´ë ¥ íŒì—… ì—°ê²°
    tr.onclick = ()=>showHistoryPopup(rows[i][findColIndex(header,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸'])], books);

    if(withQR){
      const code = rows[i][findColIndex(header,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸'])] || '';
      const title = rows[i][findColIndex(header,['ì œëª©','ë„ì„œëª…'])] || '';
      const author = rows[i][findColIndex(header,['ì§€ì€ì´','ì €ì'])] || '';
      const status = rows[i][findColIndex(header,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€'])] || '';
      const renter = rows[i][findColIndex(header,['ëŒ€ì¶œì','ëŒ€ì—¬ì'])] || '';
      const tdQR = document.createElement('td');
      const btn = document.createElement('button');
      btn.className='qr-btn'; btn.textContent='ğŸ“· QR';
      btn.onclick = e=>{ e.stopPropagation(); generateQR({code,title,author,renter,status}); };
      tdQR.appendChild(btn); tr.appendChild(tdQR);
    }
    table.appendChild(tr);
  }
}

/* ====== ê²€ìƒ‰ ====== */
function addSearch(inputId, tableId){
  const input=document.getElementById(inputId); let timer;
  input.addEventListener('input', e=>{
    clearTimeout(timer);
    timer=setTimeout(()=>{
      const val=e.target.value.trim();
      const trs=document.querySelectorAll(`#${tableId} tr`);
      for(let i=1;i<trs.length;i++){
        const tr=trs[i]; tr.style.display=tr.textContent.includes(val)?'':'none';
      }
    },150);
  });
}

/* ====== QR ìƒì„± ====== */
function generateQR({code,title,author,renter,status}){
  const statusEncoded = status.includes('ë°˜ë‚©')?"%EB%B0%98%EB%82%A9":(status.includes('ëŒ€ì¶œ')?"%EB%8C%80%EC%B6%9C":"");
  const url=`${FORM_URL}?usp=pp_url&${ENTRY_IDS.code}=${encodeURIComponent(code)}&${ENTRY_IDS.title}=${encodeURIComponent(title)}&${ENTRY_IDS.author}=${encodeURIComponent(author)}&${ENTRY_IDS.renter}=${encodeURIComponent(renter)}&${ENTRY_IDS.status}=${statusEncoded}`;
  const layer=document.createElement('div');
  layer.style=`position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;`;
  layer.innerHTML=`<div style="background:#fff;padding:18px 22px;border-radius:10px;text-align:center;max-width:420px">
  <h3 style="margin:6px 0 12px">ğŸ“· QR ì½”ë“œ (${code})</h3>
  <div id="qrbox" style="margin:0 auto 10px;width:220px;height:220px"></div>
  <p style="word-break:break-all;font-size:12px;"><a href="${url}" target="_blank">${url}</a></p>
  <div style="margin-top:10px">
    <button id="qrClose" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:6px 10px;margin-right:6px">ë‹«ê¸°</button>
    <button id="qrDown" style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px">QR ë‹¤ìš´ë¡œë“œ</button>
  </div></div>`;
  document.body.appendChild(layer);
  new QRCode(layer.querySelector('#qrbox'),{text:url,width:220,height:220,colorDark:"#000",colorLight:"#fff"});
  layer.querySelector('#qrClose').onclick=()=>layer.remove();
  layer.querySelector('#qrDown').onclick=()=>{
    const img=layer.querySelector('#qrbox img'); const a=document.createElement('a');
    a.href=img.src; a.download=`${code}.png`; a.click();
  };
}

/* ====== â‘¥ ë„ì„œë³„ ì´ë ¥ íŒì—… ====== */
function showHistoryPopup(code, books){
  if(!code) return;
  const header=books[0]; const codeIdx=findColIndex(header,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
  const logs=books.filter(r=>r[codeIdx]===code);
  if(logs.length<2) return;
  const html=logs.map(r=>'<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>').join('');
  const layer=document.createElement('div');
  layer.style=`position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999`;
  layer.innerHTML=`<div style="background:#fff;padding:20px;border-radius:8px;max-height:80vh;overflow:auto">
  <h3>ğŸ“– ëŒ€ì¶œ ì´ë ¥ (${code})</h3>
  <table border="1" style="border-collapse:collapse;font-size:13px">${html}</table>
  <div style="text-align:center;margin-top:10px"><button style="background:#475569;color:#fff;border:none;border-radius:6px;padding:6px 10px" onclick="this.closest('div').parentElement.remove()">ë‹«ê¸°</button></div>
  </div>`;
  document.body.appendChild(layer);
}

/* ====== â‘¤ í†µê³„ ëŒ€ì‹œë³´ë“œ ====== */
function showChart(books){
  const titleIdx=findColIndex(books[0],['ë„ì„œëª…','ì œëª©']);
  const count={};
  for(let i=1;i<books.length;i++){const t=norm(books[i][titleIdx]);if(!t)continue;count[t]=(count[t]||0)+1;}
  const sorted=Object.entries(count).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const labels=sorted.map(x=>x[0]); const data=sorted.map(x=>x[1]);
  const ctx=document.getElementById('chartBorrowTop');
  new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'ëŒ€ì¶œ íšŸìˆ˜ TOP10',data:data,backgroundColor:'#2563eb'}]},options:{scales:{y:{beginAtZero:true}}}});
  document.getElementById('chartWrap').classList.remove('hidden');
}

/* ====== ë©”ì¸ ì‹¤í–‰ ====== */
let libraryData=[]; let reversed=true; let globalBooks=[];
Promise.all([loadCSV('books.csv'),loadCSV('library.csv')]).then(([books,library])=>{
  globalBooks=books; renderTable(books,'loanTable');
  const bh=books[0].map(norm);
  const bDateIdx=findColIndex(bh,['ë“±ë¡ì¼','ëŒ€ì¶œì¼','ì¼ì']);
  const bCodeIdx=findColIndex(bh,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
  const bStatusIdx=findColIndex(bh,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
  const bUserIdx=findColIndex(bh,['ëŒ€ì—¬ì','ëŒ€ì¶œì']);
  const latestByCode={};
  for(let i=1;i<books.length;i++){
    const date=norm(books[i][bDateIdx]);
    const code=norm(books[i][bCodeIdx]);
    const status=norm(books[i][bStatusIdx]);
    const borrower=norm(books[i][bUserIdx]);
    if(!code)continue;
    if(!latestByCode[code])latestByCode[code]={status:'',borrower:'',lastReturn:''};
    if(status.includes('ë°˜ë‚©'))latestByCode[code].lastReturn=date;
    latestByCode[code].status=status;latestByCode[code].borrower=borrower;
  }
  const lh=library[0].map(norm);
  const lCodeIdx=findColIndex(lh,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
  let lStatusIdx=findColIndex(lh,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
  let lUserIdx=findColIndex(lh,['ëŒ€ì—¬ì','ëŒ€ì¶œì']);
  let lRetIdx=findColIndex(lh,['ìµœê·¼ë°˜ë‚©ì¼','ë°˜ë‚©ì¼']);
  if(lStatusIdx===-1){library[0].push('ëŒ€ì¶œì—¬ë¶€');lStatusIdx=library[0].length-1;}
  if(lUserIdx===-1){library[0].push('ëŒ€ì¶œì');lUserIdx=library[0].length-1;}
  if(lRetIdx===-1){library[0].push('ìµœê·¼ë°˜ë‚©ì¼');lRetIdx=library[0].length-1;}
  for(let i=1;i<library.length;i++){
    const code=norm(library[i][lCodeIdx]); const rec=latestByCode[code];
    if(!rec){library[i][lStatusIdx]='';library[i][lUserIdx]='';library[i][lRetIdx]='';continue;}
    if(rec.status.includes('ë°˜ë‚©')){library[i][lStatusIdx]='ë°˜ë‚©';library[i][lUserIdx]='';library[i][lRetIdx]=rec.lastReturn||'';}
    else{library[i][lStatusIdx]=rec.status||'ëŒ€ì¶œ';library[i][lUserIdx]=rec.borrower||'';library[i][lRetIdx]=rec.lastReturn||'';}
  }
  libraryData=library;
  const header=library[0]; const reversedRows=[header,...library.slice(1).reverse()];
  renderTable(reversedRows,'libraryTable',true,books);
  showChart(books);
  addSearch('searchLoans','loanTable');
  addSearch('searchLibrary','libraryTable');

  // â‘¢ í•„í„° ë²„íŠ¼ë“¤
  const btnBorrow=document.getElementById('btnBorrowed');
  btnBorrow.onclick=()=>{
    btnBorrow.classList.toggle('active');
    const on=btnBorrow.classList.contains('active');
    const statusIdx=findColIndex(library[0],['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
    const trs=document.querySelectorAll('#libraryTable tr');
    for(let i=1;i<trs.length;i++){
      const td=trs[i].querySelectorAll('td')[statusIdx];
      const isBorrowed=td&&/(ëŒ€ì¶œ|ëŒ€ì—¬)/.test(td.textContent);
      trs[i].style.display=(on&&!isBorrowed)?'none':'';
    }
  };
  const btnRecent=document.getElementById('btnRecent');
btnRecent.onclick=()=>{
  btnRecent.classList.toggle('active');
  const on=btnRecent.classList.contains('active');
  const dateIdx=findColIndex(library[0],['ë“±ë¡ì¼','ì¼ì']);
  const trs=document.querySelectorAll('#libraryTable tr');
  for(let i=1;i<trs.length;i++){
    const td=trs[i].querySelectorAll('td')[dateIdx];
    const recent=td&&isRecent(td.textContent);
    trs[i].style.display=(on&&!recent)?'none':'';
  }

  // âœ… í†µê³„ ì°¨íŠ¸ëŠ” í•­ìƒ ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ë„ë¡ ê°•ì œ í‘œì‹œ
  document.getElementById('chartWrap').classList.remove('hidden');
};
});

/* ====== ìµœì‹ ìˆœ/ì˜¤ë˜ëœìˆœ í† ê¸€ ====== */
document.getElementById('sortBtn').onclick = () => {
  if (!libraryData.length) return;
  const header = libraryData[0];
  reversed = !reversed;
  const rows = reversed ? [header, ...libraryData.slice(1).reverse()] : libraryData;
  renderTable(rows, 'libraryTable', true, globalBooks);
  document.getElementById('sortBtn').textContent = reversed
    ? 'â¬†ï¸ ì˜¤ë˜ëœ ìˆœ ë³´ê¸°'
    : 'â¬‡ï¸ ìµœì‹ ìˆœ ë³´ê¸°';
};

/* ====== íƒ­ ì „í™˜ ====== */
document.getElementById('btnLoans').onclick = () => {
  document.getElementById('loanSection').classList.remove('hidden');
  document.getElementById('librarySection').classList.add('hidden');
  document.getElementById('btnLoans').classList.add('active');
  document.getElementById('btnLibrary').classList.remove('active');
};
document.getElementById('btnLibrary').onclick = () => {
  document.getElementById('librarySection').classList.remove('hidden');
  document.getElementById('loanSection').classList.add('hidden');
  document.getElementById('btnLibrary').classList.add('active');
  document.getElementById('btnLoans').classList.remove('active');
};
document.getElementById('btnAddBook').onclick = () => {
  window.open(
    'https://docs.google.com/forms/d/e/1FAIpQLSdOFZRt4o-bw6UNmBB6JtdDQ6PR5f7eW0dpfIs8KwyUysL5ag/viewform?usp=header'
  );
};
</script>
</body>
</html>
