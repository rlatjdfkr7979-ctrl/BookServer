<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📚 울산도시공사 도서관리 시스템</title>
<style>
  body{font-family:'Pretendard','Noto Sans KR',sans-serif;background:#f8fafc;margin:0;padding:24px;color:#222}
  h1{text-align:center;color:#004080;margin-bottom:10px}
  nav{text-align:center;margin-bottom:16px}
  button{background:#004080;color:#fff;border:none;border-radius:8px;padding:8px 14px;margin:0 6px;cursor:pointer;font-size:14px}
  button.active{background:#2563eb}
  button.filter{background:#6b7280}
  button.filter.active{background:#16a34a}
  button.qr-btn{background:#0d9488;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:13px}
  input{display:block;margin:12px auto 16px;padding:8px 14px;font-size:14px;border:1px solid #cbd5e1;border-radius:6px;width:260px}
  .table-wrap{max-height:70vh;overflow:auto;border-radius:8px;background:#fff;box-shadow:0 0 5px rgba(0,0,0,.08)}
  table{width:100%;border-collapse:collapse;min-width:960px}
  th,td{border:1px solid #e2e8f0;padding:7px 10px;text-align:left;font-size:13.5px}
  th{background:#f1f5f9;color:#004080;position:sticky;top:0;z-index:10}
  tr:nth-child(even){background:#fafafa}
  tr:hover{background:#eef6ff}
  tr.borrowed td{background:#fff8e1}
  tr.overdue td{background:#ffe4e1 !important;} /* ✅ 연체 표시 */
  .hidden{display:none}
  footer{text-align:center;color:#667085;font-size:13px;margin-top:18px}
  #historyModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;}
  #historyModal .inner{background:#fff;border-radius:10px;max-width:800px;width:95%;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);}
  #historyModal .content{padding:24px;overflow:auto;flex:1;}
  #historyModal .buttons{padding:16px 24px;border-top:1px solid #e2e8f0;background:#fff;border-radius:0 0 10px 10px;position:sticky;bottom:0;}
  #historyModal h3{margin:0 0 16px 0;font-size:18px;color:#004080;border-bottom:2px solid #e2e8f0;padding-bottom:8px;}
  #historyModal table{font-size:14px !important;min-width:auto !important;table-layout:fixed;width:100%;}
  #historyModal th{background:#f8fafc;padding:10px 12px;font-weight:600;word-wrap:break-word;}
  #historyModal td{padding:10px 12px;word-wrap:break-word;overflow-wrap:break-word;}
  #historyModal th:first-child, #historyModal td:first-child{width:30%;}
  #historyModal th:nth-child(2), #historyModal td:nth-child(2){width:25%;}
  #historyModal th:last-child, #historyModal td:last-child{width:45%;}
  
  /* 도서 미리보기 모달 스타일 */
  #bookPreviewModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;}
  #bookPreviewModal .inner{background:#fff;border-radius:12px;max-width:600px;width:95%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);}
  #bookPreviewModal .content{padding:24px;overflow:auto;flex:1;}
  #bookPreviewModal .buttons{padding:16px 24px;border-top:1px solid #e2e8f0;background:#fff;border-radius:0 0 12px 12px;position:sticky;bottom:0;}
  #bookPreviewModal .book-header{display:flex;gap:20px;margin-bottom:20px;}
  #bookPreviewModal .book-cover{flex-shrink:0;}
  #bookPreviewModal .book-cover img{width:120px;height:auto;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.1);border:1px solid #e2e8f0;}
  #bookPreviewModal .book-info{flex:1;min-width:0;}
  #bookPreviewModal .book-title{font-size:20px;font-weight:700;color:#1f2937;margin:0 0 8px 0;line-height:1.3;}
  #bookPreviewModal .book-author{color:#6b7280;font-size:16px;margin:0 0 6px 0;}
  #bookPreviewModal .book-publisher{color:#9ca3af;font-size:14px;margin:0 0 12px 0;}
  #bookPreviewModal .book-rating{display:flex;align-items:center;gap:8px;margin:8px 0;}
  #bookPreviewModal .stars{color:#fbbf24;}
  #bookPreviewModal .book-description{color:#4b5563;font-size:14px;line-height:1.6;margin-top:20px;}
  #bookPreviewModal .book-meta{background:#f8fafc;border-radius:8px;padding:16px;margin-top:16px;}
  #bookPreviewModal .book-meta .meta-item{display:flex;justify-content:space-between;margin:4px 0;font-size:13px;}
  #bookPreviewModal .book-meta .meta-label{color:#6b7280;font-weight:500;}
  #bookPreviewModal .book-meta .meta-value{color:#1f2937;}
  #bookPreviewModal .loading{text-align:center;padding:40px;color:#6b7280;}
  #bookPreviewModal .error{text-align:center;padding:40px;color:#dc2626;}
  #bookPreviewModal .tab-buttons{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid #e2e8f0;}
  #bookPreviewModal .tab-button{background:none;border:none;padding:8px 16px;cursor:pointer;color:#6b7280;font-size:14px;border-bottom:2px solid transparent;}
  #bookPreviewModal .tab-button.active{color:#2563eb;border-bottom-color:#2563eb;font-weight:600;}
  #bookPreviewModal .tab-content{display:none;}
  #bookPreviewModal .tab-content.active{display:block;}
  
  /* 페이지네이션 스타일 */
  .pagination{text-align:center;margin:16px 0;padding:12px;}
  .pagination button{background:#f8fafc;color:#374151;border:1px solid #d1d5db;border-radius:6px;padding:8px 12px;margin:0 2px;cursor:pointer;font-size:14px;min-width:40px;}
  .pagination button:hover{background:#e5e7eb;}
  .pagination button.active{background:#2563eb;color:#fff;border-color:#2563eb;}
  .pagination button:disabled{background:#f3f4f6;color:#9ca3af;cursor:not-allowed;}
  .pagination .page-info{display:inline-block;margin:0 12px;color:#6b7280;font-size:14px;}
</style>
</head>
<body>

<h1>📚 울산도시공사 도서관리 시스템</h1>
<nav>
  <button id="btnLoans" class="active">📘 대출 현황</button>
  <button id="btnLibrary">📗 전체 도서목록</button>
  <button id="btnBorrowed" class="filter">📕 대출 중 도서만 보기</button>
  <button id="btnNewest" class="filter" style="background:#7c3aed;">📈 최신 도서 순으로 보기</button>
  <button id="btnRecent" style="background:#15803d;">🆕 최근 30일 도서만 보기</button>
  <button id="btnAddBook" style="background:#059669;">➕ 도서 추가</button>
</nav>

<div id="loanSection">
  <input type="text" id="searchLoans" placeholder="도서명, 대여자, 코드번호 검색...">
  <div class="table-wrap"><table id="loanTable"></table></div>
  <div id="loanPagination" class="pagination"></div>
</div>

<div id="librarySection" class="hidden">
  <input type="text" id="searchLibrary" placeholder="제목/도서명, 저자, 출판사 검색...">
  <div class="table-wrap"><table id="libraryTable"></table></div>
  <div id="libraryPagination" class="pagination"></div>
</div>

<!-- 도서 이력 팝업 -->
<div id="historyModal">
  <div class="inner">
    <div class="content">
      <h3 id="histTitle">📖 도서 이력</h3>
      <div id="histContent"></div>
    </div>
    <div class="buttons">
      <button onclick="closeHistory()" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;">닫기</button>
    </div>
  </div>
</div>

<!-- 도서 미리보기 모달 -->
<div id="bookPreviewModal">
  <div class="inner">
    <div class="content">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('preview')">📚 도서 정보</button>
        <button class="tab-button" onclick="switchTab('history')">📋 대출 이력</button>
      </div>
      
      <div id="previewTab" class="tab-content active">
        <div id="bookPreviewContent">
          <div class="loading">📚 도서 정보를 불러오는 중...</div>
        </div>
      </div>
      
      <div id="historyTab" class="tab-content">
        <div id="bookHistoryContent"></div>
      </div>
    </div>
    <div class="buttons">
      <button onclick="closeBookPreview()" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;">닫기</button>
    </div>
  </div>
</div>

<footer>© 울산도시공사 도서관리 시스템 | 시스템 문의(김성락 대리 417)</footer>

<!-- 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
/* ====== 0) 환경 설정 ====== */
const FORM_URL="https://docs.google.com/forms/d/e/1FAIpQLSdGuoHeUW-37RFCBgMH7ZUNL0tt_yHQiIFMrif85mrV428Omg/viewform";
const ENTRY_IDS={code:"entry.32105598",title:"entry.1234176416",author:"entry.628826984",status:"entry.12641564",renter:"entry.615776096"};

/* ====== 유틸 ====== */
const norm=s=>String(s||'').replace(/\uFEFF/g,'').trim();
const normHead=s=>norm(s).replace(/\s/g,'');
const includesAny=(h,keys)=>keys.some(k=>normHead(h).includes(k));
function findColIndex(header,candidates){return header.findIndex(h=>includesAny(h,candidates));}

/* ====== 페이지네이션 ====== */
const ITEMS_PER_PAGE = 20; // 페이지당 항목 수
let currentPage = {loanTable: 1, libraryTable: 1};
let totalPages = {loanTable: 1, libraryTable: 1};
let allTableData = {loanTable: [], libraryTable: []};

function createPagination(tableId, paginationId, totalItems) {
  const pagination = document.getElementById(paginationId);
  const pages = Math.ceil(totalItems / ITEMS_PER_PAGE);
  totalPages[tableId] = pages;
  
  if (pages <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  const current = currentPage[tableId];
  let html = '';
  
  // 이전 버튼
  html += `<button onclick="changePage('${tableId}', '${paginationId}', ${current - 1})" ${current === 1 ? 'disabled' : ''}>‹ 이전</button>`;
  
  // 페이지 번호들
  let startPage = Math.max(1, current - 2);
  let endPage = Math.min(pages, current + 2);
  
  if (startPage > 1) {
    html += `<button onclick="changePage('${tableId}', '${paginationId}', 1)">1</button>`;
    if (startPage > 2) html += '<span>...</span>';
  }
  
  for (let i = startPage; i <= endPage; i++) {
    html += `<button onclick="changePage('${tableId}', '${paginationId}', ${i})" ${i === current ? 'class="active"' : ''}>${i}</button>`;
  }
  
  if (endPage < pages) {
    if (endPage < pages - 1) html += '<span>...</span>';
    html += `<button onclick="changePage('${tableId}', '${paginationId}', ${pages})">${pages}</button>`;
  }
  
  // 다음 버튼
  html += `<button onclick="changePage('${tableId}', '${paginationId}', ${current + 1})" ${current === pages ? 'disabled' : ''}>다음 ›</button>`;
  
  // 페이지 정보
  html += `<span class="page-info">${current} / ${pages} 페이지 (총 ${totalItems}개)</span>`;
  
  pagination.innerHTML = html;
}

function changePage(tableId, paginationId, page) {
  const pages = totalPages[tableId];
  if (page < 1 || page > pages) return;
  
  currentPage[tableId] = page;
  renderTableWithPagination(allTableData[tableId], tableId, tableId === 'libraryTable');
  createPagination(tableId, paginationId, allTableData[tableId].length - 1); // 헤더 제외
  
  // 테이블 스크롤을 맨 위로 이동
  const tableWrap = document.querySelector(`#${tableId === 'loanTable' ? 'loanSection' : 'librarySection'} .table-wrap`);
  if (tableWrap) tableWrap.scrollTop = 0;
}

/* ====== CSV 로드 ====== */
async function loadCSV(file){
  const res=await fetch(file+'?v='+Date.now());
  if(!res.ok) throw new Error(file+' 로드 실패');
  const text=await res.text();
  return Papa.parse(text.trim(),{skipEmptyLines:true}).data;
}

/* ====== QR 생성 ====== */
function generateQR({code,title,author,renter,status}){
  // 상태에 따른 라디오박스 선택 로직 개선
  let statusEncoded = "";
  if(status.includes('반납')){
    statusEncoded = "%EB%B0%98%EB%82%A9"; // 반납
  } else if(status.includes('대출') || status.includes('대여') || status.includes('연체')){
    statusEncoded = "%EB%8C%80%EC%B6%9C"; // 대출 (연체 포함)
  }
  
  const url=`${FORM_URL}?usp=pp_url&${ENTRY_IDS.code}=${encodeURIComponent(code)}&${ENTRY_IDS.title}=${encodeURIComponent(title)}&${ENTRY_IDS.author}=${encodeURIComponent(author)}&${ENTRY_IDS.renter}=${encodeURIComponent(renter)}&${ENTRY_IDS.status}=${statusEncoded}`;
  const layer=document.createElement('div');
  layer.style=`position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;`;
  layer.innerHTML=`<div style="background:#fff;padding:18px 22px;border-radius:10px;text-align:center;max-width:420px"><h3 style="margin:6px 0 12px">📷 QR 코드 (${code})</h3><div id="qrbox" style="margin:0 auto 10px;width:220px;height:220px"></div><p style="word-break:break-all;font-size:12px;"><a href="${url}" target="_blank">${url}</a></p><div style="margin-top:10px"><button id="qrClose" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:6px 10px;margin-right:6px">닫기</button><button id="qrDown"  style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px">QR 다운로드</button></div></div>`;
  document.body.appendChild(layer);
  new QRCode(layer.querySelector('#qrbox'),{text:url,width:220,height:220,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.H});
  layer.querySelector('#qrClose').onclick=()=>layer.remove();
  layer.querySelector('#qrDown').onclick=()=>{const img=layer.querySelector('#qrbox img');const a=document.createElement('a');a.href=img.src;a.download=`${code}.png`;a.click();};
}

/* ====== 표 렌더링 ====== */
function renderTable(rows,id,withQR=false){
  // 전체 데이터 저장
  allTableData[id] = [...rows];
  renderTableWithPagination(rows, id, withQR);
  
  // 페이지네이션 생성
  const paginationId = id === 'loanTable' ? 'loanPagination' : 'libraryPagination';
  createPagination(id, paginationId, rows.length - 1); // 헤더 제외
}

function renderTableWithPagination(rows,id,withQR=false){
  const header=rows[0];
  const table=document.getElementById(id);
  const finalHeader=withQR?[...header,'QR 생성']:header;
  
  // 현재 페이지의 데이터 계산
  const page = currentPage[id];
  const startIdx = (page - 1) * ITEMS_PER_PAGE + 1; // 헤더 제외하고 시작
  const endIdx = Math.min(startIdx + ITEMS_PER_PAGE - 1, rows.length - 1);
  
  // 헤더 생성 (정렬 기능 포함)
  const headerRow=document.createElement('tr');
  finalHeader.forEach((h,idx)=>{
    const th=document.createElement('th');
    th.textContent=h;
    
    // QR 생성 열이 아닌 경우에만 정렬 기능 추가
    if(idx<header.length){
      th.style.cursor='pointer';
      th.style.userSelect='none';
      th.onclick=()=>sortTable(rows,id,idx,withQR);
      
      // 정렬 표시를 위한 스타일
      th.addEventListener('mouseenter',()=>{
        if(!th.textContent.includes('↑')&&!th.textContent.includes('↓')){
          th.style.background='#e2e8f0';
        }
      });
      th.addEventListener('mouseleave',()=>{
        if(!th.textContent.includes('↑')&&!th.textContent.includes('↓')){
          th.style.background='#f1f5f9';
        }
      });
    }
    headerRow.appendChild(th);
  });
  
  table.innerHTML='';
  table.appendChild(headerRow);
  
  // 현재 페이지의 행들만 렌더링
  for(let i=startIdx;i<=endIdx;i++){
    if (i >= rows.length) break;
    
    const tr=document.createElement('tr');
    tr.innerHTML=rows[i].map((c,j)=>`<td>${c}</td>`).join('');
    
    // 제목 클릭 시 이력 보기
    if(withQR){
      const titleIdx=findColIndex(header,['제목','도서명']);
      const codeIdx=findColIndex(header,['코드','코드번호']);
      const statusIdx=findColIndex(header,['상태','대출여부']);
      
      // 상태에 따른 행 색상 적용
      const rowStatus = rows[i][statusIdx] || '';
      if(rowStatus.includes('연체')){
        tr.classList.add('overdue');
      } else if(rowStatus.includes('대출') || rowStatus.includes('대여')){
        tr.classList.add('borrowed');
      }
      
      const tdTitle=tr.children[titleIdx];
      if(tdTitle){
        tdTitle.style.color='#2563eb';
        tdTitle.style.cursor='pointer';
        tdTitle.style.fontWeight='500';
        tdTitle.title='클릭하면 도서 상세정보를 확인할 수 있습니다';
        const authorIdx = findColIndex(header,['지은이','저자']);
        const authorText = authorIdx !== -1 ? rows[i][authorIdx] : '';
        tdTitle.onclick=()=>showBookPreview(norm(rows[i][codeIdx]),norm(rows[i][titleIdx]),norm(authorText));
      }
      const tdQR=document.createElement('td');
      const code=rows[i][codeIdx];
      const author=rows[i][findColIndex(header,['지은이','저자'])];
      const renter=rows[i][findColIndex(header,['대출자','대여자'])];
      const status=rows[i][findColIndex(header,['상태','대출여부'])];
      const btn=document.createElement('button');
      btn.className='qr-btn';btn.textContent='📷 QR';
      btn.onclick=()=>generateQR({code,title:rows[i][titleIdx],author,renter,status});
      tdQR.appendChild(btn);tr.appendChild(tdQR);
    }
    table.appendChild(tr);
  }
}

/* ====== 테이블 정렬 ====== */
let sortState={}; // 각 테이블의 정렬 상태 저장
function sortTable(originalRows,tableId,colIdx,withQR=false){
  const header=originalRows[0];
  
  // 정렬 상태 확인 (기본: 오름차순)
  const sortKey=`${tableId}_${colIdx}`;
  const isAsc=!sortState[sortKey]; // 현재 상태의 반대로 설정
  sortState[sortKey]=isAsc;
  
  // 전체 데이터를 정렬 (헤더 제외)
  const dataRows = allTableData[tableId].slice(1);
  dataRows.sort((a,b)=>{
    const aVal=a[colIdx]||'';
    const bVal=b[colIdx]||'';
    
    // 숫자인지 확인
    const aNum=parseFloat(String(aVal).replace(/[^\d.-]/g,''));
    const bNum=parseFloat(String(bVal).replace(/[^\d.-]/g,''));
    
    let result;
    if(!isNaN(aNum)&&!isNaN(bNum)){
      result=aNum-bNum; // 숫자 정렬
    }else{
      result=String(aVal).localeCompare(String(bVal),'ko',{numeric:true}); // 문자열 정렬 (한국어 지원)
    }
    
    return isAsc?result:-result;
  });
  
  // 정렬된 데이터로 테이블 업데이트
  const sortedData = [header, ...dataRows];
  allTableData[tableId] = sortedData;
  
  // 첫 페이지로 이동하고 재렌더링
  currentPage[tableId] = 1;
  renderTableWithPagination(sortedData, tableId, withQR);
  
  // 페이지네이션 업데이트
  const paginationId = tableId === 'loanTable' ? 'loanPagination' : 'libraryPagination';
  createPagination(tableId, paginationId, sortedData.length - 1);
  
  // 헤더에 정렬 표시 추가
  const table = document.getElementById(tableId);
  table.querySelectorAll('th').forEach(th=>{
    th.textContent=th.textContent.replace(/\s*[↑↓]\s*/g,'');
    th.style.background='#f1f5f9';
  });
  
  const currentTh=table.querySelectorAll('th')[colIdx];
  currentTh.textContent+=isAsc?' ↑':' ↓';
  currentTh.style.background='#dbeafe';
  
  // 정렬 후 행 색상 다시 적용 (도서목록의 경우)
  if(withQR){
    const statusIdx=findColIndex(header,['상태','대출여부']);
    const allRows = table.querySelectorAll('tr');
    for(let rowIdx = 1; rowIdx < allRows.length; rowIdx++){
      const tr = allRows[rowIdx];
      const statusCell = tr.cells[statusIdx];
      if(statusCell){
        const statusText = statusCell.textContent || '';
        tr.classList.remove('borrowed', 'overdue');
        if(statusText.includes('연체')){
          tr.classList.add('overdue');
        } else if(statusText.includes('대출') || statusText.includes('대여')){
          tr.classList.add('borrowed');
        }
      }
    }
  }
}

/* ====== 검색 ====== */
function addSearch(inputId,tableId){
  const input=document.getElementById(inputId);
  let timer;
  input.addEventListener('input',e=>{
    clearTimeout(timer);
    timer=setTimeout(()=>{
      const val=e.target.value.trim();
      if (!val) {
        // 검색어가 없으면 원본 데이터로 복원
        currentPage[tableId] = 1;
        renderTable(allTableData[tableId], tableId, tableId === 'libraryTable');
        return;
      }
      
      // 검색 결과 필터링
      const originalData = allTableData[tableId];
      const filteredData = [originalData[0]]; // 헤더 보존
      
      for(let i = 1; i < originalData.length; i++) {
        const rowText = originalData[i].join(' ');
        if (rowText.includes(val)) {
          filteredData.push(originalData[i]);
        }
      }
      
      // 검색 결과로 테이블 재렌더링
      currentPage[tableId] = 1;
      renderTable(filteredData, tableId, tableId === 'libraryTable');
    },150);
  });
}

/* ====== 연체 판별 ====== */
function isOverdue(dateStr,status){
  if(!dateStr||status.includes('반납'))return false;
  const d=new Date(dateStr);
  if(isNaN(d))return false;
  const diff=(Date.now()-d.getTime())/(1000*60*60*24);
  return diff>14;
}

/* ====== 도서 미리보기 (구글 Books API) ====== */
async function showBookPreview(code, title, author = '') {
  const modal = document.getElementById('bookPreviewModal');
  const previewContent = document.getElementById('bookPreviewContent');
  const historyContent = document.getElementById('bookHistoryContent');
  
  // 모달 표시
  modal.style.display = 'flex';
  
  // 탭 초기화 (도서 정보 탭을 기본으로)
  switchTab('preview');
  
  // 로딩 상태
  previewContent.innerHTML = '<div class="loading">📚 도서 정보를 불러오는 중...</div>';
  
  try {
    // 구글 Books API 호출
    const searchQuery = encodeURIComponent(`${title} ${author}`.trim());
    const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=${searchQuery}&maxResults=5&langRestrict=ko`;
    
    const response = await fetch(apiUrl);
    const data = await response.json();
    
    if (data.items && data.items.length > 0) {
      // 가장 적합한 책 찾기 (제목 유사도 기준)
      const bestMatch = findBestBookMatch(data.items, title);
      renderBookInfo(bestMatch, previewContent);
    } else {
      // API에서 결과가 없을 때 기본 정보 표시
      renderBasicBookInfo(title, author, code, previewContent);
    }
    
    // 이력 정보도 함께 준비
    renderBookHistory(code, title, historyContent);
    
  } catch (error) {
    console.error('도서 정보 로드 실패:', error);
    renderBasicBookInfo(title, author, code, previewContent);
    renderBookHistory(code, title, historyContent);
  }
  
  // 팝업 외부 클릭 시 닫기 기능
  modal.onclick = (e) => {
    if (e.target === modal) {
      closeBookPreview();
    }
  };
  
  // 팝업 내부 클릭 시 이벤트 버블링 방지
  modal.querySelector('.inner').onclick = (e) => {
    e.stopPropagation();
  };
}

function findBestBookMatch(items, targetTitle) {
  // 제목 유사도로 가장 적합한 책 찾기
  let bestMatch = items[0];
  let bestScore = 0;
  
  for (const item of items) {
    const bookTitle = item.volumeInfo.title || '';
    const score = calculateSimilarity(targetTitle.toLowerCase(), bookTitle.toLowerCase());
    if (score > bestScore) {
      bestScore = score;
      bestMatch = item;
    }
  }
  
  return bestMatch;
}

function calculateSimilarity(str1, str2) {
  // 간단한 유사도 계산 (공통 단어 개수 기준)
  const words1 = str1.split(/\s+/);
  const words2 = str2.split(/\s+/);
  let commonWords = 0;
  
  for (const word of words1) {
    if (word.length > 1 && words2.some(w => w.includes(word) || word.includes(w))) {
      commonWords++;
    }
  }
  
  return commonWords / Math.max(words1.length, words2.length);
}

function renderBookInfo(bookData, container) {
  const info = bookData.volumeInfo;
  const saleInfo = bookData.saleInfo || {};
  
  const title = info.title || '제목 없음';
  const authors = info.authors ? info.authors.join(', ') : '저자 미상';
  const publisher = info.publisher || '출판사 미상';
  const publishedDate = info.publishedDate || '출간일 미상';
  const description = info.description || '설명이 없습니다.';
  const thumbnail = info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '';
  const pageCount = info.pageCount || '-';
  const categories = info.categories ? info.categories.join(', ') : '-';
  const language = info.language === 'ko' ? '한국어' : info.language || '-';
  const rating = info.averageRating || 0;
  const ratingsCount = info.ratingsCount || 0;
  
  container.innerHTML = `
    <div class="book-header">
      <div class="book-cover">
        ${thumbnail ? `<img src="${thumbnail.replace('http:', 'https:')}" alt="책 표지" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDEyMCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTYwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik00MCA2MEg4MFY2NEg0MFY2MFoiIGZpbGw9IiM5Q0EzQUYiLz4KPHA+'}alt="책 표지"'>` : '<div style="width:120px;height:160px;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:12px;">표지 없음</div>'}
      </div>
      <div class="book-info">
        <h2 class="book-title">${title}</h2>
        <p class="book-author">👤 ${authors}</p>
        <p class="book-publisher">🏢 ${publisher}</p>
        ${rating > 0 ? `
          <div class="book-rating">
            <span class="stars">${'★'.repeat(Math.floor(rating))}${'☆'.repeat(5-Math.floor(rating))}</span>
            <span style="color:#6b7280;font-size:13px;">${rating}/5.0 (${ratingsCount}명)</span>
          </div>
        ` : ''}
      </div>
    </div>
    
    <div class="book-meta">
      <div class="meta-item">
        <span class="meta-label">📅 출간일</span>
        <span class="meta-value">${publishedDate}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">📄 페이지</span>
        <span class="meta-value">${pageCount}페이지</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">🏷️ 분야</span>
        <span class="meta-value">${categories}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">🌐 언어</span>
        <span class="meta-value">${language}</span>
      </div>
    </div>
    
    <div class="book-description">
      <strong>📝 도서 소개</strong><br><br>
      ${description.length > 500 ? description.substring(0, 500) + '...' : description}
    </div>
  `;
}

function renderBasicBookInfo(title, author, code, container) {
  container.innerHTML = `
    <div class="book-header">
      <div class="book-cover">
        <div style="width:120px;height:160px;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:12px;">표지 없음</div>
      </div>
      <div class="book-info">
        <h2 class="book-title">${title}</h2>
        ${author ? `<p class="book-author">👤 ${author}</p>` : ''}
        <p style="color:#6b7280;font-size:14px;">📚 코드: ${code}</p>
      </div>
    </div>
    
    <div class="book-description" style="text-align:center;color:#6b7280;padding:40px;">
      상세한 도서 정보를 찾을 수 없습니다.<br>
      도서관 내부 정보만 표시됩니다.
    </div>
  `;
}

function renderBookHistory(code, title, container) {
  const recs = window.booksData.filter(r => norm(r[1]) === code);
  
  if (recs.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280;">대출 이력이 없습니다.</div>';
  } else {
    container.innerHTML = `
      <h4 style="margin:0 0 16px 0;color:#1f2937;">📋 대출 이력 (총 ${recs.length}건)</h4>
      <table style="width:100%;border-collapse:collapse;">
        <tr style="background:#f8fafc;">
          <th style="padding:12px;border:1px solid #e2e8f0;text-align:left;font-weight:600;">등록일</th>
          <th style="padding:12px;border:1px solid #e2e8f0;text-align:left;font-weight:600;">대여자</th>
          <th style="padding:12px;border:1px solid #e2e8f0;text-align:left;font-weight:600;">상태</th>
        </tr>
        ${recs.map(r => `
          <tr>
            <td style="padding:10px 12px;border:1px solid #e2e8f0;">${r[0]}</td>
            <td style="padding:10px 12px;border:1px solid #e2e8f0;">${r[4]}</td>
            <td style="padding:10px 12px;border:1px solid #e2e8f0;">
              <span style="padding:2px 8px;border-radius:12px;font-size:12px;font-weight:500;
                ${r[5].includes('대출') || r[5].includes('연체') ? 'background:#fef3c7;color:#92400e;' : 'background:#d1fae5;color:#047857;'}">
                ${r[5]}
              </span>
            </td>
          </tr>
        `).join('')}
      </table>
    `;
  }
}

function switchTab(tabName) {
  // 탭 버튼 상태 변경
  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  // 선택된 탭 활성화
  if (tabName === 'preview') {
    document.querySelector('.tab-button').classList.add('active');
    document.getElementById('previewTab').classList.add('active');
  } else {
    document.querySelectorAll('.tab-button')[1].classList.add('active');
    document.getElementById('historyTab').classList.add('active');
  }
}

function closeBookPreview() {
  const modal = document.getElementById('bookPreviewModal');
  modal.style.display = 'none';
  modal.onclick = null;
}

/* ====== 기존 도서 이력 팝업 (호환성 유지) ====== */
function showHistory(code,title){
  const modal=document.getElementById('historyModal');
  const histTitle=document.getElementById('histTitle');
  const histContent=document.getElementById('histContent');
  histTitle.textContent=`📖 ${title} (${code})`;
  const recs=window.booksData.filter(r=>norm(r[1])===code);
  if(recs.length===0){histContent.innerHTML='<p>이력 없음</p>';}
  else{
    histContent.innerHTML='<table style="width:100%;border-collapse:collapse;font-size:13px"><tr><th>등록일</th><th>대여자</th><th>상태</th></tr>'+recs.map(r=>`<tr><td>${r[0]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`).join('')+'</table>';
  }
  modal.style.display='flex';
  
  // 팝업 외부 클릭 시 닫기 기능
  modal.onclick=(e)=>{
    if(e.target===modal){
      closeHistory();
    }
  };
  
  // 팝업 내부 클릭 시 이벤트 버블링 방지
  modal.querySelector('.inner').onclick=(e)=>{
    e.stopPropagation();
  };
}
function closeHistory(){
  const modal=document.getElementById('historyModal');
  modal.style.display='none';
  modal.onclick=null; // 이벤트 리스너 제거
}

/* ====== 메인 실행 ====== */
Promise.all([loadCSV('books.csv'),loadCSV('library.csv')]).then(([books,library])=>{
  window.booksData=books; // 이력 팝업용 저장
  renderTable(books,'loanTable');

  const bh=books[0].map(norm);
  const bDateIdx=findColIndex(bh,['등록일','대출일','일자']);
  const bCodeIdx=findColIndex(bh,['코드','코드번호']);
  const bStatusIdx=findColIndex(bh,['상태','대출여부']);
  const bUserIdx=findColIndex(bh,['대여자','대출자']);
  const latestByCode={};

  for(let i=1;i<books.length;i++){
    const date=norm(books[i][bDateIdx]);
    const code=norm(books[i][bCodeIdx]);
    const status=norm(books[i][bStatusIdx]);
    const borrower=norm(books[i][bUserIdx]);
    if(!code)continue;
    if(!latestByCode[code])latestByCode[code]={status:'',borrower:'',lastReturn:''};
    if(status.includes('반납'))latestByCode[code].lastReturn=date;
    latestByCode[code].status=status;
    latestByCode[code].borrower=borrower;
  }

  const lh=library[0].map(norm);
  const lCodeIdx=findColIndex(lh,['코드','코드번호']);
  let lStatusIdx=findColIndex(lh,['상태','대출여부']);
  let lUserIdx=findColIndex(lh,['대여자','대출자']);
  if(lStatusIdx===-1){library[0].push('대출여부');lStatusIdx=library[0].length-1;}
  if(lUserIdx===-1){library[0].push('대출자');lUserIdx=library[0].length-1;}

  for(let i=1;i<library.length;i++){
    const code=norm(library[i][lCodeIdx]);
    const rec=latestByCode[code];
    if(!rec){library[i][lStatusIdx]='';library[i][lUserIdx]='';continue;}
    if(rec.status.includes('반납')){
      library[i][lStatusIdx]='반납';
      library[i][lUserIdx]='';
    }else{
      library[i][lStatusIdx]=rec.status||'대출';
      library[i][lUserIdx]=rec.borrower||'';
      // ✅ 연체 계산 추가
      const loanRow=books.find(b=>norm(b[bCodeIdx])===code);
      const loanDate=loanRow?loanRow[bDateIdx]:'';
      if(isOverdue(loanDate,rec.status))library[i][lStatusIdx]='연체';
    }
  }

  renderTable(library,'libraryTable',true);
  addSearch('searchLoans','loanTable');
  addSearch('searchLibrary','libraryTable');

  // ✅ 대출 중 필터
  const btnBorrowed=document.getElementById('btnBorrowed');
  let borrowedOn=false;
  btnBorrowed.onclick=()=>{
    // 대출 현황 화면에서 클릭한 경우 전체 도서목록으로 자동 전환
    if(!document.getElementById('librarySection').classList.contains('hidden')==false){
      document.getElementById('librarySection').classList.remove('hidden');
      document.getElementById('loanSection').classList.add('hidden');
      document.getElementById('btnLibrary').classList.add('active');
      document.getElementById('btnLoans').classList.remove('active');
    }
    
    borrowedOn=!borrowedOn;btnBorrowed.classList.toggle('active',borrowedOn);
    
    // 모든 필터 재적용
    applyAllFilters();
    
    // 페이지와 테이블 스크롤을 맨 위로 이동
    window.scrollTo(0,0);
    document.querySelector('#librarySection .table-wrap').scrollTop=0;
  };

  // ✅ 최신 도서 순 필터 (library.csv 데이터 역순 출력)
  const btnNewest=document.getElementById('btnNewest');
  let newestOn=false;
  let originalLibraryData=[...library]; // 원본 데이터 보존
  btnNewest.onclick=()=>{
    // 대출 현황 화면에서 클릭한 경우 전체 도서목록으로 자동 전환
    if(!document.getElementById('librarySection').classList.contains('hidden')==false){
      document.getElementById('librarySection').classList.remove('hidden');
      document.getElementById('loanSection').classList.add('hidden');
      document.getElementById('btnLibrary').classList.add('active');
      document.getElementById('btnLoans').classList.remove('active');
    }
    
    newestOn=!newestOn;btnNewest.classList.toggle('active',newestOn);
    
    // 버튼 텍스트 변경
    if(newestOn){
      btnNewest.innerHTML='📉 오래된 순으로 보기';
    }else{
      btnNewest.innerHTML='📈 최신 도서 순으로 보기';
    }
    
    // 현재 표시된 행들을 수집 (필터링된 상태 고려)
    const currentRows=[];
    const trs=document.querySelectorAll('#libraryTable tr');
    
    // 헤더 추가
    currentRows.push(library[0]);
    
    // 현재 보이는 데이터 행들만 수집
    for(let i=1;i<trs.length;i++){
      if(trs[i].style.display!=='none'){
        const rowData=[];
        for(let j=0;j<trs[i].cells.length-1;j++){ // QR 컬럼 제외
          rowData.push(trs[i].cells[j].textContent);
        }
        currentRows.push(rowData);
      }
    }
    
    if(newestOn){
      // 현재 필터된 데이터를 역순으로 정렬 (헤더는 그대로)
      const reversedRows=[currentRows[0],...currentRows.slice(1).reverse()];
      renderTable(reversedRows,'libraryTable',true);
    }else{
      // 원본 순서로 복원
      renderTable(originalLibraryData,'libraryTable',true);
    }
    
    // 모든 필터 재적용
    applyAllFilters();
    
    // 검색 기능 다시 바인딩
    addSearch('searchLibrary','libraryTable');
    
    // 페이지와 테이블 스크롤을 맨 위로 이동
    window.scrollTo(0,0);
    document.querySelector('#librarySection .table-wrap').scrollTop=0;
  };
  
  // 모든 필터를 재적용하는 함수
  function applyAllFilters(){
    let dataToFilter = [...originalLibraryData];
    
    // 최신 순 정렬 적용
    if(newestOn){
      dataToFilter = [dataToFilter[0], ...dataToFilter.slice(1).reverse()];
    }
    
    // 필터링 적용
    const statusIdx = findColIndex(library[0],['상태','대출여부']);
    const filteredData = [dataToFilter[0]]; // 헤더 보존
    
    for(let i = 1; i < dataToFilter.length; i++){
      const row = dataToFilter[i];
      let shouldShow = true;
      
      // 대출 중 필터 적용
      if(borrowedOn){
        const status = row[statusIdx] || '';
        const isBorrowed = /(대출|대여|연체)/.test(status);
        if(!isBorrowed) shouldShow = false;
      }
      
      // 30일 필터 적용
      if(recentOn && dateIdx !== -1){
        const dateText = row[dateIdx] || '';
        const bookDate = new Date(dateText);
        const now = new Date();
        const thirtyDaysAgo = new Date(now.getTime() - 30*24*60*60*1000);
        const isRecent = !isNaN(bookDate) && bookDate >= thirtyDaysAgo;
        if(!isRecent) shouldShow = false;
      }
      
      if(shouldShow) filteredData.push(row);
    }
    
    // 필터된 데이터로 테이블 재렌더링
    currentPage['libraryTable'] = 1;
    renderTable(filteredData, 'libraryTable', true);
    
    // 검색 기능 다시 바인딩
    addSearch('searchLibrary','libraryTable');
  }

  // ✅ 최근 30일 도서만 보기 필터 (등록일 컬럼 확인)
  const btnRecent=document.getElementById('btnRecent');
  let recentOn=false;
  
  // 등록일 컬럼이 있는지 확인
  const dateIdx=findColIndex(library[0],['등록일','일자','날짜','입고일','구입일']);
  
  if(dateIdx===-1){
    // 등록일 컬럼이 없으면 버튼 비활성화
    btnRecent.style.opacity='0.5';
    btnRecent.style.cursor='not-allowed';
    btnRecent.title='등록일 정보가 없어서 사용할 수 없습니다';
    btnRecent.onclick=()=>{
      alert('📅 등록일 정보가 없어서 최근 30일 필터를 사용할 수 없습니다.\n\nCSV 파일에 "등록일", "일자", "날짜" 등의 컬럼을 추가해주세요.');
    };
  }else{
    // 등록일 컬럼이 있으면 정상 동작
    btnRecent.onclick=()=>{
      // 대출 현황 화면에서 클릭한 경우 전체 도서목록으로 자동 전환
      if(!document.getElementById('librarySection').classList.contains('hidden')==false){
        document.getElementById('librarySection').classList.remove('hidden');
        document.getElementById('loanSection').classList.add('hidden');
        document.getElementById('btnLibrary').classList.add('active');
        document.getElementById('btnLoans').classList.remove('active');
      }
      
      recentOn=!recentOn;btnRecent.classList.toggle('active',recentOn);
      
      // 모든 필터 재적용
      applyAllFilters();
      
      // 페이지와 테이블 스크롤을 맨 위로 이동
      window.scrollTo(0,0);
      document.querySelector('#librarySection .table-wrap').scrollTop=0;
    };
  }
});

document.getElementById('btnLoans').onclick=()=>{
  document.getElementById('loanSection').classList.remove('hidden');
  document.getElementById('librarySection').classList.add('hidden');
  document.getElementById('btnLoans').classList.add('active');
  document.getElementById('btnLibrary').classList.remove('active');
  // 페이지와 테이블 스크롤을 맨 위로 이동
  window.scrollTo(0,0);
  document.querySelector('#loanSection .table-wrap').scrollTop=0;
};
document.getElementById('btnLibrary').onclick=()=>{
  document.getElementById('librarySection').classList.remove('hidden');
  document.getElementById('loanSection').classList.add('hidden');
  document.getElementById('btnLibrary').classList.add('active');
  document.getElementById('btnLoans').classList.remove('active');
  // 페이지와 테이블 스크롤을 맨 위로 이동
  window.scrollTo(0,0);
  document.querySelector('#librarySection .table-wrap').scrollTop=0;
};
document.getElementById('btnAddBook').onclick=()=>{
  window.open('https://docs.google.com/forms/d/e/1FAIpQLSdOFZRt4o-bw6UNmBB6JtdDQ6PR5f7eW0dpfIs8KwyUysL5ag/viewform?usp=header');
};
</script>
</body>
</html>
