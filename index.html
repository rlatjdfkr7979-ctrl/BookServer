<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<style>
  body{font-family:'Pretendard','Noto Sans KR',sans-serif;background:#f8fafc;margin:0;padding:24px;color:#222}
  h1{text-align:center;color:#004080;margin-bottom:10px}
  nav{text-align:center;margin-bottom:16px}
  button{background:#004080;color:#fff;border:none;border-radius:8px;padding:8px 14px;margin:0 6px;cursor:pointer;font-size:14px}
  button.active{background:#2563eb}
  button.filter{background:#6b7280}
  button.filter.active{background:#16a34a}
  button.qr-btn{background:#0d9488;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:13px}
  input{display:block;margin:12px auto 16px;padding:8px 14px;font-size:14px;border:1px solid #cbd5e1;border-radius:6px;width:260px}
  .table-wrap{max-height:70vh;overflow:auto;border-radius:8px;background:#fff;box-shadow:0 0 5px rgba(0,0,0,.08)}
  table{width:100%;border-collapse:collapse;min-width:960px}
  th,td{border:1px solid #e2e8f0;padding:7px 10px;text-align:left;font-size:13.5px}
  th{background:#f1f5f9;color:#004080;position:sticky;top:0;z-index:10}
  tr:nth-child(even){background:#fafafa}
  tr:hover{background:#eef6ff}
  tr.borrowed td{background:#fff8e1} /* ëŒ€ì¶œ ì¤‘ - ë…¸ë€ìƒ‰ */
  tr.overdue td{background:#fee2e2 !important;} /* ì—°ì²´ - ë¹¨ê°„ìƒ‰ */
  .hidden{display:none}
  footer{text-align:center;color:#667085;font-size:13px;margin-top:18px}
  #historyModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;}
  #historyModal .inner{background:#fff;border-radius:10px;max-width:800px;width:95%;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);}
  #historyModal .content{padding:24px;overflow:auto;flex:1;}
  #historyModal .buttons{padding:16px 24px;border-top:1px solid #e2e8f0;background:#fff;border-radius:0 0 10px 10px;position:sticky;bottom:0;}
  #historyModal h3{margin:0 0 16px 0;font-size:18px;color:#004080;border-bottom:2px solid #e2e8f0;padding-bottom:8px;}
  #historyModal table{font-size:14px !important;min-width:auto !important;table-layout:fixed;width:100%;}
  #historyModal th{background:#f8fafc;padding:10px 12px;font-weight:600;word-wrap:break-word;}
  #historyModal td{padding:10px 12px;word-wrap:break-word;overflow-wrap:break-word;}
  #historyModal th:first-child, #historyModal td:first-child{width:30%;}
  #historyModal th:nth-child(2), #historyModal td:nth-child(2){width:25%;}
  #historyModal th:last-child, #historyModal td:last-child{width:45%;}
  
  /* ë„ì„œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  #bookPreviewModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;}
  #bookPreviewModal .inner{background:#fff;border-radius:12px;max-width:600px;width:95%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);}
  #bookPreviewModal .content{padding:24px;overflow:auto;flex:1;}
  #bookPreviewModal .buttons{padding:16px 24px;border-top:1px solid #e2e8f0;background:#fff;border-radius:0 0 12px 12px;position:sticky;bottom:0;}
  #bookPreviewModal .book-header{display:flex;gap:20px;margin-bottom:20px;}
  #bookPreviewModal .book-cover{flex-shrink:0;}
  #bookPreviewModal .book-cover img{width:120px;height:auto;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.1);border:1px solid #e2e8f0;}
  #bookPreviewModal .book-info{flex:1;min-width:0;}
  #bookPreviewModal .book-title{font-size:20px;font-weight:700;color:#1f2937;margin:0 0 8px 0;line-height:1.3;}
  #bookPreviewModal .book-author{color:#6b7280;font-size:16px;margin:0 0 6px 0;}
  #bookPreviewModal .book-publisher{color:#9ca3af;font-size:14px;margin:0 0 12px 0;}
  #bookPreviewModal .book-rating{display:flex;align-items:center;gap:8px;margin:8px 0;}
  #bookPreviewModal .stars{color:#fbbf24;}
  #bookPreviewModal .book-description{color:#4b5563;font-size:14px;line-height:1.6;margin-top:20px;}
  #bookPreviewModal .book-meta{background:#f8fafc;border-radius:8px;padding:16px;margin-top:16px;}
  #bookPreviewModal .book-meta .meta-item{display:flex;justify-content:space-between;margin:4px 0;font-size:13px;}
  #bookPreviewModal .book-meta .meta-label{color:#6b7280;font-weight:500;}
  #bookPreviewModal .book-meta .meta-value{color:#1f2937;}
  #bookPreviewModal .loading{text-align:center;padding:40px;color:#6b7280;}
  #bookPreviewModal .error{text-align:center;padding:40px;color:#dc2626;}
  #bookPreviewModal .tab-buttons{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid #e2e8f0;}
  #bookPreviewModal .tab-button{background:none;border:none;padding:8px 16px;cursor:pointer;color:#6b7280;font-size:14px;border-bottom:2px solid transparent;}
  #bookPreviewModal .tab-button.active{color:#2563eb;border-bottom-color:#2563eb;font-weight:600;}
  #bookPreviewModal .tab-content{display:none;}
  #bookPreviewModal .tab-content.active{display:block;}
  
  /* Dooray ì—°ë™ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  #doorayModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1001;}
  #doorayModal .inner{background:#fff;border-radius:12px;max-width:600px;width:95%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);}
  #doorayModal .content{padding:24px;overflow:auto;flex:1;}
  #doorayModal .buttons{padding:16px 24px;border-top:1px solid #e2e8f0;background:#fff;border-radius:0 0 12px 12px;}
  #doorayModal h3{margin:0 0 16px 0;color:#1f2937;font-size:20px;}
  #doorayModal .status-card{background:#f8fafc;border-radius:8px;padding:16px;margin:12px 0;border-left:4px solid #6366f1;}
  #doorayModal .status-success{border-left-color:#10b981;background:#ecfdf5;}
  #doorayModal .status-error{border-left-color:#ef4444;background:#fef2f2;}
  #doorayModal .status-warning{border-left-color:#f59e0b;background:#fffbeb;}
  #doorayModal .feature-list{list-style:none;padding:0;margin:16px 0;}
  #doorayModal .feature-list li{padding:8px 0;display:flex;align-items:center;gap:8px;}
  #doorayModal .feature-list li::before{content:'âœ…';margin-right:8px;}
  #doorayModal .test-result{margin:16px 0;padding:12px;border-radius:6px;font-family:monospace;font-size:13px;}
  #doorayModal .action-button{background:#6366f1;color:#fff;border:none;border-radius:6px;padding:8px 16px;margin:4px;cursor:pointer;}
  #doorayModal .action-button:hover{background:#4f46e5;}
  #doorayModal .action-button:disabled{background:#9ca3af;cursor:not-allowed;}
  
  /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
  .pagination{text-align:center;margin:16px 0;padding:12px;}
  .pagination button{background:#f8fafc;color:#374151;border:1px solid #d1d5db;border-radius:6px;padding:8px 12px;margin:0 2px;cursor:pointer;font-size:14px;min-width:40px;}
  .pagination button:hover{background:#e5e7eb;}
  .pagination button.active{background:#2563eb;color:#fff;border-color:#2563eb;}
  .pagination button:disabled{background:#f3f4f6;color:#9ca3af;cursor:not-allowed;}
  .pagination .page-info{display:inline-block;margin:0 12px;color:#6b7280;font-size:14px;}
</style>
</head>
<body>

<h1>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
<nav>
  <button id="btnLibrary" class="active">ğŸ“— ì „ì²´ ë„ì„œëª©ë¡</button>
  <button id="btnBorrowed" class="filter">ğŸ“• ëŒ€ì¶œ ì¤‘ ë„ì„œë§Œ ë³´ê¸°</button>
  <button id="btnNewest" class="filter" style="background:#7c3aed;">ğŸ“ˆ ìµœì‹  ë„ì„œ ìˆœìœ¼ë¡œ ë³´ê¸°</button>
  <button id="btnRecent" style="background:#15803d;">ğŸ†• ìµœê·¼ 30ì¼ ë„ì„œë§Œ ë³´ê¸°</button>
  <button id="btnLoans">ğŸ“˜ ëŒ€ì¶œ í˜„í™©</button>
  <button id="btnAddBook" style="background:#059669;">â• ë„ì„œ ì¶”ê°€</button>
  <button id="btnDooraySync" style="background:#7c3aed;">ğŸ”„ Dooray ì—°ë™</button>
</nav>

<div id="librarySection">
  <input type="text" id="searchLibrary" placeholder="ì œëª©/ë„ì„œëª…, ì €ì, ì¶œíŒì‚¬ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="libraryTable"></table></div>
  <div id="libraryPagination" class="pagination"></div>
</div>

<div id="loanSection" class="hidden">
  <input type="text" id="searchLoans" placeholder="ë„ì„œëª…, ëŒ€ì—¬ì, ì½”ë“œë²ˆí˜¸ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="loanTable"></table></div>
  <div id="loanPagination" class="pagination"></div>
</div>

<!-- ë„ì„œ ì´ë ¥ íŒì—… -->
<div id="historyModal">
  <div class="inner">
    <div class="content">
      <h3 id="histTitle">ğŸ“– ë„ì„œ ì´ë ¥</h3>
      <div id="histContent"></div>
    </div>
    <div class="buttons">
      <button onclick="closeHistory()" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ë„ì„œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div id="bookPreviewModal">
  <div class="inner">
    <div class="content">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('preview')">ğŸ“š ë„ì„œ ì •ë³´</button>
        <button class="tab-button" onclick="switchTab('history')">ğŸ“‹ ëŒ€ì¶œ ì´ë ¥</button>
      </div>
      
      <div id="previewTab" class="tab-content active">
        <div id="bookPreviewContent">
          <div class="loading">ğŸ“š ë„ì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
      
      <div id="historyTab" class="tab-content">
        <div id="bookHistoryContent"></div>
      </div>
    </div>
    <div class="buttons">
      <button onclick="closeBookPreview()" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Dooray ì—°ë™ ëª¨ë‹¬ -->
<div id="doorayModal">
  <div class="inner">
    <div class="content">
      <h3>ğŸ”„ Dooray ì—°ë™ ê´€ë¦¬</h3>
      
      <div id="doorayStatus" class="status-card">
        <strong>ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...</strong>
      </div>
      
      <div id="doorayFeatures" style="display:none;">
        <h4>ğŸ¯ ì‚¬ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥</h4>
        <ul class="feature-list">
          <li>ğŸ“Š ë„ì„œ í˜„í™©ì„ Dooray Wikiì— ìë™ ì—…ë°ì´íŠ¸</li>
          <li>ğŸ’¬ ë„ì„œ ëŒ€ì¶œ/ë°˜ë‚© ì‹œ ë©”ì‹ ì € ì•Œë¦¼ ì „ì†¡</li>
          <li>âš ï¸ ì—°ì²´ ë„ì„œ ìë™ ì•Œë¦¼</li>
          <li>ğŸ“ˆ ì‹¤ì‹œê°„ í†µê³„ ì •ë³´ ë™ê¸°í™”</li>
        </ul>
        
        <h4>ğŸ› ï¸ ì—°ë™ ì‘ì—…</h4>
        <div style="margin:12px 0;">
          <button class="action-button" onclick="testDoorayConnection()">ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸</button>
          <button class="action-button" onclick="syncLibraryToWiki()">ğŸ“Š Wiki ì—…ë°ì´íŠ¸</button>
          <button class="action-button" onclick="sendTestNotification()">ğŸ’¬ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div id="doorayTestResult" class="test-result" style="display:none;"></div>
      </div>
      
      <div id="dooraySetup" style="display:none;">
        <h4>âš™ï¸ Google Apps Script ë°±ì—”ë“œ ì„¤ì •</h4>
        <div style="margin:16px 0;">
          <label style="display:block;margin:8px 0;color:#374151;font-weight:500;">ğŸŒ ë°±ì—”ë“œ URL:</label>
          <input type="url" id="gasBackendUrl" placeholder="https://script.google.com/macros/s/.../exec" 
                 style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
          
          <label style="display:block;margin:8px 0;color:#374151;font-weight:500;">ğŸ“ Wiki ID:</label>
          <input type="text" id="doorayWikiId" placeholder="Dooray Wiki ID (ì˜ˆ: 3971855165716167130)" 
                 style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
          
          <label style="display:block;margin:8px 0;color:#374151;font-weight:500;">ğŸ“„ Page ID:</label>
          <input type="text" id="doorayPageId" placeholder="Wiki Page ID (ì˜ˆ: 4185119590638689477)" 
                 style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
          
          <div style="margin:16px 0;padding:12px;background:#e0f2fe;border-radius:6px;font-size:13px;color:#0277bd;border-left:4px solid #0288d1;">
            ï¿½ <strong>Google Apps Script ë°±ì—”ë“œ ì„¤ì •:</strong><br>
            1. library-gas-backend.jsë¥¼ Google Apps Scriptì— ë³µì‚¬<br>
            2. ì‹¤ì œ Dooray API í† í°ìœ¼ë¡œ êµì²´<br>
            3. ì›¹ì•±ìœ¼ë¡œ ë°°í¬ í›„ URL ë³µì‚¬<br>
            4. ìœ„ ë°±ì—”ë“œ URL í•„ë“œì— ì…ë ¥
          </div>
          
          <div style="margin:16px 0;padding:12px;background:#f3f4f6;border-radius:6px;font-size:13px;color:#6b7280;">
            ğŸ’¡ <strong>ì •ë³´ í™•ì¸ ë°©ë²•:</strong><br>
            â€¢ Wiki ID: ë‘ë ˆì´.jsì˜ WIKI_ID ê°’ (3971855165716167130)<br>
            â€¢ Page ID: ë‘ë ˆì´.jsì˜ PAGE_ID ê°’ (4185119590638689477)<br>
            â€¢ ë˜ëŠ” Wiki URL: https://dooray.com/.../wikis/<strong>WIKI_ID</strong>/pages/<strong>PAGE_ID</strong>
          </div>
          
          <button onclick="saveDoorayConfig()" class="action-button" style="width:100%;margin-top:12px;">
            ğŸ’¾ ì„¤ì • ì €ì¥ ë° ì—°ê²° í…ŒìŠ¤íŠ¸
          </button>
          <button onclick="testDooraySetup()" style="background:#6b7280;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;margin-top:8px;cursor:pointer;">
            ğŸ§ª ì„¤ì • ìƒíƒœ í…ŒìŠ¤íŠ¸
          </button>
          <button onclick="clearDoorayConfig()" style="background:#dc2626;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;margin-top:8px;cursor:pointer;">
            ğŸ—‘ï¸ ì„¤ì • ì´ˆê¸°í™”
          </button>
        </div>
      </div>
    </div>
    <div class="buttons">
      <button onclick="closeDoorayModal()" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<footer>Â© ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ | ì‹œìŠ¤í…œ ë¬¸ì˜(ê¹€ì„±ë½ ëŒ€ë¦¬ 417)</footer>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<!-- Dooray ì—°ë™ ì„¤ì • -->
<script>
// ğŸ”§ ëŸ°íƒ€ì„ ì„¤ì • - Google Apps Script ë°±ì—”ë“œ ë°©ì‹
window.DOORAY_CONFIG = {
  wikiId: localStorage.getItem('dooray_wiki_id') || '',
  pageId: localStorage.getItem('dooray_page_id') || '',
  backendUrl: localStorage.getItem('gas_backend_url') || '',
  settings: {
    enableMessaging: true,
    enableWikiUpdate: true,
    debug: false
  }
};

// API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
window.DOORAY_ENDPOINTS = {
  wiki: {
    get: (projectId, postId) => `${window.DOORAY_CONFIG.baseUrl}/v1/projects/${projectId}/posts/${postId}`,
    update: (projectId, postId) => `${window.DOORAY_CONFIG.baseUrl}/v1/projects/${projectId}/posts/${postId}`
  },
  messenger: {
    send: (channelId) => `${window.DOORAY_CONFIG.baseUrl}/v1/channels/${channelId}/logs`
  }
};

// ğŸš€ Dooray API ì—°ë™ ëª¨ë“ˆ (í†µí•© ë²„ì „)
class DoorayIntegration {
  constructor() {
    this.config = window.DOORAY_CONFIG || null;
    this.isEnabled = this.config && this.config.wikiId && this.config.pageId && localStorage.getItem('gas_backend_url');
    
    if (!this.isEnabled) {
      console.warn('ğŸ”§ Dooray ì—°ë™ì´ ë¹„í™œì„±í™”ë¨: Google Apps Script ë°±ì—”ë“œ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”');
    }
  }

  // ğŸ“¡ Google Apps Script ë°±ì—”ë“œë¥¼ í†µí•œ API ìš”ì²­ (JSONP ë°©ì‹ìœ¼ë¡œ CORS ìš°íšŒ)
  makeApiRequest(action, additionalParams = {}) {
    if (!this.isEnabled) {
      console.warn('âš ï¸ Dooray APIê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
      return Promise.resolve(null);
    }

    // Google Apps Script ì›¹ì•± URL (ì‚¬ìš©ìê°€ ì„¤ì •í•´ì•¼ í•¨)
    const GAS_BACKEND_URL = localStorage.getItem('gas_backend_url') || '';
    
    if (!GAS_BACKEND_URL) {
      return Promise.reject(new Error('Google Apps Script ë°±ì—”ë“œ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'));
    }

    // contentê°€ ìˆê³  ê¸¸ì´ê°€ ê¸´ ê²½ìš° POST ìš”ì²­ ì‹œë„
    const content = additionalParams.content;
    const isLongContent = content && content.length > 1000; // 1KB ì´ìƒì˜ ì½˜í…ì¸ 
    
    if (isLongContent) {
      console.log('ğŸ“„ ê¸´ ì½˜í…ì¸  ê°ì§€, POST ìš”ì²­ ì‹œë„:', content.length, 'ê¸€ì');
      return this.makePostRequest(GAS_BACKEND_URL, action, additionalParams);
    }

    return new Promise((resolve, reject) => {
      // JSONP ì½œë°± í•¨ìˆ˜ëª… ìƒì„±
      const callbackName = 'jsonp_callback_' + Date.now();
      
      // ê¸€ë¡œë²Œ ì½œë°± í•¨ìˆ˜ ë“±ë¡
      window[callbackName] = function(data) {
        console.log('âœ… JSONP ì½œë°± ì„±ê³µ:', {
          callbackName: callbackName,
          data: data
        });
        
        // ì½œë°± ì •ë¦¬
        delete window[callbackName];
        if (document.head.contains(script)) {
          document.head.removeChild(script);
        }
        
        if (data && data.error) {
          reject(new Error(data.error));
        } else {
          resolve(data);
        }
      };
      
      // ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ë¡œ JSONP ìš”ì²­
      const script = document.createElement('script');
      
      // URL íŒŒë¼ë¯¸í„° ì•ˆì „í•˜ê²Œ ì¸ì½”ë”©
      const params = new URLSearchParams();
      params.append('action', action);
      params.append('wikiId', this.config.wikiId || '');
      params.append('pageId', this.config.pageId || '');
      params.append('callback', callbackName);
      
      // ì¶”ê°€ íŒŒë¼ë¯¸í„°ë“¤ì„ ì•ˆì „í•˜ê²Œ ì¸ì½”ë”©
      Object.keys(additionalParams).forEach(key => {
        if (additionalParams[key] !== undefined && additionalParams[key] !== null) {
          const value = String(additionalParams[key]);
          
          // contentëŠ” ê¸¸ì´ì— ë”°ë¼ ì²˜ë¦¬
          if (key === 'content') {
            if (value.length > 1000) {
              // ë„ˆë¬´ ê¸´ ì½˜í…ì¸ ëŠ” ìš”ì•½ ë²„ì „ ì‚¬ìš©
              const summary = this.createSimpleSummary(value, libraryData, unreturned);
              console.log('ğŸ“„ ê¸´ ì½˜í…ì¸  ê°ì§€, ìš”ì•½ ë²„ì „ ì‚¬ìš©:', {
                original: value.length,
                summary: summary.length
              });
              params.append(key, summary);
            } else {
              // ì ë‹¹í•œ ê¸¸ì´ëŠ” ê·¸ëŒ€ë¡œ ì „ì†¡
              params.append(key, value);
            }
          } else {
            // ë‹¤ë¥¸ íŒŒë¼ë¯¸í„°ë“¤ì€ ê¸°ì¡´ ë°©ì‹
            const truncatedValue = value.length > 500 ? value.substring(0, 500) + '...[truncated]' : value;
            params.append(key, truncatedValue);
          }
        }
      });
      
      const fullUrl = `${GAS_BACKEND_URL}?${params}`;
      
      // URL ê¸¸ì´ ì²´í¬
      if (fullUrl.length > 2000) {
        console.warn('âš ï¸ URLì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤. POST ìš”ì²­ìœ¼ë¡œ ì „í™˜:', fullUrl.length);
        resolve(this.makePostRequest(GAS_BACKEND_URL, action, additionalParams));
        return;
      }
      
      script.src = fullUrl;
      
      // ë¡œë”© ìƒíƒœ ë¡œê·¸
      console.log('ğŸ”„ JSONP ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì‹œë„:', {
        url: script.src.length > 200 ? script.src.substring(0, 200) + '...[truncated]' : script.src,
        callbackName: callbackName,
        action: action,
        urlLength: script.src.length
      });
      
      script.onload = function() {
        console.log('âœ… JSONP ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ:', script.src);
      };
      
      script.onerror = function(error) {
        delete window[callbackName];
        if (document.head.contains(script)) {
          document.head.removeChild(script);
        }
        console.error('ğŸš¨ JSONP ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', {
          url: script.src,
          error: error,
          GAS_BACKEND_URL: GAS_BACKEND_URL,
          action: action,
          troubleshooting: {
            'URL í™•ì¸': 'Google Apps Script ë°°í¬ URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸',
            'ê¶Œí•œ í™•ì¸': 'GASê°€ ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©ìœ¼ë¡œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸',
            'ë„¤íŠ¸ì›Œí¬': 'ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ í™•ì¸'
          }
        });
        reject(new Error(`Google Apps Script ìš”ì²­ ì‹¤íŒ¨: ${script.src}`));
      };
      
      // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
      setTimeout(() => {
        if (window[callbackName]) {
          console.error('âŒ JSONP ìš”ì²­ íƒ€ì„ì•„ì›ƒ:', {
            url: script.src,
            callbackName: callbackName,
            timeout: '30ì´ˆ ê²½ê³¼'
          });
          delete window[callbackName];
          if (document.head.contains(script)) {
            document.head.removeChild(script);
          }
          reject(new Error('Google Apps Script ìš”ì²­ íƒ€ì„ì•„ì›ƒ (30ì´ˆ)'));
        }
      }, 30000);
      
      document.head.appendChild(script);
      
      // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
      setTimeout(() => {
        if (window[callbackName]) {
          delete window[callbackName];
          document.head.removeChild(script);
          reject(new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼'));
        }
      }, 30000);
    });
  }

  // ğŸ“¤ POST ìš”ì²­ìœ¼ë¡œ ê¸´ ì½˜í…ì¸  ì²˜ë¦¬ (JSONP ëŒ€ì‹  fetch ì‚¬ìš© - CORS ë¬¸ì œ ìˆì„ ìˆ˜ ìˆìŒ)
  async makePostRequest(gasUrl, action, additionalParams) {
    try {
      console.log('ğŸ“¤ POST ìš”ì²­ ì‹œë„:', {
        action: action,
        contentLength: additionalParams.content ? additionalParams.content.length : 0
      });

      // POST ìš”ì²­ ë°ì´í„° ì¤€ë¹„ (Base64 ì¸ì½”ë”© í¬í•¨)
      const requestData = {
        action: action,
        wikiId: this.config.wikiId || '',
        pageId: this.config.pageId || '',
        callback: 'jsonp_callback_' + Date.now(), // JSONP ì½œë°±ë„ ì§€ì›
      };

      // íŒŒë¼ë¯¸í„° ì¶”ê°€ (Base64 ì—†ì´ ì§ì ‘ ì „ì†¡)
      Object.keys(additionalParams).forEach(key => {
        requestData[key] = additionalParams[key];
      });

      const response = await fetch(gasUrl, {
        method: 'POST',
        mode: 'cors', // CORS í—ˆìš© ì‹œë„
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('âœ… POST ìš”ì²­ ì„±ê³µ:', result);
      return result;

    } catch (fetchError) {
      console.warn('âš ï¸ POST ìš”ì²­ ì‹¤íŒ¨, GETìœ¼ë¡œ í´ë°±:', fetchError.message);
      
      // POST ì‹¤íŒ¨ ì‹œ ì½˜í…ì¸ ë¥¼ ì¤„ì—¬ì„œ GET ìš”ì²­ìœ¼ë¡œ ì¬ì‹œë„
      const shortContent = additionalParams.content ? 
        this.shortenContent(additionalParams.content) : 
        additionalParams.content;
      
      const fallbackParams = {
        ...additionalParams,
        content: shortContent
      };

      // ê¸°ì¡´ GET ë°©ì‹ìœ¼ë¡œ ì¬ì‹œë„
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Date.now();
        
        window[callbackName] = function(data) {
          delete window[callbackName];
          if (document.head.contains(script)) {
            document.head.removeChild(script);
          }
          resolve(data);
        };
        
        const script = document.createElement('script');
        const params = new URLSearchParams({
          action: action,
          wikiId: this.config.wikiId || '',
          pageId: this.config.pageId || '',
          callback: callbackName,
          ...fallbackParams
        });
        
        script.src = `${gasUrl}?${params}`;
        script.onerror = () => {
          delete window[callbackName];
          if (document.head.contains(script)) {
            document.head.removeChild(script);
          }
          reject(new Error('GET í´ë°±ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
        };
        
        document.head.appendChild(script);
      });
    }
  }

  // ğŸ“„ ì½˜í…ì¸  ë‹¨ì¶• í•¨ìˆ˜
  shortenContent(content) {
    if (!content || content.length <= 500) {
      return content;
    }

    // ë§ˆí¬ë‹¤ìš´ í˜•íƒœì˜ ìš”ì•½ ìƒì„±
    const lines = content.split('\n');
    const title = lines.find(line => line.startsWith('# ')) || '# ğŸ“š ë„ì„œê´€ë¦¬ í˜„í™©';
    
    // í†µê³„ ì •ë³´ ì¶”ì¶œ
    const statsRegex = /- \*\*ì „ì²´ ë„ì„œ\*\*: (\d+)ê¶Œ/;
    const unreturnedRegex = /- \*\*ë¯¸ë°˜ë‚© ë„ì„œ\*\*: (\d+)ê¶Œ/;
    const returnRateRegex = /- \*\*ë°˜ë‚©ë¥ \*\*: ([\d.]+)%/;
    
    const totalMatch = content.match(statsRegex);
    const unreturnedMatch = content.match(unreturnedRegex);
    const returnRateMatch = content.match(returnRateRegex);
    
    const currentDate = new Date().toLocaleString('ko-KR');
    
    return `${title}

## ğŸ“Š ìš”ì•½ (${currentDate})
- ì „ì²´ ë„ì„œ: ${totalMatch ? totalMatch[1] : '?'}ê¶Œ
- ë¯¸ë°˜ë‚© ë„ì„œ: ${unreturnedMatch ? unreturnedMatch[1] : '?'}ê¶Œ  
- ë°˜ë‚©ë¥ : ${returnRateMatch ? returnRateMatch[1] : '?'}%

${unreturnedMatch && parseInt(unreturnedMatch[1]) === 0 ? 
  'ğŸ‰ ëª¨ë“  ë„ì„œê°€ ë°˜ë‚©ë˜ì—ˆìŠµë‹ˆë‹¤!' : 
  `âš ï¸ ${unreturnedMatch ? unreturnedMatch[1] : '?'}ê¶Œì˜ ë„ì„œê°€ ë¯¸ë°˜ë‚© ìƒíƒœì…ë‹ˆë‹¤.`}

---
*ìë™ ìƒì„±ëœ ìš”ì•½ (ì›ë³¸ ì½˜í…ì¸ : ${content.length}ì)*`;
  }

  // ğŸ“ ê°„ë‹¨í•œ ìš”ì•½ ìƒì„± í•¨ìˆ˜
  createSimpleSummary(fullContent, libraryData, unreturned) {
    const currentDate = new Date().toLocaleString('ko-KR');
    
    return `# ë„ì„œê´€ë¦¬ í˜„í™©

**ì—…ë°ì´íŠ¸:** ${currentDate}

## í†µê³„
- ì „ì²´ ë„ì„œ: ${libraryData.length - 1}ê¶Œ
- ë¯¸ë°˜ë‚© ë„ì„œ: ${unreturned.length}ê¶Œ
- ë°˜ë‚©ë¥ : ${((libraryData.length - 1 - unreturned.length) / (libraryData.length - 1) * 100).toFixed(1)}%

## ìƒíƒœ
${unreturned.length === 0 ? 
  'âœ… ëª¨ë“  ë„ì„œê°€ ë°˜ë‚©ë˜ì—ˆìŠµë‹ˆë‹¤!' : 
  `âš ï¸ ${unreturned.length}ê¶Œì˜ ë„ì„œê°€ ë¯¸ë°˜ë‚© ìƒíƒœì…ë‹ˆë‹¤.`}

${unreturned.length > 0 ? `

### ë¯¸ë°˜ë‚© ë„ì„œ (ì²˜ìŒ 5ê¶Œ)
${unreturned.slice(0, 5).map((book, index) => 
  `${index + 1}. ${book.title || 'ì œëª©ì—†ìŒ'} - ${book.borrower || 'ì •ë³´ì—†ìŒ'}`
).join('\n')}

${unreturned.length > 5 ? `... ì™¸ ${unreturned.length - 5}ê¶Œ ë”` : ''}
` : ''}

---
*ìë™ ìƒì„± ë³´ê³ ì„œ*`;
  }

  // ğŸ“Š Wiki ì—…ë°ì´íŠ¸ - ë„ì„œ í˜„í™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ Wikiì— ë°˜ì˜
  async updateLibraryStatusToWiki(libraryData) {
    if (!this.isEnabled || !this.config.settings.enableWikiUpdate) {
      return false;
    }

    try {
      const { projectId, postId } = this.config;
      const getUrl = window.DOORAY_ENDPOINTS.wiki.get(projectId, postId);
      
      // 1. ê¸°ì¡´ Wiki ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
      const existingData = await this.makeApiRequest(getUrl);
      if (!existingData) return false;

      // 2. ë„ì„œ í˜„í™© í‘œ ìƒì„±
      const libraryTable = this.generateLibraryTable(libraryData);
      
      // 3. Wiki ë‚´ìš© ì—…ë°ì´íŠ¸
      const updatedContent = this.updateWikiContent(
        existingData.result.body.content, 
        libraryTable
      );

      // 4. Wiki ì €ì¥
      const updateUrl = window.DOORAY_ENDPOINTS.wiki.update(projectId, postId);
      const updateData = {
        body: {
          content: updatedContent,
          mimeType: 'text/x-markdown'
        }
      };

      const result = await this.makeApiRequest(updateUrl, 'PUT', updateData);
      
      if (result) {
        console.log('âœ… Dooray Wiki ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        return true;
      }
    } catch (error) {
      console.error('ğŸš¨ Wiki ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    }
    
    return false;
  }

  // ğŸ“‹ ë„ì„œ í˜„í™© í…Œì´ë¸” ìƒì„± (ë§ˆí¬ë‹¤ìš´ í˜•ì‹)
  generateLibraryTable(libraryData) {
    if (!libraryData || libraryData.length === 0) {
      return 'ë„ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
    }

    // í†µê³„ ê³„ì‚°
    const totalBooks = libraryData.length - 1; // í—¤ë” ì œì™¸
    const borrowedBooks = libraryData.slice(1).filter(row => {
      const status = row[row.length - 2] || ''; // ìƒíƒœ ì»¬ëŸ¼
      return status.includes('ëŒ€ì¶œ') || status.includes('ì—°ì²´');
    }).length;
    const availableBooks = totalBooks - borrowedBooks;

    const now = new Date();
    const koreanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
    const updateTime = koreanTime.toLocaleString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });

    // ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ìƒì„±
    let markdown = `## ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ í˜„í™©\n\n`;
    markdown += `**ğŸ“Š í†µê³„ ì •ë³´**\n`;
    markdown += `- ğŸ“— ì´ ë„ì„œ: ${totalBooks}ê¶Œ\n`;
    markdown += `- ğŸ“• ëŒ€ì¶œì¤‘: ${borrowedBooks}ê¶Œ\n`;
    markdown += `- ğŸ“˜ ëŒ€ì¶œê°€ëŠ¥: ${availableBooks}ê¶Œ\n`;
    markdown += `- ğŸ• ì—…ë°ì´íŠ¸: ${updateTime}\n\n`;

    // ëŒ€ì¶œ ì¤‘ì¸ ë„ì„œë§Œ í‘œì‹œ
    if (borrowedBooks > 0) {
      markdown += `**ğŸ“• í˜„ì¬ ëŒ€ì¶œ ì¤‘ì¸ ë„ì„œ**\n\n`;
      markdown += `| ë„ì„œëª… | ì €ì | ëŒ€ì¶œì | ìƒíƒœ |\n`;
      markdown += `|--------|------|--------|------|\n`;

      for (let i = 1; i < libraryData.length; i++) {
        const row = libraryData[i];
        const status = row[row.length - 2] || '';
        
        if (status.includes('ëŒ€ì¶œ') || status.includes('ì—°ì²´')) {
          const title = row[2] || 'ì œëª©ì—†ìŒ'; // ë„ì„œëª…
          const author = row[3] || 'ì €ìë¯¸ìƒ'; // ì €ì
          const borrower = row[row.length - 1] || 'ëŒ€ì¶œìë¯¸ìƒ'; // ëŒ€ì¶œì
          
          markdown += `| ${title} | ${author} | ${borrower} | ${status} |\n`;
        }
      }
    } else {
      markdown += `**âœ… í˜„ì¬ ëª¨ë“  ë„ì„œê°€ ë°˜ë‚©ëœ ìƒíƒœì…ë‹ˆë‹¤.**\n`;
    }

    return markdown;
  }

  // ğŸ“ Wiki ë‚´ìš©ì—ì„œ ë„ì„œ í˜„í™© ë¶€ë¶„ ì—…ë°ì´íŠ¸
  updateWikiContent(existingContent, newTable) {
    const startMarker = '<!-- LIBRARY_STATUS_START -->';
    const endMarker = '<!-- LIBRARY_STATUS_END -->';
    
    const hasMarkers = existingContent.includes(startMarker) && existingContent.includes(endMarker);
    
    if (hasMarkers) {
      // ê¸°ì¡´ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë¶€ë¶„ë§Œ êµì²´
      const beforeStart = existingContent.split(startMarker)[0];
      const afterEnd = existingContent.split(endMarker)[1];
      
      return `${beforeStart}${startMarker}\n${newTable}\n${endMarker}${afterEnd}`;
    } else {
      // ë§ˆì»¤ê°€ ì—†ìœ¼ë©´ ë‚´ìš© ëì— ì¶”ê°€
      return `${existingContent}\n\n${startMarker}\n${newTable}\n${endMarker}`;
    }
  }

  // ğŸ’¬ ë©”ì‹ ì € ì•Œë¦¼ ì „ì†¡
  async sendNotification(message, channelId = null) {
    if (!this.isEnabled || !this.config.settings.enableMessaging) {
      console.log('ğŸ“¢ ì•Œë¦¼ (Dooray ë¹„í™œì„±í™”):', message);
      return false;
    }

    // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” channelIdë¥¼ ì„¤ì •ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì•¼ í•¨
    if (!channelId) {
      console.warn('âš ï¸ ë©”ì‹ ì € ì±„ë„ IDê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
      return false;
    }

    try {
      const url = window.DOORAY_ENDPOINTS.messenger.send(channelId);
      const data = {
        text: message,
        botName: 'ğŸ“š ë„ì„œê´€ë¦¬ë´‡'
      };

      const result = await this.makeApiRequest(url, 'POST', data);
      
      if (result) {
        console.log('âœ… Dooray ë©”ì‹ ì € ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ');
        return true;
      }
    } catch (error) {
      console.error('ğŸš¨ ë©”ì‹ ì € ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error);
    }
    
    return false;
  }

  // ğŸ”” ë„ì„œ ëŒ€ì¶œ/ë°˜ë‚© ì•Œë¦¼
  async notifyBookAction(action, bookInfo) {
    const { title, author, borrower, code } = bookInfo;
    let message = '';

    switch (action) {
      case 'borrow':
        message = `ğŸ“• **ë„ì„œ ëŒ€ì¶œ ì•Œë¦¼**\n` +
                 `â€¢ ë„ì„œ: ${title}\n` +
                 `â€¢ ì €ì: ${author}\n` +
                 `â€¢ ëŒ€ì¶œì: ${borrower}\n` +
                 `â€¢ ì½”ë“œ: ${code}\n` +
                 `â€¢ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}`;
        break;
        
      case 'return':
        message = `ğŸ“— **ë„ì„œ ë°˜ë‚© ì•Œë¦¼**\n` +
                 `â€¢ ë„ì„œ: ${title}\n` +
                 `â€¢ ì €ì: ${author}\n` +
                 `â€¢ ë°˜ë‚©ì: ${borrower}\n` +
                 `â€¢ ì½”ë“œ: ${code}\n` +
                 `â€¢ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}`;
        break;
        
      case 'overdue':
        message = `âš ï¸ **ì—°ì²´ ë„ì„œ ì•Œë¦¼**\n` +
                 `â€¢ ë„ì„œ: ${title}\n` +
                 `â€¢ ì €ì: ${author}\n` +
                 `â€¢ ëŒ€ì¶œì: ${borrower}\n` +
                 `â€¢ ì½”ë“œ: ${code}\n` +
                 `â€¢ ìƒíƒœ: ë°˜ë‚© ê¸°í•œ ì´ˆê³¼`;
        break;
    }

    return await this.sendNotification(message);
  }

  // ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸
  async testConnection() {
    if (!this.isEnabled) {
      return {
        success: false,
        message: 'Dooray ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸/í¬ìŠ¤íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.'
      };
    }

    try {
      const result = await this.makeApiRequest('test');
      
      if (result.success) {
        return {
          success: true,
          message: result.message,
          data: result.data
        };
      } else {
        return {
          success: false,
          message: result.message || 'Google Apps Script ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨'
        };
      }
    } catch (error) {
      let errorMessage = `ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`;
      
      if (error.message.includes('ë°±ì—”ë“œ URL')) {
        errorMessage += `

ğŸ”§ Google Apps Script ë°±ì—”ë“œ ì„¤ì • ë°©ë²•:
1. library-gas-backend.js íŒŒì¼ì„ Google Apps Scriptì— ë°°í¬
2. ì›¹ì•±ìœ¼ë¡œ ë°°í¬ í›„ URL ë³µì‚¬
3. ì•„ë˜ ë°±ì—”ë“œ URL ì„¤ì •ì— ì…ë ¥`;
      }
      
      return {
        success: false,
        message: errorMessage
      };
    }
  }
}

// ğŸŒ ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
window.doorayIntegration = new DoorayIntegration();
</script>

<script>
// Modularized library management script
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdGuoHeUW-37RFCBgMH7ZUNL0tt_yHQiIFMrif85mrV428Omg/viewform";
const ENTRY_IDS = {
  code: "entry.32105598",
  title: "entry.1234176416",
  author: "entry.628826984",
  status: "entry.12641564",
  renter: "entry.615776096"
};

const Utils = (() => {
  const norm = (value) => String(value || '').replace(/\uFEFF/g, '').trim();
  const normHead = (value) => norm(value).replace(/\s/g, '');
  const includesAny = (header, keywords) => keywords.some((keyword) => normHead(header).includes(keyword));
  const findColIndex = (header, candidates) => header.findIndex((h) => includesAny(h, candidates));
  const get = (id) => document.getElementById(id);

  return { norm, normHead, includesAny, findColIndex, get };
})();

const AppState = {
  itemsPerPage: 20,
  currentPage: { loanTable: 1, libraryTable: 1 },
  totalPages: { loanTable: 1, libraryTable: 1 },
  baseData: { loanTable: [], libraryTable: [] },
  viewData: { loanTable: [], libraryTable: [] },
  withQR: { loanTable: false, libraryTable: false },
  sortState: {},
  sortedColumn: { loanTable: null, libraryTable: null },
  filters: { borrowed: false, newest: false, recent: false }
};

const CSVService = {
  async load(file) {
    const response = await fetch(`${file}?v=${Date.now()}`);
    if (!response.ok) {
      throw new Error(`${file} ë¡œë“œ ì‹¤íŒ¨`);
    }

    const text = await response.text();
    return Papa.parse(text.trim(), { skipEmptyLines: true }).data;
  }
};

const Toast = (() => {
  function ensureStyle() {
    if (document.getElementById('toast-style')) {
      return;
    }

    const style = document.createElement('style');
    style.id = 'toast-style';
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }

  function show(message, duration = 3000) {
    ensureStyle();

    const toast = document.createElement('div');
    toast.style.cssText = `
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: rgba(37, 99, 235, 0.95);
      color: #fff;
      padding: 12px 18px;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.18);
      z-index: 10000;
      font-size: 14px;
      max-width: 320px;
      animation: slideIn 0.25s ease-out;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideOut 0.25s ease-in forwards';
      setTimeout(() => toast.remove(), 250);
    }, duration);
  }

  return { show };
})();

const LoanStatus = (() => {
  function isOverdue(dateStr, status) {
    if (!dateStr || status.includes('ë°˜ë‚©')) {
      return false;
    }

    const date = new Date(dateStr);
    if (isNaN(date)) {
      return false;
    }

    const diff = (Date.now() - date.getTime()) / (1000 * 60 * 60 * 24);
    return diff > 14;
  }

  function calculate(dateStr, status) {
    if (!dateStr || status.includes('ë°˜ë‚©')) {
      return { status: 'ë°˜ë‚©', displayText: 'ë°˜ë‚©', className: '' };
    }

    const loanDate = new Date(dateStr);
    if (isNaN(loanDate)) {
      return { status, displayText: status, className: '' };
    }

    const now = new Date();
    const diffInDays = Math.floor((now.getTime() - loanDate.getTime()) / (1000 * 60 * 60 * 24));
    const remainingDays = 14 - diffInDays;

    if (remainingDays > 0) {
      return {
        status: 'ëŒ€ì¶œ',
        displayText: `ëŒ€ì¶œ (${remainingDays}ì¼ ë‚¨ìŒ)`,
        className: 'borrowed',
        remainingDays
      };
    }

    if (remainingDays === 0) {
      return {
        status: 'ëŒ€ì¶œ',
        displayText: 'ëŒ€ì¶œ (ì˜¤ëŠ˜ ë°˜ë‚©)',
        className: 'borrowed',
        remainingDays: 0
      };
    }

    const overdueDays = Math.abs(remainingDays);
    return {
      status: 'ì—°ì²´',
      displayText: `ì—°ì²´ (${overdueDays}ì¼ ì´ˆê³¼)`,
      className: 'overdue',
      overdueDays
    };
  }

  return { isOverdue, calculate };
})();

const QRManager = (() => {
  function buildFormUrl({ code, title, author, renter, status }) {
    let statusEncoded = '';
    if (status.includes('ë°˜ë‚©')) {
      statusEncoded = '%EB%B0%98%EB%82%A9';
    } else if (/(ëŒ€ì¶œ|ëŒ€ì—¬|ì—°ì²´)/.test(status)) {
      statusEncoded = '%EB%8C%80%EC%B6%9C';
    }

    return `${FORM_URL}?usp=pp_url&${ENTRY_IDS.code}=${encodeURIComponent(code)}&${ENTRY_IDS.title}=${encodeURIComponent(title)}&${ENTRY_IDS.author}=${encodeURIComponent(author)}&${ENTRY_IDS.renter}=${encodeURIComponent(renter)}&${ENTRY_IDS.status}=${statusEncoded}`;
  }

  function generate({ code, title, author, renter, status }) {
    const url = buildFormUrl({ code, title, author, renter, status });
    const layer = document.createElement('div');
    layer.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;';
    layer.innerHTML = `
      <div style="background:#fff;padding:18px 22px;border-radius:10px;text-align:center;max-width:420px">
        <h3 style="margin:6px 0 12px">ğŸ“· QR ì½”ë“œ (${code})</h3>
        <div id="qrbox" style="margin:0 auto 10px;width:220px;height:220px"></div>
        <p style="word-break:break-all;font-size:12px;"><a href="${url}" target="_blank">${url}</a></p>
        <div style="margin-top:10px">
          <button id="qrClose" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:6px 10px;margin-right:6px">ë‹«ê¸°</button>
          <button id="qrDown" style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px">QR ë‹¤ìš´ë¡œë“œ</button>
        </div>
      </div>`;

    document.body.appendChild(layer);
    new QRCode(layer.querySelector('#qrbox'), {
      text: url,
      width: 220,
      height: 220,
      colorDark: '#000',
      colorLight: '#fff',
      correctLevel: QRCode.CorrectLevel.H
    });

    layer.querySelector('#qrClose').onclick = () => layer.remove();
    layer.querySelector('#qrDown').onclick = () => {
      const img = layer.querySelector('#qrbox img');
      const a = document.createElement('a');
      a.href = img.src;
      a.download = `${code}.png`;
      a.click();
    };

    DoorayUI.notifyBookEvent({ code, title, author, borrower: renter, status });
  }

  return { generate };
})();

const TableManager = (() => {
  function render(rows, tableId, withQR = false, options = {}) {
    const { preserveBase = false } = options;
    AppState.withQR[tableId] = withQR;

    if (!preserveBase) {
      AppState.baseData[tableId] = [...rows];
    }

    AppState.viewData[tableId] = [...rows];
    AppState.currentPage[tableId] = 1;
    renderPage(tableId);
    renderPagination(tableId);
    window.allTableData = AppState.baseData;
  }

  function renderPagination(tableId) {
    const paginationId = tableId === 'loanTable' ? 'loanPagination' : 'libraryPagination';
    const container = Utils.get(paginationId);
    if (!container) {
      return;
    }

    container.innerHTML = '';
    const totalItems = Math.max(AppState.viewData[tableId].length - 1, 0);
    const pages = Math.ceil(totalItems / AppState.itemsPerPage);
    AppState.totalPages[tableId] = pages;

    if (pages <= 1) {
      return;
    }

    const current = AppState.currentPage[tableId];
    const createButton = (label, page, { disabled = false, active = false } = {}) => {
      const button = document.createElement('button');
      button.textContent = label;
      if (disabled) button.disabled = true;
      if (active) button.classList.add('active');
      button.addEventListener('click', () => changePage(tableId, page));
      return button;
    };

    container.appendChild(createButton('â€¹ ì´ì „', current - 1, { disabled: current === 1 }));

    let startPage = Math.max(1, current - 2);
    let endPage = Math.min(pages, current + 2);

    if (startPage > 1) {
      container.appendChild(createButton('1', 1));
      if (startPage > 2) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        container.appendChild(ellipsis);
      }
    }

    for (let page = startPage; page <= endPage; page++) {
      container.appendChild(createButton(String(page), page, { active: page === current }));
    }

    if (endPage < pages) {
      if (endPage < pages - 1) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        container.appendChild(ellipsis);
      }
      container.appendChild(createButton(String(pages), pages));
    }

    container.appendChild(createButton('ë‹¤ìŒ â€º', current + 1, { disabled: current === pages }));

    const info = document.createElement('span');
    info.className = 'page-info';
    info.textContent = `${current} / ${pages} í˜ì´ì§€ (ì´ ${totalItems}ê°œ)`;
    container.appendChild(info);
  }

  function changePage(tableId, page) {
    const pages = AppState.totalPages[tableId];
    if (page < 1 || page > pages) {
      return;
    }

    AppState.currentPage[tableId] = page;
    renderPage(tableId);
    renderPagination(tableId);

    const sectionId = tableId === 'loanTable' ? 'loanSection' : 'librarySection';
    const tableWrap = document.querySelector(`#${sectionId} .table-wrap`);
    if (tableWrap) {
      tableWrap.scrollTop = 0;
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function renderPage(tableId) {
    const rows = AppState.viewData[tableId];
    if (!rows.length) {
      return;
    }

    const table = Utils.get(tableId);
    if (!table) {
      return;
    }

    const header = rows[0];
    const withQR = AppState.withQR[tableId];
    const finalHeader = withQR ? [...header, 'QR ìƒì„±'] : [...header];
    const startIdx = (AppState.currentPage[tableId] - 1) * AppState.itemsPerPage + 1;
    const endIdx = Math.min(startIdx + AppState.itemsPerPage - 1, rows.length - 1);

    table.innerHTML = '';
    const headerRow = document.createElement('tr');
    const sortedInfo = AppState.sortedColumn[tableId];

    finalHeader.forEach((column, index) => {
      const th = document.createElement('th');
      th.textContent = column;

      if (index < header.length) {
        th.style.cursor = 'pointer';
        th.style.userSelect = 'none';
        th.addEventListener('click', () => sort(tableId, index));
        th.addEventListener('mouseenter', () => {
          if (!th.textContent.includes('â†‘') && !th.textContent.includes('â†“')) {
            th.style.background = '#e2e8f0';
          }
        });
        th.addEventListener('mouseleave', () => {
          if (!th.textContent.includes('â†‘') && !th.textContent.includes('â†“')) {
            th.style.background = '#f1f5f9';
          }
        });

        if (sortedInfo && sortedInfo.index === index) {
          th.textContent = `${column}${sortedInfo.isAsc ? ' â†‘' : ' â†“'}`;
          th.style.background = '#dbeafe';
        }
      }

      headerRow.appendChild(th);
    });

    table.appendChild(headerRow);

    for (let i = startIdx; i <= endIdx; i++) {
      const row = rows[i];
      if (!row) {
        continue;
      }

      const tr = document.createElement('tr');
      row.forEach((cell) => {
        const td = document.createElement('td');
        td.textContent = cell;
        tr.appendChild(td);
      });

      if (withQR) {
        const titleIdx = Utils.findColIndex(header, ['ì œëª©', 'ë„ì„œëª…']);
        const codeIdx = Utils.findColIndex(header, ['ì½”ë“œ', 'ì½”ë“œë²ˆí˜¸']);
        const statusIdx = Utils.findColIndex(header, ['ìƒíƒœ', 'ëŒ€ì¶œì—¬ë¶€']);
        const authorIdx = Utils.findColIndex(header, ['ì§€ì€ì´', 'ì €ì']);
        const renterIdx = Utils.findColIndex(header, ['ëŒ€ì¶œì', 'ëŒ€ì—¬ì']);

        const statusInfo = row._statusInfo;
        const statusText = statusIdx !== -1 ? row[statusIdx] : '';

        if (statusInfo && statusInfo.className) {
          tr.classList.add(statusInfo.className);
        } else if (statusText.includes('ì—°ì²´')) {
          tr.classList.add('overdue');
        } else if (/(ëŒ€ì¶œ|ëŒ€ì—¬)/.test(statusText)) {
          tr.classList.add('borrowed');
        }

        if (titleIdx !== -1) {
          const tdTitle = tr.children[titleIdx];
          const titleText = Utils.norm(row[titleIdx]);
          const codeText = codeIdx !== -1 ? Utils.norm(row[codeIdx]) : '';
          const authorText = authorIdx !== -1 ? Utils.norm(row[authorIdx]) : '';

          if (tdTitle) {
            tdTitle.style.color = '#2563eb';
            tdTitle.style.cursor = 'pointer';
            tdTitle.style.fontWeight = '500';
            tdTitle.title = 'í´ë¦­í•˜ë©´ ë„ì„œ ìƒì„¸ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
            tdTitle.onclick = () => BookPreviewModal.show(codeText, titleText, authorText);
          }
        }

        const qrCell = document.createElement('td');
        const qrButton = document.createElement('button');
        qrButton.className = 'qr-btn';
        qrButton.textContent = 'ğŸ“· QR';
        qrButton.onclick = () => {
          QRManager.generate({
            code: row[codeIdx] || '',
            title: row[titleIdx] || '',
            author: row[authorIdx] || '',
            renter: row[renterIdx] || '',
            status: row[statusIdx] || ''
          });
        };
        qrCell.appendChild(qrButton);
        tr.appendChild(qrCell);
      }

      table.appendChild(tr);
    }
  }

  function sort(tableId, colIdx) {
    const rows = AppState.baseData[tableId];
    if (!rows.length) {
      return;
    }

    const header = rows[0];
    const dataRows = rows.slice(1);
    const sortKey = `${tableId}_${colIdx}`;
    const isAsc = !AppState.sortState[sortKey];
    AppState.sortState[sortKey] = isAsc;
    AppState.sortedColumn[tableId] = { index: colIdx, isAsc };

    dataRows.sort((a, b) => {
      const aVal = a[colIdx] || '';
      const bVal = b[colIdx] || '';
      const aNum = parseFloat(String(aVal).replace(/[^\d.-]/g, ''));
      const bNum = parseFloat(String(bVal).replace(/[^\d.-]/g, ''));
      let result;

      if (!isNaN(aNum) && !isNaN(bNum)) {
        result = aNum - bNum;
      } else {
        result = String(aVal).localeCompare(String(bVal), 'ko', { numeric: true });
      }

      return isAsc ? result : -result;
    });

    const sortedData = [header, ...dataRows];
    AppState.baseData[tableId] = [...sortedData];
    AppState.viewData[tableId] = [...sortedData];
    AppState.currentPage[tableId] = 1;
    renderPage(tableId);
    renderPagination(tableId);
  }

  return { render, changePage, sort };
})();

const FilterManager = (() => {
  let originalLibraryData = [];
  let dateIndex = -1;
  const boundSearchInputs = new Set();

  function init(data) {
    originalLibraryData = [...data];
    dateIndex = Utils.findColIndex(data[0], ['ë“±ë¡ì¼', 'ì¼ì', 'ë‚ ì§œ', 'ì…ê³ ì¼', 'êµ¬ì…ì¼']);
  }

  function applyFilters() {
    if (!originalLibraryData.length) {
      return;
    }

    let data = [...originalLibraryData];

    if (AppState.filters.newest) {
      data = [data[0], ...data.slice(1).reverse()];
    }

    const statusIdx = Utils.findColIndex(data[0], ['ìƒíƒœ', 'ëŒ€ì¶œì—¬ë¶€']);
    const filtered = [data[0]];

    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      let show = true;

      if (AppState.filters.borrowed) {
        const statusInfo = row._statusInfo;
        const statusText = statusIdx !== -1 ? row[statusIdx] || '' : '';
        const isBorrowed = statusInfo
          ? ['ëŒ€ì¶œ', 'ì—°ì²´'].includes(statusInfo.status)
          : /(ëŒ€ì¶œ|ëŒ€ì—¬|ì—°ì²´)/.test(statusText);
        if (!isBorrowed) {
          show = false;
        }
      }

      if (show && AppState.filters.recent && dateIndex !== -1) {
        const dateText = row[dateIndex] || '';
        const bookDate = new Date(dateText);
        const now = new Date();
        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        const isRecent = !isNaN(bookDate) && bookDate >= thirtyDaysAgo;
        if (!isRecent) {
          show = false;
        }
      }

      if (show) {
        filtered.push(row);
      }
    }

    TableManager.render(filtered, 'libraryTable', true);
  }

  function toggleBorrowed() {
    AppState.filters.borrowed = !AppState.filters.borrowed;
    applyFilters();
    return AppState.filters.borrowed;
  }

  function toggleNewest() {
    AppState.filters.newest = !AppState.filters.newest;
    applyFilters();
    return AppState.filters.newest;
  }

  function toggleRecent() {
    if (dateIndex === -1) {
      return { available: false };
    }
    AppState.filters.recent = !AppState.filters.recent;
    applyFilters();
    return { available: true, active: AppState.filters.recent };
  }

  function bindSearch(inputId, tableId) {
    if (boundSearchInputs.has(inputId)) {
      return;
    }

    const input = Utils.get(inputId);
    if (!input) {
      return;
    }

    let timer;
    input.addEventListener('input', (event) => {
      clearTimeout(timer);
      timer = setTimeout(() => {
        const value = event.target.value.trim();
        const base = AppState.baseData[tableId];

        if (!value) {
          TableManager.render(base, tableId, tableId === 'libraryTable', { preserveBase: true });
          return;
        }

        const filtered = [base[0]];
        for (let i = 1; i < base.length; i++) {
          const rowText = base[i].join(' ');
          if (rowText.includes(value)) {
            filtered.push(base[i]);
          }
        }

        TableManager.render(filtered, tableId, tableId === 'libraryTable', { preserveBase: true });
      }, 150);
    });

    boundSearchInputs.add(inputId);
  }

  function getDateIndex() {
    return dateIndex;
  }

  function setOriginalData(data) {
    originalLibraryData = [...data];
    if (dateIndex === -1) {
      dateIndex = Utils.findColIndex(data[0], ['ë“±ë¡ì¼', 'ì¼ì', 'ë‚ ì§œ', 'ì…ê³ ì¼', 'êµ¬ì…ì¼']);
    }
  }

  return {
    init,
    applyFilters,
    toggleBorrowed,
    toggleNewest,
    toggleRecent,
    bindSearch,
    getDateIndex,
    setOriginalData
  };
})();

const BookPreviewModal = (() => {
  function show(code, title, author = '') {
    const modal = Utils.get('bookPreviewModal');
    const previewContent = Utils.get('bookPreviewContent');
    const historyContent = Utils.get('bookHistoryContent');

    if (!modal || !previewContent || !historyContent) {
      return;
    }

    modal.style.display = 'flex';
    switchTab('preview');
    previewContent.innerHTML = '<div class="loading">ğŸ“š ë„ì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

    fetchBookInfo(title, author)
      .then((bookData) => {
        if (bookData) {
          renderBookInfo(bookData, previewContent);
        } else {
          renderBasicBookInfo(title, author, code, previewContent);
        }
      })
      .catch(() => {
        renderBasicBookInfo(title, author, code, previewContent);
      })
      .finally(() => {
        renderBookHistory(code, title, historyContent);
      });

    modal.onclick = (event) => {
      if (event.target === modal) {
        close();
      }
    };

    const inner = modal.querySelector('.inner');
    if (inner) {
      inner.onclick = (event) => event.stopPropagation();
    }
  }

  async function fetchBookInfo(title, author) {
    const query = encodeURIComponent(`${title} ${author}`.trim());
    const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=5&langRestrict=ko`;
    const response = await fetch(apiUrl);
    const data = await response.json();

    if (!data.items || !data.items.length) {
      return null;
    }

    return findBestMatch(data.items, title);
  }

  function findBestMatch(items, targetTitle) {
    let bestMatch = items[0];
    let bestScore = 0;
    const normalized = targetTitle.toLowerCase();

    items.forEach((item) => {
      const title = (item.volumeInfo.title || '').toLowerCase();
      const score = calculateSimilarity(normalized, title);
      if (score > bestScore) {
        bestScore = score;
        bestMatch = item;
      }
    });

    return bestMatch;
  }

  function calculateSimilarity(a, b) {
    const wordsA = a.split(/\s+/);
    const wordsB = b.split(/\s+/);
    let common = 0;

    wordsA.forEach((word) => {
      if (word.length > 1 && wordsB.some((candidate) => candidate.includes(word) || word.includes(candidate))) {
        common++;
      }
    });

    return common / Math.max(wordsA.length, wordsB.length);
  }

  function renderBookInfo(bookData, container) {
    const info = bookData.volumeInfo;
    const title = info.title || 'ì œëª© ì—†ìŒ';
    const authors = info.authors ? info.authors.join(', ') : 'ì €ì ë¯¸ìƒ';
    const publisher = info.publisher || 'ì¶œíŒì‚¬ ë¯¸ìƒ';
    const publishedDate = info.publishedDate || 'ì¶œê°„ì¼ ë¯¸ìƒ';
    const description = info.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
    const thumbnail = info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '';
    const pageCount = info.pageCount || '-';
    const categories = info.categories ? info.categories.join(', ') : '-';
    const language = info.language === 'ko' ? 'í•œêµ­ì–´' : info.language || '-';
    const rating = info.averageRating || 0;
    const ratingsCount = info.ratingsCount || 0;

    container.innerHTML = `
      <div class="book-header">
        <div class="book-cover">
          ${thumbnail
            ? `<img src="${thumbnail.replace('http:', 'https:')}" alt="ì±… í‘œì§€" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDEyMCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxNjAiIGZpbGw9IiNFM0U1RTciLz48dGV4dCB4PSI2MCIgeT0iODAiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5Q0EzQUYiIGZvbnQtc2l6ZT0iMTIiPk5PIENPVkVSPC90ZXh0Pjwvc3ZnPg=='">`
            : '<div style="width:120px;height:160px;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:12px;">í‘œì§€ ì—†ìŒ</div>'}
        </div>
        <div class="book-info">
          <h2 class="book-title">${title}</h2>
          <p class="book-author">ğŸ‘¤ ${authors}</p>
          <p class="book-publisher">ğŸ¢ ${publisher}</p>
          ${rating > 0
            ? `<div class="book-rating">
                <span class="stars">${'â˜…'.repeat(Math.floor(rating))}${'â˜†'.repeat(5 - Math.floor(rating))}</span>
                <span style="color:#6b7280;font-size:13px;">${rating}/5.0 (${ratingsCount}ëª…)</span>
              </div>`
            : ''}
        </div>
      </div>
      <div class="book-meta">
        <div class="meta-item"><span class="meta-label">ğŸ“… ì¶œê°„ì¼</span><span class="meta-value">${publishedDate}</span></div>
        <div class="meta-item"><span class="meta-label">ğŸ“„ í˜ì´ì§€</span><span class="meta-value">${pageCount}í˜ì´ì§€</span></div>
        <div class="meta-item"><span class="meta-label">ğŸ·ï¸ ë¶„ì•¼</span><span class="meta-value">${categories}</span></div>
        <div class="meta-item"><span class="meta-label">ğŸŒ ì–¸ì–´</span><span class="meta-value">${language}</span></div>
      </div>
      <div class="book-description">
        <strong>ğŸ“ ë„ì„œ ì†Œê°œ</strong><br><br>
        ${description.length > 500 ? `${description.substring(0, 500)}...` : description}
      </div>`;
  }

  function renderBasicBookInfo(title, author, code, container) {
    container.innerHTML = `
      <div class="book-header">
        <div class="book-cover">
          <div style="width:120px;height:160px;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:12px;">í‘œì§€ ì—†ìŒ</div>
        </div>
        <div class="book-info">
          <h2 class="book-title">${title}</h2>
          ${author ? `<p class="book-author">ğŸ‘¤ ${author}</p>` : ''}
          <p style="color:#6b7280;font-size:14px;">ğŸ“š ì½”ë“œ: ${code}</p>
        </div>
      </div>
      <div class="book-description" style="text-align:center;color:#6b7280;padding:40px;">
        ìƒì„¸í•œ ë„ì„œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
        ë„ì„œê´€ ë‚´ë¶€ ì •ë³´ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
      </div>`;
  }

  function renderBookHistory(code, title, container) {
    const records = (window.booksData || []).filter((record) => Utils.norm(record[1]) === code);

    if (!records.length) {
      container.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280;">ëŒ€ì¶œ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    const rows = records
      .map((record) => {
        const loanStatus = LoanStatus.calculate(record[0], record[5]);
        const displayStatus = loanStatus.displayText || record[5];
        const className = loanStatus.status === 'ì—°ì²´'
          ? 'background:#fee2e2;color:#dc2626;'
          : loanStatus.status === 'ëŒ€ì¶œ'
            ? 'background:#fef3c7;color:#92400e;'
            : 'background:#d1fae5;color:#047857;';

        return `
          <tr>
            <td style="padding:10px 12px;border:1px solid #e2e8f0;">${record[0]}</td>
            <td style="padding:10px 12px;border:1px solid #e2e8f0;">${record[4]}</td>
            <td style="padding:10px 12px;border:1px solid #e2e8f0;">
              <span style="padding:2px 8px;border-radius:12px;font-size:12px;font-weight:500;${className}">${displayStatus}</span>
            </td>
          </tr>`;
      })
      .join('');

    container.innerHTML = `
      <h4 style="margin:0 0 16px 0;color:#1f2937;">ğŸ“‹ ëŒ€ì¶œ ì´ë ¥ (ì´ ${records.length}ê±´)</h4>
      <table style="width:100%;border-collapse:collapse;">
        <tr style="background:#f8fafc;">
          <th style="padding:12px;border:1px solid #e2e8f0;text-align:left;font-weight:600;">ë“±ë¡ì¼</th>
          <th style="padding:12px;border:1px solid #e2e8f0;text-align:left;font-weight:600;">ëŒ€ì—¬ì</th>
          <th style="padding:12px;border:1px solid #e2e8f0;text-align:left;font-weight:600;">ìƒíƒœ</th>
        </tr>
        ${rows}
      </table>`;
  }

  function switchTab(tabName) {
    const tabs = {
      preview: Utils.get('previewTab'),
      history: Utils.get('historyTab')
    };

    const buttons = document.querySelectorAll('#bookPreviewModal .tab-button');
    buttons.forEach((button) => {
      button.classList.toggle('active', button.textContent.includes(tabName === 'preview' ? 'ë„ì„œ ì •ë³´' : 'ëŒ€ì¶œ ì´ë ¥'));
    });

    Object.entries(tabs).forEach(([key, element]) => {
      if (element) {
        element.classList.toggle('active', key === tabName);
      }
    });
  }

  function close() {
    const modal = Utils.get('bookPreviewModal');
    if (modal) {
      modal.style.display = 'none';
      modal.onclick = null;
    }
  }

  return { show, switchTab, close };
})();

const HistoryModal = (() => {
  function show(code, title) {
    const modal = Utils.get('historyModal');
    const titleEl = Utils.get('histTitle');
    const content = Utils.get('histContent');

    if (!modal || !titleEl || !content) {
      return;
    }

    modal.style.display = 'flex';
    titleEl.innerHTML = `ğŸ“– ${title} (${code})`;

    const records = (window.booksData || []).filter((row) => Utils.norm(row[1]) === code);
    if (!records.length) {
      content.innerHTML = '<p style="text-align:center;padding:32px;color:#6b7280;">ëŒ€ì¶œ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    const rows = records
      .map((row) => {
        const status = LoanStatus.calculate(row[0], row[5]);
        return `
          <tr>
            <td>${row[0]}</td>
            <td>${row[4]}</td>
            <td>${status.displayText || row[5]}</td>
          </tr>`;
      })
      .join('');

    content.innerHTML = `
      <table style="width:100%;border-collapse:collapse;font-size:14px;">
        <thead>
          <tr>
            <th style="width:30%;padding:10px 12px;border:1px solid #e2e8f0;background:#f8fafc;">ë“±ë¡ì¼</th>
            <th style="width:25%;padding:10px 12px;border:1px solid #e2e8f0;background:#f8fafc;">ëŒ€ì¶œì</th>
            <th style="width:45%;padding:10px 12px;border:1px solid #e2e8f0;background:#f8fafc;">ìƒíƒœ</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  function close() {
    const modal = Utils.get('historyModal');
    if (modal) {
      modal.style.display = 'none';
      modal.onclick = null;
    }
  }

  return { show, close };
})();

const DoorayUI = (() => {
  function updateButtonStatus() {
    const button = Utils.get('btnDooraySync');
    if (!button) {
      return;
    }

    const enabled = window.doorayIntegration && window.doorayIntegration.isEnabled;
    if (enabled) {
      button.innerHTML = 'âœ… Dooray ì—°ë™ë¨';
      button.style.background = '#10b981';
      button.title = 'Dooray ì—°ë™ì´ í™œì„±í™”ë˜ì–´ ìë™ ì•Œë¦¼ì´ ì‘ë™í•©ë‹ˆë‹¤';
    } else {
      button.innerHTML = 'ğŸ”„ Dooray ì—°ë™';
      button.style.background = '#7c3aed';
      button.title = 'Dooray API ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤';
    }
  }

  function showModal() {
    const modal = Utils.get('doorayModal');
    if (!modal) {
      return;
    }

    const statusDiv = Utils.get('doorayStatus');
    const featuresDiv = Utils.get('doorayFeatures');
    const setupDiv = Utils.get('dooraySetup');
    const testResult = Utils.get('doorayTestResult');

    modal.style.display = 'flex';
    if (testResult) {
      testResult.style.display = 'none';
      testResult.textContent = '';
    }

    const backendUrlInput = Utils.get('gasBackendUrl');
    const wikiIdInput = Utils.get('doorayWikiId');
    const pageIdInput = Utils.get('doorayPageId');

    if (backendUrlInput) backendUrlInput.value = localStorage.getItem('gas_backend_url') || '';
    if (wikiIdInput) wikiIdInput.value = localStorage.getItem('dooray_wiki_id') || '';
    if (pageIdInput) pageIdInput.value = localStorage.getItem('dooray_page_id') || '';

    const enabled = window.doorayIntegration && window.doorayIntegration.isEnabled;
    if (enabled) {
      statusDiv.className = 'status-card status-success';
      statusDiv.innerHTML = `<strong>âœ… Dooray ì—°ë™ í™œì„±í™”ë¨</strong><br>Wiki ID: ${window.DOORAY_CONFIG.wikiId}<br>Page ID: ${window.DOORAY_CONFIG.pageId}`;
      if (featuresDiv) featuresDiv.style.display = 'block';
      if (setupDiv) setupDiv.style.display = 'block';
    } else {
      statusDiv.className = 'status-card status-warning';
      statusDiv.innerHTML = '<strong>âš™ï¸ Dooray ì—°ë™ ì„¤ì • í•„ìš”</strong><br>Google Apps Script ë°±ì—”ë“œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      if (featuresDiv) featuresDiv.style.display = 'none';
      if (setupDiv) setupDiv.style.display = 'block';
    }

    modal.onclick = (event) => {
      if (event.target === modal) {
        closeModal();
      }
    };

    const inner = modal.querySelector('.inner');
    if (inner) {
      inner.onclick = (event) => event.stopPropagation();
    }
  }

  function closeModal() {
    const modal = Utils.get('doorayModal');
    if (modal) {
      modal.style.display = 'none';
      modal.onclick = null;
    }
  }

  async function testConnection() {
    const resultDiv = Utils.get('doorayTestResult');
    if (!resultDiv) {
      return;
    }

    resultDiv.style.display = 'block';
    resultDiv.className = 'test-result';
    resultDiv.innerHTML = 'ğŸ”„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';

    if (!window.doorayIntegration || !window.doorayIntegration.isEnabled) {
      resultDiv.className = 'test-result status-error';
      resultDiv.innerHTML = 'âŒ Dooray ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }

    try {
      const result = await window.doorayIntegration.testConnection();
      if (result.success) {
        resultDiv.className = 'test-result status-success';
        resultDiv.innerHTML = `âœ… ${result.message}<br>Wiki ID: ${result.data.wikiId || 'N/A'}<br>í˜ì´ì§€ ì œëª©: ${result.data.pageTitle || 'N/A'}`;
      } else {
        resultDiv.className = 'test-result status-error';
        resultDiv.innerHTML = 'âŒ ' + result.message;
      }
    } catch (error) {
      resultDiv.className = 'test-result status-error';
      resultDiv.innerHTML = 'âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message;
    }
  }

  function getLibrarySnapshot() {
    const libraryData = AppState.baseData.libraryTable;
    return libraryData && libraryData.length ? libraryData : null;
  }

  function extractUnreturnedBooks(libraryData) {
    if (!libraryData || !libraryData.length) {
      return [];
    }

    const header = libraryData[0];
    const statusIdx = Utils.findColIndex(header, ['ìƒíƒœ', 'ëŒ€ì¶œì—¬ë¶€']);
    const borrowerIdx = Utils.findColIndex(header, ['ëŒ€ì¶œì', 'ëŒ€ì—¬ì']);
    const codeIdx = Utils.findColIndex(header, ['ì½”ë“œ', 'ì½”ë“œë²ˆí˜¸']);
    const titleIdx = Utils.findColIndex(header, ['ì œëª©', 'ë„ì„œëª…']);
    const authorIdx = Utils.findColIndex(header, ['ì§€ì€ì´', 'ì €ì']);

    const unreturned = [];
    for (let i = 1; i < libraryData.length; i++) {
      const row = libraryData[i];
      const status = statusIdx !== -1 ? String(row[statusIdx] || '') : '';
      const borrower = borrowerIdx !== -1 ? String(row[borrowerIdx] || '') : '';
      const isBorrowed = /(ëŒ€ì¶œ|ëŒ€ì—¬|ì—°ì²´|borrowed|overdue)/i.test(status) || (!!borrower && borrower !== '-' && borrower !== '');

      if (isBorrowed) {
        unreturned.push({
          bookCode: codeIdx !== -1 ? row[codeIdx] : '',
          title: titleIdx !== -1 ? row[titleIdx] : 'ì œëª©ì—†ìŒ',
          author: authorIdx !== -1 ? row[authorIdx] : 'ì €ìë¯¸ìƒ',
          borrower: borrower || 'ëŒ€ì¶œìë¯¸ìƒ',
          status: status || 'ìƒíƒœì •ë³´ì—†ìŒ'
        });
      }
    }

    return unreturned;
  }

  function buildWikiContent(libraryData) {
    const unreturned = extractUnreturnedBooks(libraryData);
    const totalBooks = Math.max(libraryData.length - 1, 0);
    const overdueCount = unreturned.filter((book) => String(book.status).includes('ì—°ì²´')).length;
    const returnRate = totalBooks === 0 ? 100 : ((totalBooks - unreturned.length) / totalBooks * 100).toFixed(1);
    const now = new Date().toLocaleString('ko-KR');

    const lines = [];
    lines.push('# ğŸ“š ë„ì„œê´€ë¦¬ í˜„í™©');
    lines.push('');
    lines.push(`**ì—…ë°ì´íŠ¸:** ${now}`);
    lines.push('');
    lines.push('## ğŸ“Š í†µê³„');
    lines.push(`- ì „ì²´ ë„ì„œ: ${totalBooks}ê¶Œ`);
    lines.push(`- ë¯¸ë°˜ë‚© ë„ì„œ: ${unreturned.length}ê¶Œ`);
    if (overdueCount > 0) {
      lines.push(`- ì—°ì²´ ë„ì„œ: ${overdueCount}ê¶Œ`);
    }
    lines.push(`- ë°˜ë‚©ë¥ : ${returnRate}%`);
    lines.push('');

    if (unreturned.length) {
      lines.push('## ğŸ“• ë¯¸ë°˜ë‚© ë„ì„œ ëª©ë¡');
      lines.push('');
      lines.push('| ë„ì„œì½”ë“œ | ë„ì„œëª… | ì €ì | ëŒ€ì¶œì | ìƒíƒœ |');
      lines.push('|----------|--------|------|--------|------|');
      unreturned.slice(0, 10).forEach((book) => {
        lines.push(`| ${book.bookCode || '-'} | ${book.title || '-'} | ${book.author || '-'} | ${book.borrower || '-'} | ${book.status || '-'} |`);
      });
      if (unreturned.length > 10) {
        lines.push('');
        lines.push(`*... ì™¸ ${unreturned.length - 10}ê¶Œ ë” ìˆìŒ*`);
      }
    } else {
      lines.push('## âœ… ëª¨ë“  ë„ì„œê°€ ë°˜ë‚©ë˜ì—ˆìŠµë‹ˆë‹¤!');
      lines.push('ğŸ‰ ëª¨ë“  ë„ì„œê°€ ì •ìƒì ìœ¼ë¡œ ë°˜ë‚©ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    lines.push('');
    lines.push('---');
    lines.push('*ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œì—ì„œ ìë™ ìƒì„±ë¨*');
    lines.push(`*ìµœì¢… ì—…ë°ì´íŠ¸: ${now}*`);

    return lines.join('\n');
  }

  async function syncLibrary() {
    const resultDiv = Utils.get('doorayTestResult');
    if (!resultDiv) {
      return;
    }

    resultDiv.style.display = 'block';
    resultDiv.className = 'test-result';
    resultDiv.innerHTML = 'ğŸ”„ Wiki ì—…ë°ì´íŠ¸ ì¤‘...';

    if (!window.doorayIntegration || !window.doorayIntegration.isEnabled) {
      resultDiv.className = 'test-result status-error';
      resultDiv.innerHTML = 'âŒ Dooray ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }

    const libraryData = getLibrarySnapshot();
    if (!libraryData) {
      resultDiv.className = 'test-result status-error';
      resultDiv.innerHTML = 'âŒ ë„ì„œê´€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }

    try {
      const content = buildWikiContent(libraryData);
      const backendUrl = localStorage.getItem('gas_backend_url');
      if (!backendUrl) {
        throw new Error('Google Apps Script ë°±ì—”ë“œ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }

      const response = await window.doorayIntegration.makePostRequest(backendUrl, 'updateWiki', { content });
      if (response && response.success) {
        resultDiv.className = 'test-result status-success';
        resultDiv.innerHTML = 'âœ… Dooray Wiki ì—…ë°ì´íŠ¸ ì™„ë£Œ!';
      } else {
        resultDiv.className = 'test-result status-error';
        resultDiv.innerHTML = 'âŒ Wiki ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (response?.message || response?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      }
    } catch (error) {
      resultDiv.className = 'test-result status-error';
      resultDiv.innerHTML = 'âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message;
    }
  }

  async function sendTestNotification() {
    const resultDiv = Utils.get('doorayTestResult');
    if (!resultDiv) {
      return;
    }

    resultDiv.style.display = 'block';
    resultDiv.className = 'test-result';
    resultDiv.innerHTML = 'ğŸ”„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì¤‘...';

    if (!window.doorayIntegration || !window.doorayIntegration.isEnabled) {
      resultDiv.className = 'test-result status-error';
      resultDiv.innerHTML = 'âŒ Dooray ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }

    try {
      const success = await window.doorayIntegration.notifyBookAction('borrow', {
        title: 'í…ŒìŠ¤íŠ¸ ë„ì„œ',
        author: 'í…ŒìŠ¤íŠ¸ ì €ì',
        borrower: 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
        code: 'TEST001'
      });

      if (success) {
        resultDiv.className = 'test-result status-success';
        resultDiv.innerHTML = 'âœ… í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ!';
      } else {
        resultDiv.className = 'test-result status-warning';
        resultDiv.innerHTML = 'âš ï¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (ì±„ë„ ID ë¯¸ì„¤ì • ë˜ëŠ” ê¶Œí•œ ì—†ìŒ)';
      }
    } catch (error) {
      resultDiv.className = 'test-result status-error';
      resultDiv.innerHTML = 'âŒ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ' + error.message;
    }
  }

  async function saveConfig() {
    const backendUrl = Utils.get('gasBackendUrl')?.value.trim();
    const wikiId = Utils.get('doorayWikiId')?.value.trim();
    const pageId = Utils.get('doorayPageId')?.value.trim();
    const resultDiv = Utils.get('doorayTestResult');

    if (!resultDiv) {
      return;
    }

    resultDiv.style.display = 'block';
    resultDiv.className = 'test-result';
    resultDiv.innerHTML = 'ğŸ”„ ì„¤ì • ì €ì¥ ë° ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';

    if (!backendUrl || !wikiId || !pageId) {
      resultDiv.className = 'test-result status-error';
      resultDiv.innerHTML = 'âŒ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      return;
    }

    try {
      localStorage.setItem('gas_backend_url', backendUrl);
      localStorage.setItem('dooray_wiki_id', wikiId);
      localStorage.setItem('dooray_page_id', pageId);

      window.DOORAY_CONFIG.wikiId = wikiId;
      window.DOORAY_CONFIG.pageId = pageId;
      window.doorayIntegration = new DoorayIntegration();
      updateButtonStatus();
      await testConnection();
    } catch (error) {
      resultDiv.className = 'test-result status-error';
      resultDiv.innerHTML = 'âŒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + error.message;
    }
  }

  function testSetup() {
    console.log('DOORAY_CONFIG:', window.DOORAY_CONFIG);
    console.log('doorayIntegration:', window.doorayIntegration);
    alert('ğŸ§ª í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ì½˜ì†”(F12)ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
  }

  function clearConfig() {
    if (!confirm('Dooray ì„¤ì •ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    localStorage.removeItem('gas_backend_url');
    localStorage.removeItem('dooray_wiki_id');
    localStorage.removeItem('dooray_page_id');

    window.DOORAY_CONFIG.wikiId = '';
    window.DOORAY_CONFIG.pageId = '';
    window.doorayIntegration = new DoorayIntegration();
    updateButtonStatus();
    alert('âœ… ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    showModal();
  }

  function notifyBookEvent(bookInfo) {
    if (!window.doorayIntegration || !window.doorayIntegration.isEnabled) {
      return;
    }

    setTimeout(async () => {
      try {
        const action = bookInfo.status.includes('ë°˜ë‚©') ? 'return' : 'borrow';
        const success = await window.doorayIntegration.notifyBookAction(action, {
          title: bookInfo.title,
          author: bookInfo.author,
          borrower: bookInfo.borrower,
          code: bookInfo.code
        });

        if (success) {
          Toast.show(`ğŸ“¢ Dooray ì•Œë¦¼ ì „ì†¡ë¨: ${bookInfo.title}`);
        }
      } catch (error) {
        console.warn('Dooray ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜:', error);
      }
    }, 800);
  }

  return {
    updateButtonStatus,
    showModal,
    closeModal,
    testConnection,
    syncLibrary,
    sendTestNotification,
    saveConfig,
    testSetup,
    clearConfig,
    notifyBookEvent
  };
})();

const LibraryApp = (() => {
  function showLibrarySection() {
    Utils.get('librarySection')?.classList.remove('hidden');
    Utils.get('loanSection')?.classList.add('hidden');
    Utils.get('btnLibrary')?.classList.add('active');
    Utils.get('btnLoans')?.classList.remove('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
    document.querySelector('#librarySection .table-wrap')?.scrollTo({ top: 0 });
  }

  function showLoanSection() {
    Utils.get('loanSection')?.classList.remove('hidden');
    Utils.get('librarySection')?.classList.add('hidden');
    Utils.get('btnLoans')?.classList.add('active');
    Utils.get('btnLibrary')?.classList.remove('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
    document.querySelector('#loanSection .table-wrap')?.scrollTo({ top: 0 });
  }

  function bindNavigation() {
    Utils.get('btnLoans')?.addEventListener('click', showLoanSection);
    Utils.get('btnLibrary')?.addEventListener('click', showLibrarySection);
    Utils.get('btnAddBook')?.addEventListener('click', () => {
      window.open('https://docs.google.com/forms/d/e/1FAIpQLSdOFZRt4o-bw6UNmBB6JtdDQ6PR5f7eW0dpfIs8KwyUysL5ag/viewform?usp=header');
    });
    Utils.get('btnDooraySync')?.addEventListener('click', () => DoorayUI.showModal());
  }

  function bindFilters() {
    const borrowedButton = Utils.get('btnBorrowed');
    const newestButton = Utils.get('btnNewest');
    const recentButton = Utils.get('btnRecent');

    if (borrowedButton) {
      borrowedButton.addEventListener('click', () => {
        showLibrarySection();
        const active = FilterManager.toggleBorrowed();
        borrowedButton.classList.toggle('active', active);
      });
    }

    if (newestButton) {
      newestButton.addEventListener('click', () => {
        showLibrarySection();
        const active = FilterManager.toggleNewest();
        newestButton.classList.toggle('active', active);
        newestButton.innerHTML = active ? 'ğŸ“‰ ì˜¤ë˜ëœ ìˆœìœ¼ë¡œ ë³´ê¸°' : 'ğŸ“ˆ ìµœì‹  ë„ì„œ ìˆœìœ¼ë¡œ ë³´ê¸°';
      });
    }

    if (recentButton) {
      const dateIndex = FilterManager.getDateIndex();
      if (dateIndex === -1) {
        recentButton.style.opacity = '0.5';
        recentButton.style.cursor = 'not-allowed';
        recentButton.title = 'ë“±ë¡ì¼ ì •ë³´ê°€ ì—†ì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        recentButton.addEventListener('click', () => {
          alert('ğŸ“… ë“±ë¡ì¼ ì •ë³´ê°€ ì—†ì–´ì„œ ìµœê·¼ 30ì¼ í•„í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nCSV íŒŒì¼ì— "ë“±ë¡ì¼", "ì¼ì", "ë‚ ì§œ" ë“±ì˜ ì»¬ëŸ¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
        });
      } else {
        recentButton.addEventListener('click', () => {
          showLibrarySection();
          const { available, active } = FilterManager.toggleRecent();
          if (available) {
            recentButton.classList.toggle('active', !!active);
          }
        });
      }
    }
  }

  function calculateLibraryStatus(books, library) {
    const bookHeader = books[0].map(Utils.norm);
    const bookDateIdx = Utils.findColIndex(bookHeader, ['ë“±ë¡ì¼', 'ëŒ€ì¶œì¼', 'ì¼ì']);
    const bookCodeIdx = Utils.findColIndex(bookHeader, ['ì½”ë“œ', 'ì½”ë“œë²ˆí˜¸']);
    const bookStatusIdx = Utils.findColIndex(bookHeader, ['ìƒíƒœ', 'ëŒ€ì¶œì—¬ë¶€']);
    const bookUserIdx = Utils.findColIndex(bookHeader, ['ëŒ€ì—¬ì', 'ëŒ€ì¶œì']);

    const latestByCode = {};
    for (let i = 1; i < books.length; i++) {
      const date = Utils.norm(books[i][bookDateIdx]);
      const code = Utils.norm(books[i][bookCodeIdx]);
      const status = Utils.norm(books[i][bookStatusIdx]);
      const borrower = Utils.norm(books[i][bookUserIdx]);
      if (!code) continue;
      if (!latestByCode[code]) {
        latestByCode[code] = { status: '', borrower: '', lastReturn: '' };
      }
      if (status.includes('ë°˜ë‚©')) {
        latestByCode[code].lastReturn = date;
      }
      latestByCode[code].status = status;
      latestByCode[code].borrower = borrower;
    }

    const libraryHeader = library[0].map(Utils.norm);
    const codeIdx = Utils.findColIndex(libraryHeader, ['ì½”ë“œ', 'ì½”ë“œë²ˆí˜¸']);
    let statusIdx = Utils.findColIndex(libraryHeader, ['ìƒíƒœ', 'ëŒ€ì¶œì—¬ë¶€']);
    let borrowerIdx = Utils.findColIndex(libraryHeader, ['ëŒ€ì—¬ì', 'ëŒ€ì¶œì']);

    if (statusIdx === -1) {
      library[0].push('ëŒ€ì¶œì—¬ë¶€');
      statusIdx = library[0].length - 1;
    }

    if (borrowerIdx === -1) {
      library[0].push('ëŒ€ì¶œì');
      borrowerIdx = library[0].length - 1;
    }

    for (let i = 1; i < library.length; i++) {
      const code = Utils.norm(library[i][codeIdx]);
      const record = latestByCode[code];
      if (!record) {
        library[i][statusIdx] = '';
        library[i][borrowerIdx] = '';
        continue;
      }

      if (record.status.includes('ë°˜ë‚©')) {
        library[i][statusIdx] = 'ë°˜ë‚©';
        library[i][borrowerIdx] = '';
        continue;
      }

      library[i][borrowerIdx] = record.borrower || '';
      const loanRow = books.find((row) => Utils.norm(row[bookCodeIdx]) === code && !row[bookStatusIdx].includes('ë°˜ë‚©'));
      const loanDate = loanRow ? loanRow[bookDateIdx] : '';
      const loanStatus = LoanStatus.calculate(loanDate, record.status);
      library[i][statusIdx] = loanStatus.displayText;
      library[i]._statusInfo = loanStatus;
    }

    return library;
  }

  async function init() {
    try {
      DoorayUI.updateButtonStatus();
      bindNavigation();

      const [books, library] = await Promise.all([
        CSVService.load('books.csv'),
        CSVService.load('library.csv')
      ]);

      window.booksData = books;
      TableManager.render(books, 'loanTable');

      const processedLibrary = calculateLibraryStatus(books, library);
      TableManager.render(processedLibrary, 'libraryTable', true);

      FilterManager.init(processedLibrary);
      FilterManager.setOriginalData(processedLibrary);
      FilterManager.bindSearch('searchLoans', 'loanTable');
      FilterManager.bindSearch('searchLibrary', 'libraryTable');
      bindFilters();
    } catch (error) {
      console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      Toast.show('ğŸš¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
    }
  }

  return { init };
})();

document.addEventListener('DOMContentLoaded', () => {
  LibraryApp.init();
});

window.showBookPreview = (code, title, author) => BookPreviewModal.show(code, title, author);
window.switchTab = (tabName) => BookPreviewModal.switchTab(tabName);
window.closeBookPreview = () => BookPreviewModal.close();
window.showHistory = (code, title) => HistoryModal.show(code, title);
window.closeHistory = () => HistoryModal.close();
window.showDoorayModal = () => DoorayUI.showModal();
window.closeDoorayModal = () => DoorayUI.closeModal();
window.testDoorayConnection = () => DoorayUI.testConnection();
window.syncLibraryToWiki = () => DoorayUI.syncLibrary();
window.sendTestNotification = () => DoorayUI.sendTestNotification();
window.saveDoorayConfig = () => DoorayUI.saveConfig();
window.testDooraySetup = () => DoorayUI.testSetup();
window.clearDoorayConfig = () => DoorayUI.clearConfig();

</script>
</body>
</html>
