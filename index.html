<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ + QR ìƒì„±</title>
<style>
body {
  font-family:'Pretendard','Noto Sans KR',sans-serif;
  background:#f8fafc;margin:0;padding:25px;color:#222;
}
h1{text-align:center;color:#004080;margin-bottom:10px;}
nav{text-align:center;margin-bottom:20px;}
button{
  background:#004080;color:white;border:none;border-radius:8px;
  padding:8px 15px;margin:0 5px;cursor:pointer;font-size:14px;
}
button.active{background:#2563eb;}
button.filter{background:#6b7280;}
button.filter.active{background:#16a34a;}
button.qr-btn{
  background:#0d9488;
  color:white;
  border:none;
  border-radius:6px;
  padding:4px 10px;
  cursor:pointer;
  font-size:13px;
}
input{
  display:block;margin:15px auto 20px;padding:8px 15px;font-size:14px;
  border:1px solid #ccc;border-radius:6px;width:260px;
}
.table-wrap{
  max-height:70vh;overflow:auto;border-radius:8px;background:white;
  box-shadow:0 0 5px rgba(0,0,0,0.08);
}
table{width:100%;border-collapse:collapse;min-width:950px;}
th,td{border:1px solid #e2e8f0;padding:7px 10px;text-align:left;font-size:13.5px;}
th{background:#f1f5f9;color:#004080;position:sticky;top:0;z-index:10;}
tr:nth-child(even){background:#fafafa;}
tr:hover{background:#eef6ff;}
tr.borrowed td{background:#fff8e1;}
.hidden{display:none;}
footer{text-align:center;color:#666;font-size:13px;margin-top:25px;}
</style>
</head>
<body>

<h1>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
<nav>
  <button id="btnLoans" class="active">ğŸ“˜ ëŒ€ì¶œ í˜„í™©</button>
  <button id="btnLibrary">ğŸ“— ì „ì²´ ë„ì„œëª©ë¡</button>
  <button id="btnBorrowed" class="filter">ğŸ“• ëŒ€ì¶œ ì¤‘ ë„ì„œë§Œ ë³´ê¸°</button>
</nav>

<div id="loanSection">
  <input type="text" id="searchLoans" placeholder="ë„ì„œëª…, ëŒ€ì—¬ì, ì½”ë“œë²ˆí˜¸ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="loanTable"></table></div>
</div>

<div id="librarySection" class="hidden">
  <input type="text" id="searchLibrary" placeholder="ì œëª©, ì €ì, ì¶œíŒì‚¬ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="libraryTable"></table></div>
</div>

<footer>Â© ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ | ì‹œìŠ¤í…œ ë¬¸ì˜(ê¹€ì„±ë½ ëŒ€ë¦¬ 417)</footer>

<!-- âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
// âœ… ì„¤ì •ê°’ (Python ì½”ë“œ ë™ì¼)
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdGuoHeUW-37RFCBgMH7ZUNL0tt_yHQiIFMrif85mrV428Omg/viewform";
const ENTRY_IDS = {
  code: "entry.32105598",
  title: "entry.1234176416",
  author: "entry.628826984",
  status: "entry.12641564",
  renter: "entry.615776096"
};

// CSV ë¡œë“œ
async function loadCSV(file){
  const res = await fetch(file+'?v='+Date.now());
  if(!res.ok) throw new Error(file+' ë¡œë“œ ì‹¤íŒ¨');
  const text = await res.text();
  const parsed = Papa.parse(text.trim(), {skipEmptyLines:true});
  return parsed.data;
}

// í‘œ ë Œë”ë§ (QR ë²„íŠ¼ í¬í•¨)
function renderTable(rows, id, withQR=false){
  const header = rows[0];
  const table = document.getElementById(id);
  const finalHeader = withQR ? [...header, 'QR ìƒì„±'] : header;
  table.innerHTML = '<tr>'+finalHeader.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  for(let i=1;i<rows.length;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = rows[i].map(c=>`<td>${c}</td>`).join('');
    if(withQR){
      const code = rows[i].find((_,idx)=>header[idx].replace(/\s/g,'').includes('ì½”ë“œ'));
      const title = rows[i].find((_,idx)=>header[idx].includes('ì œëª©'));
      const author = rows[i].find((_,idx)=>header[idx].includes('ì§€ì€ì´'));
      const status = rows[i].find((_,idx)=>header[idx].includes('ìƒíƒœ')) || '';
      const renter = rows[i].find((_,idx)=>header[idx].includes('ëŒ€ì¶œì')) || '';

      const qrCell = document.createElement('td');
      const qrBtn = document.createElement('button');
      qrBtn.textContent = 'ğŸ“· QR';
      qrBtn.className = 'qr-btn';
      qrBtn.onclick = ()=>generateQR({code, title, author, renter, status});
      qrCell.appendChild(qrBtn);
      tr.appendChild(qrCell);
    }
    table.appendChild(tr);
  }
}

// QR ìƒì„±
function generateQR(row){
  const {code, title, author, renter, status} = row;
  const statusEncoded = {
    "ëŒ€ì¶œ": "%EB%8C%80%EC%B6%9C",
    "ë°˜ë‚©": "%EB%B0%98%EB%82%A9"
  }[status] || "";

  const qrUrl =
    `${FORM_URL}?usp=pp_url` +
    `&${ENTRY_IDS.code}=${encodeURIComponent(code)}` +
    `&${ENTRY_IDS.title}=${encodeURIComponent(title)}` +
    `&${ENTRY_IDS.author}=${encodeURIComponent(author)}` +
    `&${ENTRY_IDS.renter}=${encodeURIComponent(renter)}` +
    `&${ENTRY_IDS.status}=${statusEncoded}`;

  // íŒì—… ë„ìš°ê¸°
  const popup = document.createElement('div');
  popup.style = `
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;
  `;
  popup.innerHTML = `
    <div style="background:white;padding:20px;border-radius:10px;text-align:center;">
      <h3>ğŸ“· QR ì½”ë“œ (${code})</h3>
      <div id="qrcode"></div>
      <p style="margin-top:10px;">
        <a href="${qrUrl}" target="_blank">${qrUrl}</a>
      </p>
      <button id="closePopup" style="margin-top:10px;background:#004080;color:white;padding:5px 10px;border:none;border-radius:6px;">ë‹«ê¸°</button>
      <button id="downloadQR" style="margin-top:10px;background:#2563eb;color:white;padding:5px 10px;border:none;border-radius:6px;">QR ë‹¤ìš´ë¡œë“œ</button>
    </div>`;
  document.body.appendChild(popup);

  // QR ìƒì„±
  const qrDiv = popup.querySelector("#qrcode");
  new QRCode(qrDiv, {
    text: qrUrl,
    width: 200,
    height: 200,
    colorDark: "#000",
    colorLight: "#fff",
    correctLevel: QRCode.CorrectLevel.H
  });

  // ë‹«ê¸° ë²„íŠ¼
  popup.querySelector("#closePopup").onclick = ()=>popup.remove();

  // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
  popup.querySelector("#downloadQR").onclick = ()=>{
    const img = qrDiv.querySelector("img");
    const a = document.createElement("a");
    a.href = img.src;
    a.download = `${code}.png`;
    a.click();
  };
}

// ê²€ìƒ‰
function addSearch(inputId, tableId){
  const input = document.getElementById(inputId);
  let timer;
  input.addEventListener('input', e=>{
    clearTimeout(timer);
    timer = setTimeout(()=>{
      const val = e.target.value.trim();
      const trs = document.querySelectorAll(`#${tableId} tr`);
      for(let i=1;i<trs.length;i++){
        const tr = trs[i];
        const text = tr.textContent;
        tr.style.display = text.includes(val)?'':'none';
      }
    },150);
  });
}

// ì‹¤í–‰
Promise.all([loadCSV('books.csv'), loadCSV('library.csv')]).then(([books, library])=>{
  renderTable(books, 'loanTable');          // ëŒ€ì¶œí˜„í™©
  renderTable(library, 'libraryTable', true); // ë„ì„œëª©ë¡ + QR ë²„íŠ¼
  addSearch('searchLoans','loanTable');
  addSearch('searchLibrary','libraryTable');
});

// íƒ­ ì „í™˜
document.getElementById('btnLoans').onclick = ()=>{
  document.getElementById('loanSection').classList.remove('hidden');
  document.getElementById('librarySection').classList.add('hidden');
  document.getElementById('btnLoans').classList.add('active');
  document.getElementById('btnLibrary').classList.remove('active');
};
document.getElementById('btnLibrary').onclick = ()=>{
  document.getElementById('librarySection').classList.remove('hidden');
  document.getElementById('loanSection').classList.add('hidden');
  document.getElementById('btnLibrary').classList.add('active');
  document.getElementById('btnLoans').classList.remove('active');
};
</script>
</body>
</html>
