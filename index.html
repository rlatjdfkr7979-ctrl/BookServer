<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<style>
body {
  font-family:'Pretendard','Noto Sans KR',sans-serif;
  background:#f8fafc;margin:0;padding:25px;color:#222;
}
h1{text-align:center;color:#004080;margin-bottom:10px;}
nav{text-align:center;margin-bottom:20px;}
button{
  background:#004080;color:white;border:none;border-radius:8px;
  padding:9px 18px;margin:0 5px;cursor:pointer;font-size:15px;
}
button.active{background:#2563eb;}
button.filter{
  background:#6b7280;
}
button.filter.active{
  background:#16a34a;
}
input{
  display:block;margin:15px auto 20px;padding:8px 15px;font-size:14px;
  border:1px solid #ccc;border-radius:6px;width:260px;
}
.table-wrap{
  max-height:70vh;overflow:auto;border-radius:8px;background:white;
  box-shadow:0 0 5px rgba(0,0,0,0.08);
}
table{width:100%;border-collapse:collapse;min-width:900px;}
th,td{border:1px solid #e2e8f0;padding:7px 10px;text-align:left;font-size:13.5px;}
th{
  background:#f1f5f9;color:#004080;position:sticky;top:0;z-index:10;
}
tr:nth-child(even){background:#fafafa;}
tr:hover{background:#eef6ff;}
tr.borrowed td{background:#fff8e1;}
.hidden{display:none;}
footer{text-align:center;color:#666;font-size:13px;margin-top:25px;}
</style>
</head>
<body>

<h1>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
<nav>
  <button id="btnLoans" class="active">ğŸ“˜ ëŒ€ì¶œ í˜„í™©</button>
  <button id="btnLibrary">ğŸ“— ì „ì²´ ë„ì„œëª©ë¡</button>
  <button id="btnBorrowed" class="filter">ğŸ“• ëŒ€ì¶œ ì¤‘ ë„ì„œë§Œ ë³´ê¸°</button>
</nav>

<div id="loanSection">
  <input type="text" id="searchLoans" placeholder="ë„ì„œëª…, ëŒ€ì—¬ì, ì½”ë“œë²ˆí˜¸ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="loanTable"></table></div>
</div>

<div id="librarySection" class="hidden">
  <input type="text" id="searchLibrary" placeholder="ì œëª©, ì €ì, ì¶œíŒì‚¬ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="libraryTable"></table></div>
</div>

<footer>Â© ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ | CSV ê¸°ë°˜ GitHub Pages ë·°ì–´</footer>

<!-- âœ… ì•ˆì •ì  CSV íŒŒì„œ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// CSV ë¡œë“œ
async function loadCSV(file){
  const res = await fetch(file+'?v='+Date.now());
  if(!res.ok) throw new Error(file+' ë¡œë“œ ì‹¤íŒ¨');
  const text = await res.text();
  const parsed = Papa.parse(text.trim(), {skipEmptyLines:true});
  return parsed.data;
}

// í‘œ ë Œë”ë§
function renderTable(rows, id){
  const header = rows[0];
  const table = document.getElementById(id);
  table.innerHTML = '<tr>'+header.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  for(let i=1;i<rows.length;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = rows[i].map(c=>`<td>${c}</td>`).join('');
    table.appendChild(tr);
  }
}

// ê²€ìƒ‰ (ë””ë°”ìš´ì‹±)
function addSearch(inputId, tableId){
  const input = document.getElementById(inputId);
  let timer;
  input.addEventListener('input', e=>{
    clearTimeout(timer);
    timer = setTimeout(()=>{
      const val = e.target.value.trim();
      const trs = document.querySelectorAll(`#${tableId} tr`);
      for(let i=1;i<trs.length;i++){
        const tr = trs[i];
        const text = tr.textContent;
        tr.style.display = text.includes(val)?'':'none';
      }
    },150);
  });
}

// ë©”ì¸ ì‹¤í–‰
Promise.all([loadCSV('books.csv'), loadCSV('library.csv')]).then(([books, library])=>{
  // --- â‘  ëŒ€ì¶œí˜„í™© í‘œ ë Œë”ë§ ---
  renderTable(books, 'loanTable');

  // --- â‘¡ ëŒ€ì¶œí˜„í™© ë§¤í•‘ (ì´ë ¥ ê¸°ë°˜ ìµœì‹  ìƒíƒœ + ìµœê·¼ ë°˜ë‚©ì¼ ê¸°ë¡) ---
  const loanMap = {};
  const bookHeader = books[0];
  const dateIdx = bookHeader.findIndex(h => h.replace(/\s/g,'').includes('ë“±ë¡ì¼'));
  const codeIdx = bookHeader.findIndex(h => h.replace(/\s/g,'').includes('ì½”ë“œ'));
  const statusIdx = bookHeader.findIndex(h => h.replace(/\s/g,'').includes('ìƒíƒœ'));
  const userIdx = bookHeader.findIndex(h => h.replace(/\s/g,'').includes('ëŒ€ì—¬ì'));

  for(let i=1;i<books.length;i++){
    const date = books[i][dateIdx];
    const code = String(books[i][codeIdx] || '').trim();
    const status = (books[i][statusIdx] || '').trim();
    const borrower = (books[i][userIdx] || '').trim();
    if(!code) continue;

    // ë¡œê·¸ ëˆ„ì : ë§ˆì§€ë§‰ ìƒíƒœ + ìµœê·¼ ë°˜ë‚©ì¼ ê¸°ë¡
    if(!loanMap[code]) loanMap[code] = {status:'', borrower:'', lastReturn:''};
    if(status.includes('ë°˜ë‚©')) loanMap[code].lastReturn = date;
    loanMap[code].status = status;
    loanMap[code].borrower = borrower;
  }

  // --- â‘¢ ì „ì²´ ë„ì„œëª©ë¡ ë°˜ì˜ ---
  const libHeader = library[0];
  const libCodeIdx = libHeader.findIndex(h => h.replace(/\s/g,'').includes('ì½”ë“œ'));
  let libStatusIdx = libHeader.findIndex(h => h.replace(/\s/g,'').includes('ëŒ€ì¶œì—¬ë¶€'));
  let libUserIdx = libHeader.findIndex(h => h.replace(/\s/g,'').includes('ëŒ€ì¶œì'));
  let libReturnIdx = libHeader.findIndex(h => h.replace(/\s/g,'').includes('ìµœê·¼ë°˜ë‚©ì¼'));

  // ì»¬ëŸ¼ ì—†ìœ¼ë©´ ì¶”ê°€
  if(libStatusIdx === -1){ libHeader.push('ëŒ€ì¶œì—¬ë¶€'); libStatusIdx = libHeader.length-1; }
  if(libUserIdx === -1){ libHeader.push('ëŒ€ì¶œì'); libUserIdx = libHeader.length-1; }
  if(libReturnIdx === -1){ libHeader.push('ìµœê·¼ë°˜ë‚©ì¼'); libReturnIdx = libHeader.length-1; }

  for(let i=1;i<library.length;i++){
    const code = String(library[i][libCodeIdx] || '').trim();
    const loan = loanMap[code];
    if(!loan){
      library[i][libStatusIdx] = '';
      library[i][libUserIdx] = '';
      library[i][libReturnIdx] = '';
      continue;
    }
    if(loan.status.includes('ë°˜ë‚©')){
      library[i][libStatusIdx] = 'ë°˜ë‚©';
      library[i][libUserIdx] = '';
      library[i][libReturnIdx] = loan.lastReturn || '';
    } else {
      library[i][libStatusIdx] = loan.status || 'ëŒ€ì¶œ';
      library[i][libUserIdx] = loan.borrower || '';
      library[i][libReturnIdx] = loan.lastReturn || '';
    }
  }

  // --- â‘£ ë Œë”ë§ ---
  renderTable(library, 'libraryTable');

  // --- â‘¤ ê²€ìƒ‰ ê¸°ëŠ¥ ì—°ê²° ---
  addSearch('searchLoans','loanTable');
  addSearch('searchLibrary','libraryTable');

  // --- â‘¥ ëŒ€ì¶œ ì¤‘ ë„ì„œë§Œ ë³´ê¸° í•„í„° ---
  const btnFilter = document.getElementById('btnBorrowed');
  let filterActive = false;
  btnFilter.onclick = ()=>{
    filterActive = !filterActive;
    btnFilter.classList.toggle('active', filterActive);
    const trs = document.querySelectorAll('#libraryTable tr');
    const header = library[0];
    const statusIdx = header.findIndex(h => h.replace(/\s/g,'').includes('ëŒ€ì¶œì—¬ë¶€'));
    for(let i=1;i<trs.length;i++){
      const td = trs[i].querySelectorAll('td')[statusIdx];
      const isBorrowed = td && td.textContent.includes('ëŒ€ì¶œ');
      trs[i].style.display = (filterActive && !isBorrowed)?'none':'';
      trs[i].classList.toggle('borrowed', isBorrowed);
    }
  };
});

// íƒ­ ì „í™˜
document.getElementById('btnLoans').onclick = ()=>{
  document.getElementById('loanSection').classList.remove('hidden');
  document.getElementById('librarySection').classList.add('hidden');
  document.getElementById('btnLoans').classList.add('active');
  document.getElementById('btnLibrary').classList.remove('active');
};
document.getElementById('btnLibrary').onclick = ()=>{
  document.getElementById('librarySection').classList.remove('hidden');
  document.getElementById('loanSection').classList.add('hidden');
  document.getElementById('btnLibrary').classList.add('active');
  document.getElementById('btnLoans').classList.remove('active');
};
</script>
</body>
</html>
