<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<style>
  body{font-family:'Pretendard','Noto Sans KR',sans-serif;background:#f8fafc;margin:0;padding:24px;color:#222}
  h1{text-align:center;color:#004080;margin-bottom:10px}
  nav{text-align:center;margin-bottom:16px}
  button{background:#004080;color:#fff;border:none;border-radius:8px;padding:8px 14px;margin:0 6px;cursor:pointer;font-size:14px}
  button.active{background:#2563eb}
  button.filter{background:#6b7280}
  button.filter.active{background:#16a34a}
  button.qr-btn{background:#0d9488;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:13px}
  input{display:block;margin:12px auto 16px;padding:8px 14px;font-size:14px;border:1px solid #cbd5e1;border-radius:6px;width:260px}
  .table-wrap{max-height:70vh;overflow:auto;border-radius:8px;background:#fff;box-shadow:0 0 5px rgba(0,0,0,.08)}
  table{width:100%;border-collapse:collapse;min-width:960px}
  th,td{border:1px solid #e2e8f0;padding:7px 10px;text-align:left;font-size:13.5px}
  th{background:#f1f5f9;color:#004080;position:sticky;top:0;z-index:10}
  tr:nth-child(even){background:#fafafa}
  tr:hover{background:#eef6ff}
  tr.borrowed td{background:#fff8e1} /* ëŒ€ì¶œ ì¤‘ - ë…¸ë€ìƒ‰ */
  tr.overdue td{background:#fee2e2 !important;} /* ì—°ì²´ - ë¹¨ê°„ìƒ‰ */
  .hidden{display:none}
  footer{text-align:center;color:#667085;font-size:13px;margin-top:18px}
  #historyModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;}
  #historyModal .inner{background:#fff;border-radius:10px;max-width:800px;width:95%;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);}
  #historyModal .content{padding:24px;overflow:auto;flex:1;}
  #historyModal .buttons{padding:16px 24px;border-top:1px solid #e2e8f0;background:#fff;border-radius:0 0 10px 10px;position:sticky;bottom:0;}
  #historyModal h3{margin:0 0 16px 0;font-size:18px;color:#004080;border-bottom:2px solid #e2e8f0;padding-bottom:8px;}
  #historyModal table{font-size:14px !important;min-width:auto !important;table-layout:fixed;width:100%;}
  #historyModal th{background:#f8fafc;padding:10px 12px;font-weight:600;word-wrap:break-word;}
  #historyModal td{padding:10px 12px;word-wrap:break-word;overflow-wrap:break-word;}
  #historyModal th:first-child, #historyModal td:first-child{width:30%;}
  #historyModal th:nth-child(2), #historyModal td:nth-child(2){width:25%;}
  #historyModal th:last-child, #historyModal td:last-child{width:45%;}
  
  /* ë„ì„œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  #bookPreviewModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;}
  #bookPreviewModal .inner{background:#fff;border-radius:12px;max-width:600px;width:95%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);}
  #bookPreviewModal .content{padding:24px;overflow:auto;flex:1;}
  #bookPreviewModal .buttons{padding:16px 24px;border-top:1px solid #e2e8f0;background:#fff;border-radius:0 0 12px 12px;position:sticky;bottom:0;}
  #bookPreviewModal .book-header{display:flex;gap:20px;margin-bottom:20px;}
  #bookPreviewModal .book-cover{flex-shrink:0;}
  #bookPreviewModal .book-cover img{width:120px;height:auto;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.1);border:1px solid #e2e8f0;}
  #bookPreviewModal .book-info{flex:1;min-width:0;}
  #bookPreviewModal .book-title{font-size:20px;font-weight:700;color:#1f2937;margin:0 0 8px 0;line-height:1.3;}
  #bookPreviewModal .book-author{color:#6b7280;font-size:16px;margin:0 0 6px 0;}
  #bookPreviewModal .book-publisher{color:#9ca3af;font-size:14px;margin:0 0 12px 0;}
  #bookPreviewModal .book-rating{display:flex;align-items:center;gap:8px;margin:8px 0;}
  #bookPreviewModal .stars{color:#fbbf24;}
  #bookPreviewModal .book-description{color:#4b5563;font-size:14px;line-height:1.6;margin-top:20px;}
  #bookPreviewModal .book-meta{background:#f8fafc;border-radius:8px;padding:16px;margin-top:16px;}
  #bookPreviewModal .book-meta .meta-item{display:flex;justify-content:space-between;margin:4px 0;font-size:13px;}
  #bookPreviewModal .book-meta .meta-label{color:#6b7280;font-weight:500;}
  #bookPreviewModal .book-meta .meta-value{color:#1f2937;}
  #bookPreviewModal .loading{text-align:center;padding:40px;color:#6b7280;}
  #bookPreviewModal .error{text-align:center;padding:40px;color:#dc2626;}
  #bookPreviewModal .tab-buttons{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid #e2e8f0;}
  #bookPreviewModal .tab-button{background:none;border:none;padding:8px 16px;cursor:pointer;color:#6b7280;font-size:14px;border-bottom:2px solid transparent;}
  #bookPreviewModal .tab-button.active{color:#2563eb;border-bottom-color:#2563eb;font-weight:600;}
  #bookPreviewModal .tab-content{display:none;}
  #bookPreviewModal .tab-content.active{display:block;}
  
  /* Dooray ì—°ë™ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  #doorayModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1001;}
  #doorayModal .inner{background:#fff;border-radius:12px;max-width:600px;width:95%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);}
  #doorayModal .content{padding:24px;overflow:auto;flex:1;}
  #doorayModal .buttons{padding:16px 24px;border-top:1px solid #e2e8f0;background:#fff;border-radius:0 0 12px 12px;}
  #doorayModal h3{margin:0 0 16px 0;color:#1f2937;font-size:20px;}
  #doorayModal .status-card{background:#f8fafc;border-radius:8px;padding:16px;margin:12px 0;border-left:4px solid #6366f1;}
  #doorayModal .status-success{border-left-color:#10b981;background:#ecfdf5;}
  #doorayModal .status-error{border-left-color:#ef4444;background:#fef2f2;}
  #doorayModal .status-warning{border-left-color:#f59e0b;background:#fffbeb;}
  #doorayModal .feature-list{list-style:none;padding:0;margin:16px 0;}
  #doorayModal .feature-list li{padding:8px 0;display:flex;align-items:center;gap:8px;}
  #doorayModal .feature-list li::before{content:'âœ…';margin-right:8px;}
  #doorayModal .test-result{margin:16px 0;padding:12px;border-radius:6px;font-family:monospace;font-size:13px;}
  #doorayModal .action-button{background:#6366f1;color:#fff;border:none;border-radius:6px;padding:8px 16px;margin:4px;cursor:pointer;}
  #doorayModal .action-button:hover{background:#4f46e5;}
  #doorayModal .action-button:disabled{background:#9ca3af;cursor:not-allowed;}
  
  /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
  .pagination{text-align:center;margin:16px 0;padding:12px;}
  .pagination button{background:#f8fafc;color:#374151;border:1px solid #d1d5db;border-radius:6px;padding:8px 12px;margin:0 2px;cursor:pointer;font-size:14px;min-width:40px;}
  .pagination button:hover{background:#e5e7eb;}
  .pagination button.active{background:#2563eb;color:#fff;border-color:#2563eb;}
  .pagination button:disabled{background:#f3f4f6;color:#9ca3af;cursor:not-allowed;}
  .pagination .page-info{display:inline-block;margin:0 12px;color:#6b7280;font-size:14px;}
</style>
</head>
<body>

<h1>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
<nav>
  <button id="btnLibrary" class="active">ğŸ“— ì „ì²´ ë„ì„œëª©ë¡</button>
  <button id="btnBorrowed" class="filter">ğŸ“• ëŒ€ì¶œ ì¤‘ ë„ì„œë§Œ ë³´ê¸°</button>
  <button id="btnNewest" class="filter" style="background:#7c3aed;">ğŸ“ˆ ìµœì‹  ë„ì„œ ìˆœìœ¼ë¡œ ë³´ê¸°</button>
  <button id="btnRecent" style="background:#15803d;">ğŸ†• ìµœê·¼ 30ì¼ ë„ì„œë§Œ ë³´ê¸°</button>
  <button id="btnLoans">ğŸ“˜ ëŒ€ì¶œ í˜„í™©</button>
  <button id="btnAddBook" style="background:#059669;">â• ë„ì„œ ì¶”ê°€</button>
  <button id="btnDooraySync" style="background:#7c3aed;">ğŸ”„ Dooray ì—°ë™</button>
</nav>

<div id="librarySection">
  <input type="text" id="searchLibrary" placeholder="ì œëª©/ë„ì„œëª…, ì €ì, ì¶œíŒì‚¬ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="libraryTable"></table></div>
  <div id="libraryPagination" class="pagination"></div>
</div>

<div id="loanSection" class="hidden">
  <input type="text" id="searchLoans" placeholder="ë„ì„œëª…, ëŒ€ì—¬ì, ì½”ë“œë²ˆí˜¸ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="loanTable"></table></div>
  <div id="loanPagination" class="pagination"></div>
</div>

<!-- ë„ì„œ ì´ë ¥ íŒì—… -->
<div id="historyModal">
  <div class="inner">
    <div class="content">
      <h3 id="histTitle">ğŸ“– ë„ì„œ ì´ë ¥</h3>
      <div id="histContent"></div>
    </div>
    <div class="buttons">
      <button onclick="closeHistory()" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ë„ì„œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div id="bookPreviewModal">
  <div class="inner">
    <div class="content">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('preview')">ğŸ“š ë„ì„œ ì •ë³´</button>
        <button class="tab-button" onclick="switchTab('history')">ğŸ“‹ ëŒ€ì¶œ ì´ë ¥</button>
      </div>
      
      <div id="previewTab" class="tab-content active">
        <div id="bookPreviewContent">
          <div class="loading">ğŸ“š ë„ì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
      
      <div id="historyTab" class="tab-content">
        <div id="bookHistoryContent"></div>
      </div>
    </div>
    <div class="buttons">
      <button onclick="closeBookPreview()" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Dooray ì—°ë™ ëª¨ë‹¬ -->
<div id="doorayModal">
  <div class="inner">
    <div class="content">
      <h3>ğŸ”„ Dooray ì—°ë™ ê´€ë¦¬</h3>
      
      <div id="doorayStatus" class="status-card">
        <strong>ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...</strong>
      </div>
      
      <div id="doorayFeatures" style="display:none;">
        <h4>ğŸ¯ ì‚¬ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥</h4>
        <ul class="feature-list">
          <li>ğŸ“Š ë„ì„œ í˜„í™©ì„ Dooray Wikiì— ìë™ ì—…ë°ì´íŠ¸</li>
          <li>ğŸ’¬ ë„ì„œ ëŒ€ì¶œ/ë°˜ë‚© ì‹œ ë©”ì‹ ì € ì•Œë¦¼ ì „ì†¡</li>
          <li>âš ï¸ ì—°ì²´ ë„ì„œ ìë™ ì•Œë¦¼</li>
          <li>ğŸ“ˆ ì‹¤ì‹œê°„ í†µê³„ ì •ë³´ ë™ê¸°í™”</li>
        </ul>
        
        <h4>ğŸ› ï¸ ì—°ë™ ì‘ì—…</h4>
        <div style="margin:12px 0;">
          <button class="action-button" onclick="testDoorayConnection()">ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸</button>
          <button class="action-button" onclick="syncLibraryToWiki()">ğŸ“Š Wiki ì—…ë°ì´íŠ¸</button>
          <button class="action-button" onclick="sendTestNotification()">ğŸ’¬ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div id="doorayTestResult" class="test-result" style="display:none;"></div>
      </div>
      
      <div id="dooraySetup" style="display:none;">
        <h4>âš™ï¸ Google Apps Script ë°±ì—”ë“œ ì„¤ì •</h4>
        <div style="margin:16px 0;">
          <label style="display:block;margin:8px 0;color:#374151;font-weight:500;">ğŸŒ ë°±ì—”ë“œ URL:</label>
          <input type="url" id="gasBackendUrl" placeholder="https://script.google.com/macros/s/.../exec" 
                 style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
          
          <label style="display:block;margin:8px 0;color:#374151;font-weight:500;">ğŸ“ Wiki ID:</label>
          <input type="text" id="doorayWikiId" placeholder="Dooray Wiki ID (ì˜ˆ: 3971855165716167130)" 
                 style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
          
          <label style="display:block;margin:8px 0;color:#374151;font-weight:500;">ğŸ“„ Page ID:</label>
          <input type="text" id="doorayPageId" placeholder="Wiki Page ID (ì˜ˆ: 4185119590638689477)" 
                 style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
          
          <div style="margin:16px 0;padding:12px;background:#e0f2fe;border-radius:6px;font-size:13px;color:#0277bd;border-left:4px solid #0288d1;">
            ï¿½ <strong>Google Apps Script ë°±ì—”ë“œ ì„¤ì •:</strong><br>
            1. library-gas-backend.jsë¥¼ Google Apps Scriptì— ë³µì‚¬<br>
            2. ì‹¤ì œ Dooray API í† í°ìœ¼ë¡œ êµì²´<br>
            3. ì›¹ì•±ìœ¼ë¡œ ë°°í¬ í›„ URL ë³µì‚¬<br>
            4. ìœ„ ë°±ì—”ë“œ URL í•„ë“œì— ì…ë ¥
          </div>
          
          <div style="margin:16px 0;padding:12px;background:#f3f4f6;border-radius:6px;font-size:13px;color:#6b7280;">
            ğŸ’¡ <strong>ì •ë³´ í™•ì¸ ë°©ë²•:</strong><br>
            â€¢ Wiki ID: ë‘ë ˆì´.jsì˜ WIKI_ID ê°’ (3971855165716167130)<br>
            â€¢ Page ID: ë‘ë ˆì´.jsì˜ PAGE_ID ê°’ (4185119590638689477)<br>
            â€¢ ë˜ëŠ” Wiki URL: https://dooray.com/.../wikis/<strong>WIKI_ID</strong>/pages/<strong>PAGE_ID</strong>
          </div>
          
          <button onclick="saveDoorayConfig()" class="action-button" style="width:100%;margin-top:12px;">
            ğŸ’¾ ì„¤ì • ì €ì¥ ë° ì—°ê²° í…ŒìŠ¤íŠ¸
          </button>
          <button onclick="testDooraySetup()" style="background:#6b7280;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;margin-top:8px;cursor:pointer;">
            ğŸ§ª ì„¤ì • ìƒíƒœ í…ŒìŠ¤íŠ¸
          </button>
          <button onclick="clearDoorayConfig()" style="background:#dc2626;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;margin-top:8px;cursor:pointer;">
            ğŸ—‘ï¸ ì„¤ì • ì´ˆê¸°í™”
          </button>
        </div>
      </div>
    </div>
    <div class="buttons">
      <button onclick="closeDoorayModal()" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:8px 16px;width:100%;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<footer>Â© ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ | ì‹œìŠ¤í…œ ë¬¸ì˜(ê¹€ì„±ë½ ëŒ€ë¦¬ 417)</footer>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<!-- Dooray ì—°ë™ ì„¤ì • -->
<script>
// ğŸ”§ ëŸ°íƒ€ì„ ì„¤ì • - Google Apps Script ë°±ì—”ë“œ ë°©ì‹
window.DOORAY_CONFIG = {
  wikiId: localStorage.getItem('dooray_wiki_id') || '',
  pageId: localStorage.getItem('dooray_page_id') || '',
  backendUrl: localStorage.getItem('gas_backend_url') || '',
  settings: {
    enableMessaging: true,
    enableWikiUpdate: true,
    debug: false
  }
};

// API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
window.DOORAY_ENDPOINTS = {
  wiki: {
    get: (projectId, postId) => `${window.DOORAY_CONFIG.baseUrl}/v1/projects/${projectId}/posts/${postId}`,
    update: (projectId, postId) => `${window.DOORAY_CONFIG.baseUrl}/v1/projects/${projectId}/posts/${postId}`
  },
  messenger: {
    send: (channelId) => `${window.DOORAY_CONFIG.baseUrl}/v1/channels/${channelId}/logs`
  }
};

// ğŸš€ Dooray API ì—°ë™ ëª¨ë“ˆ (í†µí•© ë²„ì „)
class DoorayIntegration {
  constructor() {
    this.config = window.DOORAY_CONFIG || null;
    this.isEnabled = this.config && this.config.wikiId && this.config.pageId && localStorage.getItem('gas_backend_url');
    
    if (!this.isEnabled) {
      console.warn('ğŸ”§ Dooray ì—°ë™ì´ ë¹„í™œì„±í™”ë¨: Google Apps Script ë°±ì—”ë“œ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”');
    }
  }

  // ğŸ“¡ Google Apps Script ë°±ì—”ë“œë¥¼ í†µí•œ API ìš”ì²­ (JSONP ë°©ì‹ìœ¼ë¡œ CORS ìš°íšŒ)
  makeApiRequest(action, additionalParams = {}) {
    if (!this.isEnabled) {
      console.warn('âš ï¸ Dooray APIê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
      return Promise.resolve(null);
    }

    // Google Apps Script ì›¹ì•± URL (ì‚¬ìš©ìê°€ ì„¤ì •í•´ì•¼ í•¨)
    const GAS_BACKEND_URL = localStorage.getItem('gas_backend_url') || '';
    
    if (!GAS_BACKEND_URL) {
      return Promise.reject(new Error('Google Apps Script ë°±ì—”ë“œ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'));
    }

    return new Promise((resolve, reject) => {
      // JSONP ì½œë°± í•¨ìˆ˜ëª… ìƒì„±
      const callbackName = 'jsonp_callback_' + Date.now();
      
      // ê¸€ë¡œë²Œ ì½œë°± í•¨ìˆ˜ ë“±ë¡
      window[callbackName] = function(data) {
        // ì½œë°± ì •ë¦¬
        delete window[callbackName];
        document.head.removeChild(script);
        
        if (data.error) {
          reject(new Error(data.error));
        } else {
          resolve(data);
        }
      };
      
      // ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ë¡œ JSONP ìš”ì²­
      const script = document.createElement('script');
      const params = new URLSearchParams({
        action: action,
        wikiId: this.config.wikiId,
        pageId: this.config.pageId,
        callback: callbackName,
        ...additionalParams
      });
      
      script.src = `${GAS_BACKEND_URL}?${params}`;
      script.onerror = function() {
        delete window[callbackName];
        document.head.removeChild(script);
        reject(new Error('Google Apps Script ìš”ì²­ ì‹¤íŒ¨'));
      };
      
      document.head.appendChild(script);
      
      // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
      setTimeout(() => {
        if (window[callbackName]) {
          delete window[callbackName];
          document.head.removeChild(script);
          reject(new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼'));
        }
      }, 30000);
    });
  }

  // ğŸ“Š Wiki ì—…ë°ì´íŠ¸ - ë„ì„œ í˜„í™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ Wikiì— ë°˜ì˜
  async updateLibraryStatusToWiki(libraryData) {
    if (!this.isEnabled || !this.config.settings.enableWikiUpdate) {
      return false;
    }

    try {
      const { projectId, postId } = this.config;
      const getUrl = window.DOORAY_ENDPOINTS.wiki.get(projectId, postId);
      
      // 1. ê¸°ì¡´ Wiki ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
      const existingData = await this.makeApiRequest(getUrl);
      if (!existingData) return false;

      // 2. ë„ì„œ í˜„í™© í‘œ ìƒì„±
      const libraryTable = this.generateLibraryTable(libraryData);
      
      // 3. Wiki ë‚´ìš© ì—…ë°ì´íŠ¸
      const updatedContent = this.updateWikiContent(
        existingData.result.body.content, 
        libraryTable
      );

      // 4. Wiki ì €ì¥
      const updateUrl = window.DOORAY_ENDPOINTS.wiki.update(projectId, postId);
      const updateData = {
        body: {
          content: updatedContent,
          mimeType: 'text/x-markdown'
        }
      };

      const result = await this.makeApiRequest(updateUrl, 'PUT', updateData);
      
      if (result) {
        console.log('âœ… Dooray Wiki ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        return true;
      }
    } catch (error) {
      console.error('ğŸš¨ Wiki ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    }
    
    return false;
  }

  // ğŸ“‹ ë„ì„œ í˜„í™© í…Œì´ë¸” ìƒì„± (ë§ˆí¬ë‹¤ìš´ í˜•ì‹)
  generateLibraryTable(libraryData) {
    if (!libraryData || libraryData.length === 0) {
      return 'ë„ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
    }

    // í†µê³„ ê³„ì‚°
    const totalBooks = libraryData.length - 1; // í—¤ë” ì œì™¸
    const borrowedBooks = libraryData.slice(1).filter(row => {
      const status = row[row.length - 2] || ''; // ìƒíƒœ ì»¬ëŸ¼
      return status.includes('ëŒ€ì¶œ') || status.includes('ì—°ì²´');
    }).length;
    const availableBooks = totalBooks - borrowedBooks;

    const now = new Date();
    const koreanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
    const updateTime = koreanTime.toLocaleString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });

    // ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ìƒì„±
    let markdown = `## ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ í˜„í™©\n\n`;
    markdown += `**ğŸ“Š í†µê³„ ì •ë³´**\n`;
    markdown += `- ğŸ“— ì´ ë„ì„œ: ${totalBooks}ê¶Œ\n`;
    markdown += `- ğŸ“• ëŒ€ì¶œì¤‘: ${borrowedBooks}ê¶Œ\n`;
    markdown += `- ğŸ“˜ ëŒ€ì¶œê°€ëŠ¥: ${availableBooks}ê¶Œ\n`;
    markdown += `- ğŸ• ì—…ë°ì´íŠ¸: ${updateTime}\n\n`;

    // ëŒ€ì¶œ ì¤‘ì¸ ë„ì„œë§Œ í‘œì‹œ
    if (borrowedBooks > 0) {
      markdown += `**ğŸ“• í˜„ì¬ ëŒ€ì¶œ ì¤‘ì¸ ë„ì„œ**\n\n`;
      markdown += `| ë„ì„œëª… | ì €ì | ëŒ€ì¶œì | ìƒíƒœ |\n`;
      markdown += `|--------|------|--------|------|\n`;

      for (let i = 1; i < libraryData.length; i++) {
        const row = libraryData[i];
        const status = row[row.length - 2] || '';
        
        if (status.includes('ëŒ€ì¶œ') || status.includes('ì—°ì²´')) {
          const title = row[2] || 'ì œëª©ì—†ìŒ'; // ë„ì„œëª…
          const author = row[3] || 'ì €ìë¯¸ìƒ'; // ì €ì
          const borrower = row[row.length - 1] || 'ëŒ€ì¶œìë¯¸ìƒ'; // ëŒ€ì¶œì
          
          markdown += `| ${title} | ${author} | ${borrower} | ${status} |\n`;
        }
      }
    } else {
      markdown += `**âœ… í˜„ì¬ ëª¨ë“  ë„ì„œê°€ ë°˜ë‚©ëœ ìƒíƒœì…ë‹ˆë‹¤.**\n`;
    }

    return markdown;
  }

  // ğŸ“ Wiki ë‚´ìš©ì—ì„œ ë„ì„œ í˜„í™© ë¶€ë¶„ ì—…ë°ì´íŠ¸
  updateWikiContent(existingContent, newTable) {
    const startMarker = '<!-- LIBRARY_STATUS_START -->';
    const endMarker = '<!-- LIBRARY_STATUS_END -->';
    
    const hasMarkers = existingContent.includes(startMarker) && existingContent.includes(endMarker);
    
    if (hasMarkers) {
      // ê¸°ì¡´ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë¶€ë¶„ë§Œ êµì²´
      const beforeStart = existingContent.split(startMarker)[0];
      const afterEnd = existingContent.split(endMarker)[1];
      
      return `${beforeStart}${startMarker}\n${newTable}\n${endMarker}${afterEnd}`;
    } else {
      // ë§ˆì»¤ê°€ ì—†ìœ¼ë©´ ë‚´ìš© ëì— ì¶”ê°€
      return `${existingContent}\n\n${startMarker}\n${newTable}\n${endMarker}`;
    }
  }

  // ğŸ’¬ ë©”ì‹ ì € ì•Œë¦¼ ì „ì†¡
  async sendNotification(message, channelId = null) {
    if (!this.isEnabled || !this.config.settings.enableMessaging) {
      console.log('ğŸ“¢ ì•Œë¦¼ (Dooray ë¹„í™œì„±í™”):', message);
      return false;
    }

    // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” channelIdë¥¼ ì„¤ì •ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì•¼ í•¨
    if (!channelId) {
      console.warn('âš ï¸ ë©”ì‹ ì € ì±„ë„ IDê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
      return false;
    }

    try {
      const url = window.DOORAY_ENDPOINTS.messenger.send(channelId);
      const data = {
        text: message,
        botName: 'ğŸ“š ë„ì„œê´€ë¦¬ë´‡'
      };

      const result = await this.makeApiRequest(url, 'POST', data);
      
      if (result) {
        console.log('âœ… Dooray ë©”ì‹ ì € ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ');
        return true;
      }
    } catch (error) {
      console.error('ğŸš¨ ë©”ì‹ ì € ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error);
    }
    
    return false;
  }

  // ğŸ”” ë„ì„œ ëŒ€ì¶œ/ë°˜ë‚© ì•Œë¦¼
  async notifyBookAction(action, bookInfo) {
    const { title, author, borrower, code } = bookInfo;
    let message = '';

    switch (action) {
      case 'borrow':
        message = `ğŸ“• **ë„ì„œ ëŒ€ì¶œ ì•Œë¦¼**\n` +
                 `â€¢ ë„ì„œ: ${title}\n` +
                 `â€¢ ì €ì: ${author}\n` +
                 `â€¢ ëŒ€ì¶œì: ${borrower}\n` +
                 `â€¢ ì½”ë“œ: ${code}\n` +
                 `â€¢ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}`;
        break;
        
      case 'return':
        message = `ğŸ“— **ë„ì„œ ë°˜ë‚© ì•Œë¦¼**\n` +
                 `â€¢ ë„ì„œ: ${title}\n` +
                 `â€¢ ì €ì: ${author}\n` +
                 `â€¢ ë°˜ë‚©ì: ${borrower}\n` +
                 `â€¢ ì½”ë“œ: ${code}\n` +
                 `â€¢ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}`;
        break;
        
      case 'overdue':
        message = `âš ï¸ **ì—°ì²´ ë„ì„œ ì•Œë¦¼**\n` +
                 `â€¢ ë„ì„œ: ${title}\n` +
                 `â€¢ ì €ì: ${author}\n` +
                 `â€¢ ëŒ€ì¶œì: ${borrower}\n` +
                 `â€¢ ì½”ë“œ: ${code}\n` +
                 `â€¢ ìƒíƒœ: ë°˜ë‚© ê¸°í•œ ì´ˆê³¼`;
        break;
    }

    return await this.sendNotification(message);
  }

  // ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸
  async testConnection() {
    if (!this.isEnabled) {
      return {
        success: false,
        message: 'Dooray ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸/í¬ìŠ¤íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.'
      };
    }

    try {
      const result = await this.makeApiRequest('test');
      
      if (result.success) {
        return {
          success: true,
          message: result.message,
          data: result.data
        };
      } else {
        return {
          success: false,
          message: result.message || 'Google Apps Script ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨'
        };
      }
    } catch (error) {
      let errorMessage = `ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`;
      
      if (error.message.includes('ë°±ì—”ë“œ URL')) {
        errorMessage += `

ğŸ”§ Google Apps Script ë°±ì—”ë“œ ì„¤ì • ë°©ë²•:
1. library-gas-backend.js íŒŒì¼ì„ Google Apps Scriptì— ë°°í¬
2. ì›¹ì•±ìœ¼ë¡œ ë°°í¬ í›„ URL ë³µì‚¬
3. ì•„ë˜ ë°±ì—”ë“œ URL ì„¤ì •ì— ì…ë ¥`;
      }
      
      return {
        success: false,
        message: errorMessage
      };
    }
  }
}

// ğŸŒ ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
window.doorayIntegration = new DoorayIntegration();
</script>

<script>
/* ====== 0) í™˜ê²½ ì„¤ì • ====== */
const FORM_URL="https://docs.google.com/forms/d/e/1FAIpQLSdGuoHeUW-37RFCBgMH7ZUNL0tt_yHQiIFMrif85mrV428Omg/viewform";
const ENTRY_IDS={code:"entry.32105598",title:"entry.1234176416",author:"entry.628826984",status:"entry.12641564",renter:"entry.615776096"};

/* ====== ìœ í‹¸ ====== */
const norm=s=>String(s||'').replace(/\uFEFF/g,'').trim();
const normHead=s=>norm(s).replace(/\s/g,'');
const includesAny=(h,keys)=>keys.some(k=>normHead(h).includes(k));
function findColIndex(header,candidates){return header.findIndex(h=>includesAny(h,candidates));}

/* ====== í˜ì´ì§€ë„¤ì´ì…˜ ====== */
const ITEMS_PER_PAGE = 20; // í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜
let currentPage = {loanTable: 1, libraryTable: 1};
let totalPages = {loanTable: 1, libraryTable: 1};
let allTableData = {loanTable: [], libraryTable: []};

function createPagination(tableId, paginationId, totalItems) {
  const pagination = document.getElementById(paginationId);
  const pages = Math.ceil(totalItems / ITEMS_PER_PAGE);
  totalPages[tableId] = pages;
  
  if (pages <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  const current = currentPage[tableId];
  let html = '';
  
  // ì´ì „ ë²„íŠ¼
  html += `<button onclick="changePage('${tableId}', '${paginationId}', ${current - 1})" ${current === 1 ? 'disabled' : ''}>â€¹ ì´ì „</button>`;
  
  // í˜ì´ì§€ ë²ˆí˜¸ë“¤
  let startPage = Math.max(1, current - 2);
  let endPage = Math.min(pages, current + 2);
  
  if (startPage > 1) {
    html += `<button onclick="changePage('${tableId}', '${paginationId}', 1)">1</button>`;
    if (startPage > 2) html += '<span>...</span>';
  }
  
  for (let i = startPage; i <= endPage; i++) {
    html += `<button onclick="changePage('${tableId}', '${paginationId}', ${i})" ${i === current ? 'class="active"' : ''}>${i}</button>`;
  }
  
  if (endPage < pages) {
    if (endPage < pages - 1) html += '<span>...</span>';
    html += `<button onclick="changePage('${tableId}', '${paginationId}', ${pages})">${pages}</button>`;
  }
  
  // ë‹¤ìŒ ë²„íŠ¼
  html += `<button onclick="changePage('${tableId}', '${paginationId}', ${current + 1})" ${current === pages ? 'disabled' : ''}>ë‹¤ìŒ â€º</button>`;
  
  // í˜ì´ì§€ ì •ë³´
  html += `<span class="page-info">${current} / ${pages} í˜ì´ì§€ (ì´ ${totalItems}ê°œ)</span>`;
  
  pagination.innerHTML = html;
}

function changePage(tableId, paginationId, page) {
  const pages = totalPages[tableId];
  if (page < 1 || page > pages) return;
  
  currentPage[tableId] = page;
  renderTableWithPagination(allTableData[tableId], tableId, tableId === 'libraryTable');
  createPagination(tableId, paginationId, allTableData[tableId].length - 1); // í—¤ë” ì œì™¸
  
  // í…Œì´ë¸” ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™
  const tableWrap = document.querySelector(`#${tableId === 'loanTable' ? 'loanSection' : 'librarySection'} .table-wrap`);
  if (tableWrap) tableWrap.scrollTop = 0;
}

/* ====== CSV ë¡œë“œ ====== */
async function loadCSV(file){
  const res=await fetch(file+'?v='+Date.now());
  if(!res.ok) throw new Error(file+' ë¡œë“œ ì‹¤íŒ¨');
  const text=await res.text();
  return Papa.parse(text.trim(),{skipEmptyLines:true}).data;
}

/* ====== QR ìƒì„± ====== */
function generateQR({code,title,author,renter,status}){
  // ìƒíƒœì— ë”°ë¥¸ ë¼ë””ì˜¤ë°•ìŠ¤ ì„ íƒ ë¡œì§ ê°œì„ 
  let statusEncoded = "";
  if(status.includes('ë°˜ë‚©')){
    statusEncoded = "%EB%B0%98%EB%82%A9"; // ë°˜ë‚©
  } else if(status.includes('ëŒ€ì¶œ') || status.includes('ëŒ€ì—¬') || status.includes('ì—°ì²´')){
    statusEncoded = "%EB%8C%80%EC%B6%9C"; // ëŒ€ì¶œ (ì—°ì²´ í¬í•¨)
  }
  
  const url=`${FORM_URL}?usp=pp_url&${ENTRY_IDS.code}=${encodeURIComponent(code)}&${ENTRY_IDS.title}=${encodeURIComponent(title)}&${ENTRY_IDS.author}=${encodeURIComponent(author)}&${ENTRY_IDS.renter}=${encodeURIComponent(renter)}&${ENTRY_IDS.status}=${statusEncoded}`;
  const layer=document.createElement('div');
  layer.style=`position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;`;
  layer.innerHTML=`<div style="background:#fff;padding:18px 22px;border-radius:10px;text-align:center;max-width:420px"><h3 style="margin:6px 0 12px">ğŸ“· QR ì½”ë“œ (${code})</h3><div id="qrbox" style="margin:0 auto 10px;width:220px;height:220px"></div><p style="word-break:break-all;font-size:12px;"><a href="${url}" target="_blank">${url}</a></p><div style="margin-top:10px"><button id="qrClose" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:6px 10px;margin-right:6px">ë‹«ê¸°</button><button id="qrDown"  style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px">QR ë‹¤ìš´ë¡œë“œ</button></div></div>`;
  document.body.appendChild(layer);
  new QRCode(layer.querySelector('#qrbox'),{text:url,width:220,height:220,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.H});
  layer.querySelector('#qrClose').onclick=()=>layer.remove();
  layer.querySelector('#qrDown').onclick=()=>{const img=layer.querySelector('#qrbox img');const a=document.createElement('a');a.href=img.src;a.download=`${code}.png`;a.click();};
}

/* ====== í‘œ ë Œë”ë§ ====== */
function renderTable(rows,id,withQR=false){
  // ì „ì²´ ë°ì´í„° ì €ì¥
  allTableData[id] = [...rows];
  renderTableWithPagination(rows, id, withQR);
  
  // í˜ì´ì§€ë„¤ì´ì…˜ ìƒì„±
  const paginationId = id === 'loanTable' ? 'loanPagination' : 'libraryPagination';
  createPagination(id, paginationId, rows.length - 1); // í—¤ë” ì œì™¸
}

function renderTableWithPagination(rows,id,withQR=false){
  const header=rows[0];
  const table=document.getElementById(id);
  const finalHeader=withQR?[...header,'QR ìƒì„±']:header;
  
  // í˜„ì¬ í˜ì´ì§€ì˜ ë°ì´í„° ê³„ì‚°
  const page = currentPage[id];
  const startIdx = (page - 1) * ITEMS_PER_PAGE + 1; // í—¤ë” ì œì™¸í•˜ê³  ì‹œì‘
  const endIdx = Math.min(startIdx + ITEMS_PER_PAGE - 1, rows.length - 1);
  
  // í—¤ë” ìƒì„± (ì •ë ¬ ê¸°ëŠ¥ í¬í•¨)
  const headerRow=document.createElement('tr');
  finalHeader.forEach((h,idx)=>{
    const th=document.createElement('th');
    th.textContent=h;
    
    // QR ìƒì„± ì—´ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì •ë ¬ ê¸°ëŠ¥ ì¶”ê°€
    if(idx<header.length){
      th.style.cursor='pointer';
      th.style.userSelect='none';
      th.onclick=()=>sortTable(rows,id,idx,withQR);
      
      // ì •ë ¬ í‘œì‹œë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼
      th.addEventListener('mouseenter',()=>{
        if(!th.textContent.includes('â†‘')&&!th.textContent.includes('â†“')){
          th.style.background='#e2e8f0';
        }
      });
      th.addEventListener('mouseleave',()=>{
        if(!th.textContent.includes('â†‘')&&!th.textContent.includes('â†“')){
          th.style.background='#f1f5f9';
        }
      });
    }
    headerRow.appendChild(th);
  });
  
  table.innerHTML='';
  table.appendChild(headerRow);
  
  // í˜„ì¬ í˜ì´ì§€ì˜ í–‰ë“¤ë§Œ ë Œë”ë§
  for(let i=startIdx;i<=endIdx;i++){
    if (i >= rows.length) break;
    
    const tr=document.createElement('tr');
    tr.innerHTML=rows[i].map((c,j)=>`<td>${c}</td>`).join('');
    
    // ì œëª© í´ë¦­ ì‹œ ì´ë ¥ ë³´ê¸°
    if(withQR){
      const titleIdx=findColIndex(header,['ì œëª©','ë„ì„œëª…']);
      const codeIdx=findColIndex(header,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
      const statusIdx=findColIndex(header,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
      
      // ìƒíƒœì— ë”°ë¥¸ í–‰ ìƒ‰ìƒ ì ìš©
      const rowStatus = rows[i][statusIdx] || '';
      const statusInfo = rows[i]._statusInfo;
      
      if(statusInfo && statusInfo.className) {
        tr.classList.add(statusInfo.className);
      } else {
        // ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ fallback
        if(rowStatus.includes('ì—°ì²´')){
          tr.classList.add('overdue');
        } else if(rowStatus.includes('ëŒ€ì¶œ') || rowStatus.includes('ëŒ€ì—¬')){
          tr.classList.add('borrowed');
        }
      }
      
      const tdTitle=tr.children[titleIdx];
      if(tdTitle){
        tdTitle.style.color='#2563eb';
        tdTitle.style.cursor='pointer';
        tdTitle.style.fontWeight='500';
        tdTitle.title='í´ë¦­í•˜ë©´ ë„ì„œ ìƒì„¸ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
        const authorIdx = findColIndex(header,['ì§€ì€ì´','ì €ì']);
        const authorText = authorIdx !== -1 ? rows[i][authorIdx] : '';
        tdTitle.onclick=()=>showBookPreview(norm(rows[i][codeIdx]),norm(rows[i][titleIdx]),norm(authorText));
      }
      const tdQR=document.createElement('td');
      const code=rows[i][codeIdx];
      const author=rows[i][findColIndex(header,['ì§€ì€ì´','ì €ì'])];
      const renter=rows[i][findColIndex(header,['ëŒ€ì¶œì','ëŒ€ì—¬ì'])];
      const status=rows[i][findColIndex(header,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€'])];
      const btn=document.createElement('button');
      btn.className='qr-btn';btn.textContent='ğŸ“· QR';
      btn.onclick=()=>generateQR({code,title:rows[i][titleIdx],author,renter,status});
      tdQR.appendChild(btn);tr.appendChild(tdQR);
    }
    table.appendChild(tr);
  }
}

/* ====== í…Œì´ë¸” ì •ë ¬ ====== */
let sortState={}; // ê° í…Œì´ë¸”ì˜ ì •ë ¬ ìƒíƒœ ì €ì¥
function sortTable(originalRows,tableId,colIdx,withQR=false){
  const header=originalRows[0];
  
  // ì •ë ¬ ìƒíƒœ í™•ì¸ (ê¸°ë³¸: ì˜¤ë¦„ì°¨ìˆœ)
  const sortKey=`${tableId}_${colIdx}`;
  const isAsc=!sortState[sortKey]; // í˜„ì¬ ìƒíƒœì˜ ë°˜ëŒ€ë¡œ ì„¤ì •
  sortState[sortKey]=isAsc;
  
  // ì „ì²´ ë°ì´í„°ë¥¼ ì •ë ¬ (í—¤ë” ì œì™¸)
  const dataRows = allTableData[tableId].slice(1);
  dataRows.sort((a,b)=>{
    const aVal=a[colIdx]||'';
    const bVal=b[colIdx]||'';
    
    // ìˆ«ìì¸ì§€ í™•ì¸
    const aNum=parseFloat(String(aVal).replace(/[^\d.-]/g,''));
    const bNum=parseFloat(String(bVal).replace(/[^\d.-]/g,''));
    
    let result;
    if(!isNaN(aNum)&&!isNaN(bNum)){
      result=aNum-bNum; // ìˆ«ì ì •ë ¬
    }else{
      result=String(aVal).localeCompare(String(bVal),'ko',{numeric:true}); // ë¬¸ìì—´ ì •ë ¬ (í•œêµ­ì–´ ì§€ì›)
    }
    
    return isAsc?result:-result;
  });
  
  // ì •ë ¬ëœ ë°ì´í„°ë¡œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
  const sortedData = [header, ...dataRows];
  allTableData[tableId] = sortedData;
  
  // ì²« í˜ì´ì§€ë¡œ ì´ë™í•˜ê³  ì¬ë Œë”ë§
  currentPage[tableId] = 1;
  renderTableWithPagination(sortedData, tableId, withQR);
  
  // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
  const paginationId = tableId === 'loanTable' ? 'loanPagination' : 'libraryPagination';
  createPagination(tableId, paginationId, sortedData.length - 1);
  
  // í—¤ë”ì— ì •ë ¬ í‘œì‹œ ì¶”ê°€
  const table = document.getElementById(tableId);
  table.querySelectorAll('th').forEach(th=>{
    th.textContent=th.textContent.replace(/\s*[â†‘â†“]\s*/g,'');
    th.style.background='#f1f5f9';
  });
  
  const currentTh=table.querySelectorAll('th')[colIdx];
  currentTh.textContent+=isAsc?' â†‘':' â†“';
  currentTh.style.background='#dbeafe';
  
  // ì •ë ¬ í›„ í–‰ ìƒ‰ìƒ ë‹¤ì‹œ ì ìš© (ë„ì„œëª©ë¡ì˜ ê²½ìš°)
  if(withQR){
    const statusIdx=findColIndex(header,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
    const allRows = table.querySelectorAll('tr');
    const currentData = allTableData[tableId];
    
    for(let rowIdx = 1; rowIdx < allRows.length; rowIdx++){
      const tr = allRows[rowIdx];
      tr.classList.remove('borrowed', 'overdue');
      
      // í˜„ì¬ í˜ì´ì§€ì˜ ë°ì´í„° ì¸ë±ìŠ¤ ê³„ì‚°
      const page = currentPage[tableId];
      const startIdx = (page - 1) * ITEMS_PER_PAGE + 1;
      const dataIndex = startIdx + rowIdx - 1;
      
      if(dataIndex < currentData.length && currentData[dataIndex]._statusInfo) {
        const statusInfo = currentData[dataIndex]._statusInfo;
        if(statusInfo.className) {
          tr.classList.add(statusInfo.className);
        }
      } else {
        // ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ fallback
        const statusCell = tr.cells[statusIdx];
        if(statusCell){
          const statusText = statusCell.textContent || '';
          if(statusText.includes('ì—°ì²´')){
            tr.classList.add('overdue');
          } else if(statusText.includes('ëŒ€ì¶œ') || statusText.includes('ëŒ€ì—¬')){
            tr.classList.add('borrowed');
          }
        }
      }
    }
  }
}

/* ====== ê²€ìƒ‰ ====== */
function addSearch(inputId,tableId){
  const input=document.getElementById(inputId);
  let timer;
  input.addEventListener('input',e=>{
    clearTimeout(timer);
    timer=setTimeout(()=>{
      const val=e.target.value.trim();
      if (!val) {
        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì›ë³¸ ë°ì´í„°ë¡œ ë³µì›
        currentPage[tableId] = 1;
        renderTable(allTableData[tableId], tableId, tableId === 'libraryTable');
        return;
      }
      
      // ê²€ìƒ‰ ê²°ê³¼ í•„í„°ë§
      const originalData = allTableData[tableId];
      const filteredData = [originalData[0]]; // í—¤ë” ë³´ì¡´
      
      for(let i = 1; i < originalData.length; i++) {
        const rowText = originalData[i].join(' ');
        if (rowText.includes(val)) {
          filteredData.push(originalData[i]);
        }
      }
      
      // ê²€ìƒ‰ ê²°ê³¼ë¡œ í…Œì´ë¸” ì¬ë Œë”ë§
      currentPage[tableId] = 1;
      renderTable(filteredData, tableId, tableId === 'libraryTable');
    },150);
  });
}

/* ====== ì—°ì²´ íŒë³„ ====== */
function isOverdue(dateStr,status){
  if(!dateStr||status.includes('ë°˜ë‚©'))return false;
  const d=new Date(dateStr);
  if(isNaN(d))return false;
  const diff=(Date.now()-d.getTime())/(1000*60*60*24);
  return diff>14;
}

/* ====== ëŒ€ì¶œ ìƒíƒœ ë° ë‚¨ì€ ì¼ìˆ˜ ê³„ì‚° ====== */
function calculateLoanStatus(dateStr, status) {
  if (!dateStr || status.includes('ë°˜ë‚©')) {
    return { status: 'ë°˜ë‚©', displayText: 'ë°˜ë‚©', className: '' };
  }
  
  const loanDate = new Date(dateStr);
  if (isNaN(loanDate)) {
    return { status: status, displayText: status, className: '' };
  }
  
  const now = new Date();
  const diffInDays = Math.floor((now.getTime() - loanDate.getTime()) / (1000 * 60 * 60 * 24));
  const loanPeriod = 14; // ëŒ€ì¶œ ê¸°ê°„ 14ì¼
  const remainingDays = loanPeriod - diffInDays;
  
  if (remainingDays > 0) {
    // ëŒ€ì¶œ ì¤‘ - ë‚¨ì€ ì¼ìˆ˜ í‘œì‹œ
    return {
      status: 'ëŒ€ì¶œ',
      displayText: `ëŒ€ì¶œ (${remainingDays}ì¼ ë‚¨ìŒ)`,
      className: 'borrowed',
      remainingDays: remainingDays
    };
  } else if (remainingDays === 0) {
    // ë°˜ë‚© ë‹¹ì¼
    return {
      status: 'ëŒ€ì¶œ',
      displayText: `ëŒ€ì¶œ (ì˜¤ëŠ˜ ë°˜ë‚©)`,
      className: 'borrowed',
      remainingDays: 0
    };
  } else {
    // ì—°ì²´ - ì´ˆê³¼ ì¼ìˆ˜ í‘œì‹œ
    const overdueDays = Math.abs(remainingDays);
    return {
      status: 'ì—°ì²´',
      displayText: `ì—°ì²´ (${overdueDays}ì¼ ì´ˆê³¼)`,
      className: 'overdue',
      overdueDays: overdueDays
    };
  }
}

/* ====== ë„ì„œ ë¯¸ë¦¬ë³´ê¸° (êµ¬ê¸€ Books API) ====== */
async function showBookPreview(code, title, author = '') {
  const modal = document.getElementById('bookPreviewModal');
  const previewContent = document.getElementById('bookPreviewContent');
  const historyContent = document.getElementById('bookHistoryContent');
  
  // ëª¨ë‹¬ í‘œì‹œ
  modal.style.display = 'flex';
  
  // íƒ­ ì´ˆê¸°í™” (ë„ì„œ ì •ë³´ íƒ­ì„ ê¸°ë³¸ìœ¼ë¡œ)
  switchTab('preview');
  
  // ë¡œë”© ìƒíƒœ
  previewContent.innerHTML = '<div class="loading">ğŸ“š ë„ì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  
  try {
    // êµ¬ê¸€ Books API í˜¸ì¶œ
    const searchQuery = encodeURIComponent(`${title} ${author}`.trim());
    const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=${searchQuery}&maxResults=5&langRestrict=ko`;
    
    const response = await fetch(apiUrl);
    const data = await response.json();
    
    if (data.items && data.items.length > 0) {
      // ê°€ì¥ ì í•©í•œ ì±… ì°¾ê¸° (ì œëª© ìœ ì‚¬ë„ ê¸°ì¤€)
      const bestMatch = findBestBookMatch(data.items, title);
      renderBookInfo(bestMatch, previewContent);
    } else {
      // APIì—ì„œ ê²°ê³¼ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ ì •ë³´ í‘œì‹œ
      renderBasicBookInfo(title, author, code, previewContent);
    }
    
    // ì´ë ¥ ì •ë³´ë„ í•¨ê»˜ ì¤€ë¹„
    renderBookHistory(code, title, historyContent);
    
  } catch (error) {
    console.error('ë„ì„œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
    renderBasicBookInfo(title, author, code, previewContent);
    renderBookHistory(code, title, historyContent);
  }
  
  // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° ê¸°ëŠ¥
  modal.onclick = (e) => {
    if (e.target === modal) {
      closeBookPreview();
    }
  };
  
  // íŒì—… ë‚´ë¶€ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
  modal.querySelector('.inner').onclick = (e) => {
    e.stopPropagation();
  };
}

function findBestBookMatch(items, targetTitle) {
  // ì œëª© ìœ ì‚¬ë„ë¡œ ê°€ì¥ ì í•©í•œ ì±… ì°¾ê¸°
  let bestMatch = items[0];
  let bestScore = 0;
  
  for (const item of items) {
    const bookTitle = item.volumeInfo.title || '';
    const score = calculateSimilarity(targetTitle.toLowerCase(), bookTitle.toLowerCase());
    if (score > bestScore) {
      bestScore = score;
      bestMatch = item;
    }
  }
  
  return bestMatch;
}

function calculateSimilarity(str1, str2) {
  // ê°„ë‹¨í•œ ìœ ì‚¬ë„ ê³„ì‚° (ê³µí†µ ë‹¨ì–´ ê°œìˆ˜ ê¸°ì¤€)
  const words1 = str1.split(/\s+/);
  const words2 = str2.split(/\s+/);
  let commonWords = 0;
  
  for (const word of words1) {
    if (word.length > 1 && words2.some(w => w.includes(word) || word.includes(w))) {
      commonWords++;
    }
  }
  
  return commonWords / Math.max(words1.length, words2.length);
}

function renderBookInfo(bookData, container) {
  const info = bookData.volumeInfo;
  const saleInfo = bookData.saleInfo || {};
  
  const title = info.title || 'ì œëª© ì—†ìŒ';
  const authors = info.authors ? info.authors.join(', ') : 'ì €ì ë¯¸ìƒ';
  const publisher = info.publisher || 'ì¶œíŒì‚¬ ë¯¸ìƒ';
  const publishedDate = info.publishedDate || 'ì¶œê°„ì¼ ë¯¸ìƒ';
  const description = info.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
  const thumbnail = info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '';
  const pageCount = info.pageCount || '-';
  const categories = info.categories ? info.categories.join(', ') : '-';
  const language = info.language === 'ko' ? 'í•œêµ­ì–´' : info.language || '-';
  const rating = info.averageRating || 0;
  const ratingsCount = info.ratingsCount || 0;
  
  container.innerHTML = `
    <div class="book-header">
      <div class="book-cover">
        ${thumbnail ? `<img src="${thumbnail.replace('http:', 'https:')}" alt="ì±… í‘œì§€" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDEyMCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTYwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik00MCA2MEg4MFY2NEg0MFY2MFoiIGZpbGw9IiM5Q0EzQUYiLz4KPHA+'}alt="ì±… í‘œì§€"'>` : '<div style="width:120px;height:160px;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:12px;">í‘œì§€ ì—†ìŒ</div>'}
      </div>
      <div class="book-info">
        <h2 class="book-title">${title}</h2>
        <p class="book-author">ğŸ‘¤ ${authors}</p>
        <p class="book-publisher">ğŸ¢ ${publisher}</p>
        ${rating > 0 ? `
          <div class="book-rating">
            <span class="stars">${'â˜…'.repeat(Math.floor(rating))}${'â˜†'.repeat(5-Math.floor(rating))}</span>
            <span style="color:#6b7280;font-size:13px;">${rating}/5.0 (${ratingsCount}ëª…)</span>
          </div>
        ` : ''}
      </div>
    </div>
    
    <div class="book-meta">
      <div class="meta-item">
        <span class="meta-label">ğŸ“… ì¶œê°„ì¼</span>
        <span class="meta-value">${publishedDate}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">ğŸ“„ í˜ì´ì§€</span>
        <span class="meta-value">${pageCount}í˜ì´ì§€</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">ğŸ·ï¸ ë¶„ì•¼</span>
        <span class="meta-value">${categories}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">ğŸŒ ì–¸ì–´</span>
        <span class="meta-value">${language}</span>
      </div>
    </div>
    
    <div class="book-description">
      <strong>ğŸ“ ë„ì„œ ì†Œê°œ</strong><br><br>
      ${description.length > 500 ? description.substring(0, 500) + '...' : description}
    </div>
  `;
}

function renderBasicBookInfo(title, author, code, container) {
  container.innerHTML = `
    <div class="book-header">
      <div class="book-cover">
        <div style="width:120px;height:160px;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:12px;">í‘œì§€ ì—†ìŒ</div>
      </div>
      <div class="book-info">
        <h2 class="book-title">${title}</h2>
        ${author ? `<p class="book-author">ğŸ‘¤ ${author}</p>` : ''}
        <p style="color:#6b7280;font-size:14px;">ğŸ“š ì½”ë“œ: ${code}</p>
      </div>
    </div>
    
    <div class="book-description" style="text-align:center;color:#6b7280;padding:40px;">
      ìƒì„¸í•œ ë„ì„œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
      ë„ì„œê´€ ë‚´ë¶€ ì •ë³´ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
    </div>
  `;
}

function renderBookHistory(code, title, container) {
  const recs = window.booksData.filter(r => norm(r[1]) === code);
  
  if (recs.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280;">ëŒ€ì¶œ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  } else {
    container.innerHTML = `
      <h4 style="margin:0 0 16px 0;color:#1f2937;">ğŸ“‹ ëŒ€ì¶œ ì´ë ¥ (ì´ ${recs.length}ê±´)</h4>
      <table style="width:100%;border-collapse:collapse;">
        <tr style="background:#f8fafc;">
          <th style="padding:12px;border:1px solid #e2e8f0;text-align:left;font-weight:600;">ë“±ë¡ì¼</th>
          <th style="padding:12px;border:1px solid #e2e8f0;text-align:left;font-weight:600;">ëŒ€ì—¬ì</th>
          <th style="padding:12px;border:1px solid #e2e8f0;text-align:left;font-weight:600;">ìƒíƒœ</th>
        </tr>
        ${recs.map(r => {
          // ê° ì´ë ¥ì— ëŒ€í•´ì„œë„ ìƒì„¸ ìƒíƒœ ê³„ì‚°
          const loanStatus = calculateLoanStatus(r[0], r[5]);
          const displayStatus = loanStatus.displayText || r[5];
          const bgColor = loanStatus.status === 'ì—°ì²´' ? 'background:#fee2e2;color:#dc2626;' :
                         loanStatus.status === 'ëŒ€ì¶œ' ? 'background:#fef3c7;color:#92400e;' :
                         'background:#d1fae5;color:#047857;';
          
          return `
            <tr>
              <td style="padding:10px 12px;border:1px solid #e2e8f0;">${r[0]}</td>
              <td style="padding:10px 12px;border:1px solid #e2e8f0;">${r[4]}</td>
              <td style="padding:10px 12px;border:1px solid #e2e8f0;">
                <span style="padding:2px 8px;border-radius:12px;font-size:12px;font-weight:500;${bgColor}">
                  ${displayStatus}
                </span>
              </td>
            </tr>
          `;
        }).join('')}
      </table>
    `;
  }
}

function switchTab(tabName) {
  // íƒ­ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  // ì„ íƒëœ íƒ­ í™œì„±í™”
  if (tabName === 'preview') {
    document.querySelector('.tab-button').classList.add('active');
    document.getElementById('previewTab').classList.add('active');
  } else {
    document.querySelectorAll('.tab-button')[1].classList.add('active');
    document.getElementById('historyTab').classList.add('active');
  }
}

function closeBookPreview() {
  const modal = document.getElementById('bookPreviewModal');
  modal.style.display = 'none';
  modal.onclick = null;
}

/* ====== ê¸°ì¡´ ë„ì„œ ì´ë ¥ íŒì—… (í˜¸í™˜ì„± ìœ ì§€) ====== */
function showHistory(code,title){
  const modal=document.getElementById('historyModal');
  const histTitle=document.getElementById('histTitle');
  const histContent=document.getElementById('histContent');
  histTitle.textContent=`ğŸ“– ${title} (${code})`;
  const recs=window.booksData.filter(r=>norm(r[1])===code);
  if(recs.length===0){histContent.innerHTML='<p>ì´ë ¥ ì—†ìŒ</p>';}
  else{
    histContent.innerHTML='<table style="width:100%;border-collapse:collapse;font-size:13px"><tr><th>ë“±ë¡ì¼</th><th>ëŒ€ì—¬ì</th><th>ìƒíƒœ</th></tr>'+recs.map(r=>`<tr><td>${r[0]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`).join('')+'</table>';
  }
  modal.style.display='flex';
  
  // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° ê¸°ëŠ¥
  modal.onclick=(e)=>{
    if(e.target===modal){
      closeHistory();
    }
  };
  
  // íŒì—… ë‚´ë¶€ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
  modal.querySelector('.inner').onclick=(e)=>{
    e.stopPropagation();
  };
}
function closeHistory(){
  const modal=document.getElementById('historyModal');
  modal.style.display='none';
  modal.onclick=null; // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
}

/* ====== í† ìŠ¤íŠ¸ ì•Œë¦¼ ====== */
function showToast(message, duration = 3000) {
  // ê¸°ì¡´ í† ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
  const existingToast = document.getElementById('toast-notification');
  if (existingToast) existingToast.remove();
  
  // í† ìŠ¤íŠ¸ ìƒì„±
  const toast = document.createElement('div');
  toast.id = 'toast-notification';
  toast.style = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10000;
    font-size: 14px;
    max-width: 300px;
    animation: slideIn 0.3s ease-out;
  `;
  
  // ì• ë‹ˆë©”ì´ì…˜ CSS ì¶”ê°€
  if (!document.getElementById('toast-style')) {
    const style = document.createElement('style');
    style.id = 'toast-style';
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
  
  toast.textContent = message;
  document.body.appendChild(toast);
  
  // ìë™ ì œê±°
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

/* ====== ë©”ì¸ ì‹¤í–‰ ====== */
// ğŸ”„ í˜ì´ì§€ ë¡œë“œ ì‹œ Dooray ì—°ë™ ìƒíƒœ í™•ì¸ ë° ë²„íŠ¼ ì—…ë°ì´íŠ¸
function updateDoorayButtonStatus() {
  const btn = document.getElementById('btnDooraySync');
  const hasConfig = window.DOORAY_CONFIG.token && window.DOORAY_CONFIG.projectId && window.DOORAY_CONFIG.postId;
  
  if (hasConfig) {
    btn.innerHTML = 'âœ… Dooray ì—°ë™ë¨';
    btn.style.background = '#10b981'; // ì´ˆë¡ìƒ‰
    btn.title = 'Dooray ì—°ë™ì´ í™œì„±í™”ë˜ì–´ ìë™ ì•Œë¦¼ì´ ì‘ë™í•©ë‹ˆë‹¤';
  } else {
    btn.innerHTML = 'ğŸ”„ Dooray ì—°ë™';
    btn.style.background = '#7c3aed'; // ë³´ë¼ìƒ‰
    btn.title = 'Dooray API ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤';
  }
}

Promise.all([loadCSV('books.csv'),loadCSV('library.csv')]).then(([books,library])=>{
  window.booksData=books; // ì´ë ¥ íŒì—…ìš© ì €ì¥
  renderTable(books,'loanTable');
  
  // Dooray ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  updateDoorayButtonStatus();

  const bh=books[0].map(norm);
  const bDateIdx=findColIndex(bh,['ë“±ë¡ì¼','ëŒ€ì¶œì¼','ì¼ì']);
  const bCodeIdx=findColIndex(bh,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
  const bStatusIdx=findColIndex(bh,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
  const bUserIdx=findColIndex(bh,['ëŒ€ì—¬ì','ëŒ€ì¶œì']);
  const latestByCode={};

  for(let i=1;i<books.length;i++){
    const date=norm(books[i][bDateIdx]);
    const code=norm(books[i][bCodeIdx]);
    const status=norm(books[i][bStatusIdx]);
    const borrower=norm(books[i][bUserIdx]);
    if(!code)continue;
    if(!latestByCode[code])latestByCode[code]={status:'',borrower:'',lastReturn:''};
    if(status.includes('ë°˜ë‚©'))latestByCode[code].lastReturn=date;
    latestByCode[code].status=status;
    latestByCode[code].borrower=borrower;
  }

  const lh=library[0].map(norm);
  const lCodeIdx=findColIndex(lh,['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
  let lStatusIdx=findColIndex(lh,['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
  let lUserIdx=findColIndex(lh,['ëŒ€ì—¬ì','ëŒ€ì¶œì']);
  if(lStatusIdx===-1){library[0].push('ëŒ€ì¶œì—¬ë¶€');lStatusIdx=library[0].length-1;}
  if(lUserIdx===-1){library[0].push('ëŒ€ì¶œì');lUserIdx=library[0].length-1;}

  for(let i=1;i<library.length;i++){
    const code=norm(library[i][lCodeIdx]);
    const rec=latestByCode[code];
    if(!rec){library[i][lStatusIdx]='';library[i][lUserIdx]='';continue;}
    if(rec.status.includes('ë°˜ë‚©')){
      library[i][lStatusIdx]='ë°˜ë‚©';
      library[i][lUserIdx]='';
    }else{
      library[i][lUserIdx]=rec.borrower||'';
      // âœ… ìƒì„¸í•œ ëŒ€ì¶œ ìƒíƒœ ê³„ì‚° (ë‚¨ì€ ì¼ìˆ˜/ì´ˆê³¼ ì¼ìˆ˜ í¬í•¨)
      const loanRow=books.find(b=>norm(b[bCodeIdx])===code && !b[bStatusIdx].includes('ë°˜ë‚©'));
      const loanDate=loanRow?loanRow[bDateIdx]:'';
      const loanStatus = calculateLoanStatus(loanDate, rec.status);
      library[i][lStatusIdx] = loanStatus.displayText;
      
      // ìƒíƒœ ì •ë³´ë¥¼ ë°ì´í„°ì— ì €ì¥ (ë‚˜ì¤‘ì— ìƒ‰ìƒ ì ìš©ìš©)
      library[i]._statusInfo = loanStatus;
    }
  }

  renderTable(library,'libraryTable',true);
  addSearch('searchLoans','loanTable');
  addSearch('searchLibrary','libraryTable');

  // âœ… ëŒ€ì¶œ ì¤‘ í•„í„°
  const btnBorrowed=document.getElementById('btnBorrowed');
  let borrowedOn=false;
  btnBorrowed.onclick=()=>{
    // ëŒ€ì¶œ í˜„í™© í™”ë©´ì—ì„œ í´ë¦­í•œ ê²½ìš° ì „ì²´ ë„ì„œëª©ë¡ìœ¼ë¡œ ìë™ ì „í™˜
    if(!document.getElementById('librarySection').classList.contains('hidden')==false){
      document.getElementById('librarySection').classList.remove('hidden');
      document.getElementById('loanSection').classList.add('hidden');
      document.getElementById('btnLibrary').classList.add('active');
      document.getElementById('btnLoans').classList.remove('active');
    }
    
    borrowedOn=!borrowedOn;btnBorrowed.classList.toggle('active',borrowedOn);
    
    // ëª¨ë“  í•„í„° ì¬ì ìš©
    applyAllFilters();
    
    // í˜ì´ì§€ì™€ í…Œì´ë¸” ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™
    window.scrollTo(0,0);
    document.querySelector('#librarySection .table-wrap').scrollTop=0;
  };

  // âœ… ìµœì‹  ë„ì„œ ìˆœ í•„í„° (library.csv ë°ì´í„° ì—­ìˆœ ì¶œë ¥)
  const btnNewest=document.getElementById('btnNewest');
  let newestOn=false;
  let originalLibraryData=[...library]; // ì›ë³¸ ë°ì´í„° ë³´ì¡´
  btnNewest.onclick=()=>{
    // ëŒ€ì¶œ í˜„í™© í™”ë©´ì—ì„œ í´ë¦­í•œ ê²½ìš° ì „ì²´ ë„ì„œëª©ë¡ìœ¼ë¡œ ìë™ ì „í™˜
    if(!document.getElementById('librarySection').classList.contains('hidden')==false){
      document.getElementById('librarySection').classList.remove('hidden');
      document.getElementById('loanSection').classList.add('hidden');
      document.getElementById('btnLibrary').classList.add('active');
      document.getElementById('btnLoans').classList.remove('active');
    }
    
    newestOn=!newestOn;btnNewest.classList.toggle('active',newestOn);
    
    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
    if(newestOn){
      btnNewest.innerHTML='ğŸ“‰ ì˜¤ë˜ëœ ìˆœìœ¼ë¡œ ë³´ê¸°';
    }else{
      btnNewest.innerHTML='ğŸ“ˆ ìµœì‹  ë„ì„œ ìˆœìœ¼ë¡œ ë³´ê¸°';
    }
    
    // í˜„ì¬ í‘œì‹œëœ í–‰ë“¤ì„ ìˆ˜ì§‘ (í•„í„°ë§ëœ ìƒíƒœ ê³ ë ¤)
    const currentRows=[];
    const trs=document.querySelectorAll('#libraryTable tr');
    
    // í—¤ë” ì¶”ê°€
    currentRows.push(library[0]);
    
    // í˜„ì¬ ë³´ì´ëŠ” ë°ì´í„° í–‰ë“¤ë§Œ ìˆ˜ì§‘
    for(let i=1;i<trs.length;i++){
      if(trs[i].style.display!=='none'){
        const rowData=[];
        for(let j=0;j<trs[i].cells.length-1;j++){ // QR ì»¬ëŸ¼ ì œì™¸
          rowData.push(trs[i].cells[j].textContent);
        }
        currentRows.push(rowData);
      }
    }
    
    if(newestOn){
      // í˜„ì¬ í•„í„°ëœ ë°ì´í„°ë¥¼ ì—­ìˆœìœ¼ë¡œ ì •ë ¬ (í—¤ë”ëŠ” ê·¸ëŒ€ë¡œ)
      const reversedRows=[currentRows[0],...currentRows.slice(1).reverse()];
      renderTable(reversedRows,'libraryTable',true);
    }else{
      // ì›ë³¸ ìˆœì„œë¡œ ë³µì›
      renderTable(originalLibraryData,'libraryTable',true);
    }
    
    // ëª¨ë“  í•„í„° ì¬ì ìš©
    applyAllFilters();
    
    // ê²€ìƒ‰ ê¸°ëŠ¥ ë‹¤ì‹œ ë°”ì¸ë”©
    addSearch('searchLibrary','libraryTable');
    
    // í˜ì´ì§€ì™€ í…Œì´ë¸” ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™
    window.scrollTo(0,0);
    document.querySelector('#librarySection .table-wrap').scrollTop=0;
  };
  
  // ëª¨ë“  í•„í„°ë¥¼ ì¬ì ìš©í•˜ëŠ” í•¨ìˆ˜
  function applyAllFilters(){
    let dataToFilter = [...originalLibraryData];
    
    // ìµœì‹  ìˆœ ì •ë ¬ ì ìš©
    if(newestOn){
      dataToFilter = [dataToFilter[0], ...dataToFilter.slice(1).reverse()];
    }
    
    // í•„í„°ë§ ì ìš©
    const statusIdx = findColIndex(library[0],['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
    const filteredData = [dataToFilter[0]]; // í—¤ë” ë³´ì¡´
    
    for(let i = 1; i < dataToFilter.length; i++){
      const row = dataToFilter[i];
      let shouldShow = true;
      
      // ëŒ€ì¶œ ì¤‘ í•„í„° ì ìš©
      if(borrowedOn){
        const status = row[statusIdx] || '';
        const statusInfo = row._statusInfo;
        const isBorrowed = statusInfo ? 
          (statusInfo.status === 'ëŒ€ì¶œ' || statusInfo.status === 'ì—°ì²´') :
          /(ëŒ€ì¶œ|ëŒ€ì—¬|ì—°ì²´)/.test(status);
        if(!isBorrowed) shouldShow = false;
      }
      
      // 30ì¼ í•„í„° ì ìš©
      if(recentOn && dateIdx !== -1){
        const dateText = row[dateIdx] || '';
        const bookDate = new Date(dateText);
        const now = new Date();
        const thirtyDaysAgo = new Date(now.getTime() - 30*24*60*60*1000);
        const isRecent = !isNaN(bookDate) && bookDate >= thirtyDaysAgo;
        if(!isRecent) shouldShow = false;
      }
      
      if(shouldShow) filteredData.push(row);
    }
    
    // í•„í„°ëœ ë°ì´í„°ë¡œ í…Œì´ë¸” ì¬ë Œë”ë§
    currentPage['libraryTable'] = 1;
    renderTable(filteredData, 'libraryTable', true);
    
    // ê²€ìƒ‰ ê¸°ëŠ¥ ë‹¤ì‹œ ë°”ì¸ë”©
    addSearch('searchLibrary','libraryTable');
  }

  // âœ… ìµœê·¼ 30ì¼ ë„ì„œë§Œ ë³´ê¸° í•„í„° (ë“±ë¡ì¼ ì»¬ëŸ¼ í™•ì¸)
  const btnRecent=document.getElementById('btnRecent');
  let recentOn=false;
  
  // ë“±ë¡ì¼ ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸
  const dateIdx=findColIndex(library[0],['ë“±ë¡ì¼','ì¼ì','ë‚ ì§œ','ì…ê³ ì¼','êµ¬ì…ì¼']);
  
  if(dateIdx===-1){
    // ë“±ë¡ì¼ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
    btnRecent.style.opacity='0.5';
    btnRecent.style.cursor='not-allowed';
    btnRecent.title='ë“±ë¡ì¼ ì •ë³´ê°€ ì—†ì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
    btnRecent.onclick=()=>{
      alert('ğŸ“… ë“±ë¡ì¼ ì •ë³´ê°€ ì—†ì–´ì„œ ìµœê·¼ 30ì¼ í•„í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nCSV íŒŒì¼ì— "ë“±ë¡ì¼", "ì¼ì", "ë‚ ì§œ" ë“±ì˜ ì»¬ëŸ¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
    };
  }else{
    // ë“±ë¡ì¼ ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ ì •ìƒ ë™ì‘
    btnRecent.onclick=()=>{
      // ëŒ€ì¶œ í˜„í™© í™”ë©´ì—ì„œ í´ë¦­í•œ ê²½ìš° ì „ì²´ ë„ì„œëª©ë¡ìœ¼ë¡œ ìë™ ì „í™˜
      if(!document.getElementById('librarySection').classList.contains('hidden')==false){
        document.getElementById('librarySection').classList.remove('hidden');
        document.getElementById('loanSection').classList.add('hidden');
        document.getElementById('btnLibrary').classList.add('active');
        document.getElementById('btnLoans').classList.remove('active');
      }
      
      recentOn=!recentOn;btnRecent.classList.toggle('active',recentOn);
      
      // ëª¨ë“  í•„í„° ì¬ì ìš©
      applyAllFilters();
      
      // í˜ì´ì§€ì™€ í…Œì´ë¸” ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™
      window.scrollTo(0,0);
      document.querySelector('#librarySection .table-wrap').scrollTop=0;
    };
  }
});

document.getElementById('btnLoans').onclick=()=>{
  document.getElementById('loanSection').classList.remove('hidden');
  document.getElementById('librarySection').classList.add('hidden');
  document.getElementById('btnLoans').classList.add('active');
  document.getElementById('btnLibrary').classList.remove('active');
  // í˜ì´ì§€ì™€ í…Œì´ë¸” ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™
  window.scrollTo(0,0);
  document.querySelector('#loanSection .table-wrap').scrollTop=0;
};
document.getElementById('btnLibrary').onclick=()=>{
  document.getElementById('librarySection').classList.remove('hidden');
  document.getElementById('loanSection').classList.add('hidden');
  document.getElementById('btnLibrary').classList.add('active');
  document.getElementById('btnLoans').classList.remove('active');
  // í˜ì´ì§€ì™€ í…Œì´ë¸” ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™
  window.scrollTo(0,0);
  document.querySelector('#librarySection .table-wrap').scrollTop=0;
};
document.getElementById('btnAddBook').onclick=()=>{
  window.open('https://docs.google.com/forms/d/e/1FAIpQLSdOFZRt4o-bw6UNmBB6JtdDQ6PR5f7eW0dpfIs8KwyUysL5ag/viewform?usp=header');
};

// ========== Dooray ì—°ë™ ê¸°ëŠ¥ ==========

document.getElementById('btnDooraySync').onclick=()=>{
  showDoorayModal();
};

function showDoorayModal() {
  const modal = document.getElementById('doorayModal');
  const statusDiv = document.getElementById('doorayStatus');
  const featuresDiv = document.getElementById('doorayFeatures');
  const setupDiv = document.getElementById('dooraySetup');
  const testResultDiv = document.getElementById('doorayTestResult');
  
  modal.style.display = 'flex';
  testResultDiv.style.display = 'none';
  
  // ê¸°ì¡´ ì„¤ì •ê°’ì„ ì…ë ¥ í•„ë“œì— í‘œì‹œ
  const backendUrlInput = document.getElementById('gasBackendUrl');
  const wikiIdInput = document.getElementById('doorayWikiId');
  const pageIdInput = document.getElementById('doorayPageId');
  
  if (backendUrlInput) backendUrlInput.value = localStorage.getItem('gas_backend_url') || '';
  if (wikiIdInput) wikiIdInput.value = localStorage.getItem('dooray_wiki_id') || '';
  if (pageIdInput) pageIdInput.value = localStorage.getItem('dooray_page_id') || '';
  
  // Dooray ì—°ë™ ìƒíƒœ í™•ì¸
  const hasConfig = localStorage.getItem('gas_backend_url') && window.DOORAY_CONFIG.wikiId && window.DOORAY_CONFIG.pageId;
  
  if (hasConfig && window.doorayIntegration && window.doorayIntegration.isEnabled) {
    statusDiv.className = 'status-card status-success';
    statusDiv.innerHTML = `<strong>âœ… Dooray ì—°ë™ í™œì„±í™”ë¨</strong><br>Wiki ID: ${window.DOORAY_CONFIG.wikiId}<br>Page ID: ${window.DOORAY_CONFIG.pageId}`;
    featuresDiv.style.display = 'block';
    setupDiv.style.display = 'block'; // ìˆ˜ì •ë„ ê°€ëŠ¥í•˜ê²Œ
  } else {
    statusDiv.className = 'status-card status-warning';
    statusDiv.innerHTML = '<strong>âš™ï¸ Dooray ì—°ë™ ì„¤ì • í•„ìš”</strong><br>Google Apps Script ë°±ì—”ë“œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    featuresDiv.style.display = 'none';
    setupDiv.style.display = 'block';
  }
  
  // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  modal.onclick = (e) => {
    if (e.target === modal) {
      closeDoorayModal();
    }
  };
  modal.querySelector('.inner').onclick = (e) => e.stopPropagation();
}

function closeDoorayModal() {
  const modal = document.getElementById('doorayModal');
  modal.style.display = 'none';
  modal.onclick = null;
}

// ğŸ§ª Dooray ì—°ê²° í…ŒìŠ¤íŠ¸
async function testDoorayConnection() {
  const testResultDiv = document.getElementById('doorayTestResult');
  testResultDiv.style.display = 'block';
  testResultDiv.className = 'test-result';
  testResultDiv.innerHTML = 'ğŸ”„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
  
  if (!window.doorayIntegration || !window.doorayIntegration.isEnabled) {
    testResultDiv.className = 'test-result status-error';
    testResultDiv.innerHTML = 'âŒ Dooray ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
    return;
  }
  
  try {
    const result = await window.doorayIntegration.testConnection();
    
    if (result.success) {
      testResultDiv.className = 'test-result status-success';
      testResultDiv.innerHTML = `
        âœ… ${result.message}
        
í”„ë¡œì íŠ¸ ID: ${result.data.projectId}
í¬ìŠ¤íŠ¸ ì œëª©: ${result.data.postTitle}
ë§ˆì§€ë§‰ ìˆ˜ì •: ${result.data.lastModified}
      `;
    } else {
      testResultDiv.className = 'test-result status-error';
      testResultDiv.innerHTML = `âŒ ${result.message}`;
    }
  } catch (error) {
    testResultDiv.className = 'test-result status-error';
    testResultDiv.innerHTML = `âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`;
  }
}

// ğŸ“Š ë„ì„œ í˜„í™©ì„ Dooray Wikiì— ë™ê¸°í™”
async function syncLibraryToWiki() {
  const testResultDiv = document.getElementById('doorayTestResult');
  testResultDiv.style.display = 'block';
  testResultDiv.className = 'test-result';
  testResultDiv.innerHTML = 'ğŸ”„ Wiki ì—…ë°ì´íŠ¸ ì¤‘...';
  
  if (!window.doorayIntegration || !window.doorayIntegration.isEnabled) {
    testResultDiv.className = 'test-result status-error';
    testResultDiv.innerHTML = 'âŒ Dooray ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
    return;
  }
  
  try {
    // í˜„ì¬ ë„ì„œê´€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const libraryTable = document.getElementById('libraryTable');
    if (!libraryTable || !window.allTableData || !window.allTableData.libraryTable) {
      testResultDiv.className = 'test-result status-error';
      testResultDiv.innerHTML = 'âŒ ë„ì„œê´€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }
    
    const libraryData = window.allTableData.libraryTable;
    const success = await window.doorayIntegration.updateLibraryStatusToWiki(libraryData);
    
    if (success) {
      testResultDiv.className = 'test-result status-success';
      testResultDiv.innerHTML = `
        âœ… Dooray Wiki ì—…ë°ì´íŠ¸ ì™„ë£Œ!
        
ì—…ë°ì´íŠ¸ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}
ì´ ë„ì„œ ìˆ˜: ${libraryData.length - 1}ê¶Œ
ëŒ€ì¶œì¤‘ì¸ ë„ì„œ: ${libraryData.slice(1).filter(row => {
  const status = row[row.length - 2] || '';
  return status.includes('ëŒ€ì¶œ') || status.includes('ì—°ì²´');
}).length}ê¶Œ
      `;
    } else {
      testResultDiv.className = 'test-result status-error';
      testResultDiv.innerHTML = 'âŒ Wiki ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
    }
  } catch (error) {
    testResultDiv.className = 'test-result status-error';
    testResultDiv.innerHTML = `âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`;
  }
}

// ğŸ’¬ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡
async function sendTestNotification() {
  const testResultDiv = document.getElementById('doorayTestResult');
  testResultDiv.style.display = 'block';
  testResultDiv.className = 'test-result';
  testResultDiv.innerHTML = 'ğŸ”„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì¤‘...';
  
  if (!window.doorayIntegration || !window.doorayIntegration.isEnabled) {
    testResultDiv.className = 'test-result status-error';
    testResultDiv.innerHTML = 'âŒ Dooray ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
    return;
  }
  
  // í…ŒìŠ¤íŠ¸ìš© ë„ì„œ ì •ë³´
  const testBookInfo = {
    title: 'í…ŒìŠ¤íŠ¸ ë„ì„œ',
    author: 'í…ŒìŠ¤íŠ¸ ì €ì',
    borrower: 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
    code: 'TEST001'
  };
  
  try {
    const success = await window.doorayIntegration.notifyBookAction('borrow', testBookInfo);
    
    if (success) {
      testResultDiv.className = 'test-result status-success';
      testResultDiv.innerHTML = `
        âœ… í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ!
        
ì•Œë¦¼ ë‚´ìš©: ë„ì„œ ëŒ€ì¶œ ì•Œë¦¼
ë„ì„œëª…: ${testBookInfo.title}
ëŒ€ì¶œì: ${testBookInfo.borrower}
ì „ì†¡ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}
      `;
    } else {
      testResultDiv.className = 'test-result status-warning';
      testResultDiv.innerHTML = 'âš ï¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (ì±„ë„ ID ë¯¸ì„¤ì • ë˜ëŠ” ê¶Œí•œ ì—†ìŒ)';
    }
  } catch (error) {
    testResultDiv.className = 'test-result status-error';
    testResultDiv.innerHTML = `âŒ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`;
  }
}

// ğŸ’¾ Dooray ì„¤ì • ì €ì¥ ë° í…ŒìŠ¤íŠ¸
async function saveDoorayConfig() {
  console.log('ğŸ’¾ saveDoorayConfig í•¨ìˆ˜ ì‹¤í–‰ë¨'); // ë””ë²„ê·¸ìš©
  
  const backendUrlInput = document.getElementById('gasBackendUrl');
  const wikiIdInput = document.getElementById('doorayWikiId');  
  const pageIdInput = document.getElementById('doorayPageId');
  const testResultDiv = document.getElementById('doorayTestResult');
  
  // ìš”ì†Œ ì¡´ì¬ í™•ì¸
  if (!backendUrlInput || !wikiIdInput || !pageIdInput || !testResultDiv) {
    alert('âŒ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
    console.error('í•„ìˆ˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', {backendUrlInput, wikiIdInput, pageIdInput, testResultDiv});
    return;
  }
  
  const backendUrl = backendUrlInput.value.trim();
  const wikiId = wikiIdInput.value.trim();
  const pageId = pageIdInput.value.trim();
  
  testResultDiv.style.display = 'block';
  testResultDiv.className = 'test-result';
  testResultDiv.innerHTML = 'ğŸ”„ ì„¤ì • ì €ì¥ ë° ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
  
  // ì…ë ¥ê°’ ê²€ì¦
  if (!backendUrl || !wikiId || !pageId) {
    testResultDiv.className = 'test-result status-error';
    testResultDiv.innerHTML = 'âŒ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    return;
  }
  
  try {
    console.log('ğŸ’¾ localStorageì— ì„¤ì • ì €ì¥ ì¤‘...');
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    localStorage.setItem('gas_backend_url', backendUrl);
    localStorage.setItem('dooray_wiki_id', wikiId);
    localStorage.setItem('dooray_page_id', pageId);
    
    console.log('âœ… localStorage ì €ì¥ ì™„ë£Œ');
    
    // í˜„ì¬ ì„¤ì • ì—…ë°ì´íŠ¸
    if (!window.DOORAY_CONFIG) {
      console.error('âŒ DOORAY_CONFIGê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ');
      testResultDiv.className = 'test-result status-error';
      testResultDiv.innerHTML = 'âŒ ì„¤ì • ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.';
      return;
    }
    
    window.DOORAY_CONFIG.wikiId = wikiId;
    window.DOORAY_CONFIG.pageId = pageId;
    
    console.log('âœ… DOORAY_CONFIG ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    
    // doorayIntegration ì¸ìŠ¤í„´ìŠ¤ ì¬ìƒì„±
    try {
      window.doorayIntegration = new DoorayIntegration();
      console.log('âœ… DoorayIntegration ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ');
    } catch (error) {
      testResultDiv.className = 'test-result status-error';
      testResultDiv.innerHTML = `âŒ Dooray ì—°ë™ ëª¨ë“ˆ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`;
      console.error('DoorayIntegration ìƒì„± ì˜¤ë¥˜:', error);
      return;
    }
    
    // ì—°ê²° í…ŒìŠ¤íŠ¸
    console.log('ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
    const result = await window.doorayIntegration.testConnection();
    
    if (result.success) {
      testResultDiv.className = 'test-result status-success';
      testResultDiv.innerHTML = `
        âœ… ì„¤ì • ì €ì¥ ë° ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!
        
${result.message}
í”„ë¡œì íŠ¸ ID: ${result.data.projectId}
í¬ìŠ¤íŠ¸ ì œëª©: ${result.data.postTitle}
      `;
      
      // UI ìƒíƒœ ì—…ë°ì´íŠ¸
      updateDoorayButtonStatus(); // ë²„íŠ¼ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
      setTimeout(() => {
        showDoorayModal(); // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
      }, 2000);
      
    } else {
      testResultDiv.className = 'test-result status-error';
      testResultDiv.innerHTML = `âŒ ì—°ê²° ì‹¤íŒ¨: ${result.message}<br><br>í† í°ê³¼ ID ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.`;
    }
    
  } catch (error) {
    console.error('ğŸš¨ saveDoorayConfig ì˜¤ë¥˜:', error);
    testResultDiv.className = 'test-result status-error';
    testResultDiv.innerHTML = `âŒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ${error.message}<br><br>ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
    
    // ìƒì„¸ ì˜¤ë¥˜ ì •ë³´ ì¶œë ¥
    console.error('ì˜¤ë¥˜ ìƒì„¸:', {
      error: error,
      stack: error.stack,
      token: token ? 'ì„¤ì •ë¨' : 'ë¹„ì–´ìˆìŒ',
      projectId: projectId ? 'ì„¤ì •ë¨' : 'ë¹„ì–´ìˆìŒ', 
      postId: postId ? 'ì„¤ì •ë¨' : 'ë¹„ì–´ìˆìŒ'
    });
  }
}

// ğŸ§ª ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function testDooraySetup() {
  console.log('ğŸ§ª Dooray ì„¤ì • í…ŒìŠ¤íŠ¸ ì‹œì‘');
  console.log('DOORAY_CONFIG:', window.DOORAY_CONFIG);
  console.log('doorayIntegration:', window.doorayIntegration);
  console.log('localStorage í† í°:', localStorage.getItem('dooray_token'));
  
  alert('ğŸ§ª í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ì½˜ì†”(F12)ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
}

// ğŸ—‘ï¸ Dooray ì„¤ì • ì´ˆê¸°í™”
function clearDoorayConfig() {
  if (confirm('Dooray ì„¤ì •ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    localStorage.removeItem('gas_backend_url');
    localStorage.removeItem('dooray_wiki_id');
    localStorage.removeItem('dooray_page_id');
    
    window.DOORAY_CONFIG.wikiId = '';
    window.DOORAY_CONFIG.pageId = '';
    
    window.doorayIntegration = new DoorayIntegration();
    
    updateDoorayButtonStatus(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    alert('âœ… ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    showDoorayModal();
  }
}

// ë„ì„œ ëŒ€ì¶œ/ë°˜ë‚© ì‹œ ìë™ ì•Œë¦¼ (ê¸°ì¡´ QR ìƒì„± í•¨ìˆ˜ í™•ì¥)
const originalGenerateQR = generateQR;
generateQR = function(bookInfo) {
  // ê¸°ì¡´ QR ìƒì„± ê¸°ëŠ¥ ì‹¤í–‰
  originalGenerateQR(bookInfo);
  
  // Dooray ì•Œë¦¼ ì „ì†¡ (ë¹„ë™ê¸°ë¡œ ì‹¤í–‰í•˜ì—¬ QR ìƒì„±ì— ì˜í–¥ ì—†ìŒ)
  if (window.doorayIntegration && window.doorayIntegration.isEnabled) {
    setTimeout(async () => {
      try {
        const action = bookInfo.status.includes('ë°˜ë‚©') ? 'return' : 'borrow';
        const success = await window.doorayIntegration.notifyBookAction(action, bookInfo);
        
        if (success) {
          console.log(`âœ… Dooray ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ: ${action} - ${bookInfo.title}`);
          // ì„ íƒì‚¬í•­: ì„±ê³µ ì‹œ ì‘ì€ í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
          showToast(`ğŸ“¢ Dooray ì•Œë¦¼ ì „ì†¡ë¨: ${bookInfo.title}`);
        } else {
          console.warn(`âš ï¸ Dooray ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (ì„¤ì • í™•ì¸ í•„ìš”): ${bookInfo.title}`);
        }
      } catch (error) {
        console.warn('ğŸš¨ Dooray ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜:', error);
      }
    }, 1000);
  }
};
</script>
</body>
</html>
