<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<style>
  body{font-family:'Pretendard','Noto Sans KR',sans-serif;background:#f8fafc;margin:0;padding:24px;color:#222}
  h1{text-align:center;color:#004080;margin-bottom:10px}
  nav{text-align:center;margin-bottom:16px}
  button{background:#004080;color:#fff;border:none;border-radius:8px;padding:8px 14px;margin:0 6px;cursor:pointer;font-size:14px}
  button.active{background:#2563eb}
  button.filter{background:#6b7280}
  button.filter.active{background:#16a34a}
  button.qr-btn{background:#0d9488;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:13px}
  input{display:block;margin:12px auto 16px;padding:8px 14px;font-size:14px;border:1px solid #cbd5e1;border-radius:6px;width:260px}
  .table-wrap{max-height:70vh;overflow:auto;border-radius:8px;background:#fff;box-shadow:0 0 5px rgba(0,0,0,.08)}
  table{width:100%;border-collapse:collapse;min-width:960px}
  th,td{border:1px solid #e2e8f0;padding:7px 10px;text-align:left;font-size:13.5px}
  th{background:#f1f5f9;color:#004080;position:sticky;top:0;z-index:10}
  tr:nth-child(even){background:#fafafa}
  tr:hover{background:#eef6ff}
  tr.borrowed td{background:#fff8e1}
  .hidden{display:none}
  footer{text-align:center;color:#667085;font-size:13px;margin-top:18px}
</style>
</head>
<body>

<h1>ğŸ“š ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
<nav>
  <button id="btnLoans" class="active">ğŸ“˜ ëŒ€ì¶œ í˜„í™©</button>
  <button id="btnLibrary">ğŸ“— ì „ì²´ ë„ì„œëª©ë¡</button>
  <button id="btnBorrowed" class="filter">ğŸ“• ëŒ€ì¶œ ì¤‘ ë„ì„œë§Œ ë³´ê¸°</button>
</nav>

<div id="loanSection">
  <input type="text" id="searchLoans" placeholder="ë„ì„œëª…, ëŒ€ì—¬ì, ì½”ë“œë²ˆí˜¸ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="loanTable"></table></div>
</div>

<div id="librarySection" class="hidden">
  <input type="text" id="searchLibrary" placeholder="ì œëª©/ë„ì„œëª…, ì €ì, ì¶œíŒì‚¬ ê²€ìƒ‰...">
  <div class="table-wrap"><table id="libraryTable"></table></div>
</div>

<footer>Â© ìš¸ì‚°ë„ì‹œê³µì‚¬ ë„ì„œê´€ë¦¬ ì‹œìŠ¤í…œ | CSV ë·°ì–´ + ì´ë ¥ ë°˜ì˜ + QR ìƒì„±</footer>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
/* ====== 0) í™˜ê²½ ì„¤ì • (Python ì½”ë“œì™€ ë™ì¼í•œ í¼ entry) ====== */
const FORM_URL =
  "https://docs.google.com/forms/d/e/1FAIpQLSdGuoHeUW-37RFCBgMH7ZUNL0tt_yHQiIFMrif85mrV428Omg/viewform";
const ENTRY_IDS = {
  code:   "entry.32105598",   // ë„ì„œì½”ë“œ
  title:  "entry.1234176416", // ë„ì„œëª…
  author: "entry.628826984",  // ì €ìëª…
  status: "entry.12641564",   // ìƒíƒœ(ëŒ€ì¶œ/ë°˜ë‚©)
  renter: "entry.615776096"   // ëŒ€ì—¬ìëª…
};

/* ====== 1) ìœ í‹¸ ====== */
const norm = s => String(s||'').replace(/\uFEFF/g,'').trim();           // BOM ì œê±° + íŠ¸ë¦¼
const normHead = s => norm(s).replace(/\s/g,'');                         // í—¤ë” ë¹„êµìš©(ê³µë°± ì œê±°)
const includesAny = (h, keys) => keys.some(k => normHead(h).includes(k));
function findColIndex(header, candidates){                               
  return header.findIndex(h => includesAny(h, candidates));
}

/* ====== 2) CSV ë¡œë“œ ====== */
async function loadCSV(file){
  const res = await fetch(file + '?v=' + Date.now());
  if(!res.ok) throw new Error(file + ' ë¡œë“œ ì‹¤íŒ¨');
  const text = await res.text();
  return Papa.parse(text.trim(), { skipEmptyLines:true }).data;
}

/* ====== 3) í‘œ ë Œë”ë§ ====== */
function renderTable(rows, id, withQR=false){
  const header = rows[0];
  const table = document.getElementById(id);
  const finalHeader = withQR ? [...header, 'QR ìƒì„±'] : header;
  table.innerHTML = '<tr>'+finalHeader.map(h=>`<th>${h}</th>`).join('')+'</tr>';

  for(let i=1;i<rows.length;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = rows[i].map(c=>`<td>${c}</td>`).join('');

    if(withQR){
      // ì»¬ëŸ¼ ê°’ ì¶”ì¶œ(í—¤ë” ë³€í™” ëŒ€ì‘)
      const code   = rows[i][findColIndex(header, ['ì½”ë“œ','ì½”ë“œë²ˆí˜¸'])] || '';
      const title  = rows[i][findColIndex(header, ['ì œëª©','ë„ì„œëª…'])]   || '';
      const author = rows[i][findColIndex(header, ['ì§€ì€ì´','ì €ì'])]   || '';
      const status = rows[i][findColIndex(header, ['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€'])] || '';
      const renter = rows[i][findColIndex(header, ['ëŒ€ì¶œì','ëŒ€ì—¬ì'])] || '';

      const tdQR = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = 'qr-btn';
      btn.textContent = 'ğŸ“· QR';
      btn.onclick = ()=>generateQR({code, title, author, renter, status});
      tdQR.appendChild(btn);
      tr.appendChild(tdQR);
    }
    table.appendChild(tr);
  }
}

/* ====== 4) ê²€ìƒ‰(ë””ë°”ìš´ì‹±) ====== */
function addSearch(inputId, tableId){
  const input = document.getElementById(inputId);
  let timer;
  input.addEventListener('input', e=>{
    clearTimeout(timer);
    timer = setTimeout(()=>{
      const val = e.target.value.trim();
      const trs = document.querySelectorAll(`#${tableId} tr`);
      for(let i=1;i<trs.length;i++){
        const tr = trs[i];
        const text = tr.textContent;
        tr.style.display = text.includes(val)?'':'none';
      }
    }, 150);
  });
}

/* ====== 5) QR ìƒì„± ====== */
function generateQR({code, title, author, renter, status}){
  // Pythonê³¼ ë™ì¼í•œ ë§¤í•‘(ì •í™• URL ì¸ì½”ë”©)
  const statusEncoded = (status.includes('ë°˜ë‚©'))
    ? "%EB%B0%98%EB%82%A9"
    : (status.includes('ëŒ€ì¶œ') || status.includes('ëŒ€ì—¬'))
      ? "%EB%8C%80%EC%B6%9C" : "";

  const url =
    `${FORM_URL}?usp=pp_url` +
    `&${ENTRY_IDS.code}=${encodeURIComponent(code)}` +
    `&${ENTRY_IDS.title}=${encodeURIComponent(title)}` +
    `&${ENTRY_IDS.author}=${encodeURIComponent(author)}` +
    `&${ENTRY_IDS.renter}=${encodeURIComponent(renter)}` +
    `&${ENTRY_IDS.status}=${statusEncoded}`;

  const layer = document.createElement('div');
  layer.style = `position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;`;
  layer.innerHTML = `
    <div style="background:#fff;padding:18px 22px;border-radius:10px;text-align:center;max-width:420px">
      <h3 style="margin:6px 0 12px">ğŸ“· QR ì½”ë“œ (${code})</h3>
      <div id="qrbox" style="margin:0 auto 10px;width:220px;height:220px"></div>
      <p style="word-break:break-all;font-size:12px;"><a href="${url}" target="_blank">${url}</a></p>
      <div style="margin-top:10px">
        <button id="qrClose" style="background:#475569;color:#fff;border:none;border-radius:6px;padding:6px 10px;margin-right:6px">ë‹«ê¸°</button>
        <button id="qrDown"  style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px">QR ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>`;
  document.body.appendChild(layer);

  new QRCode(layer.querySelector('#qrbox'), {
    text: url, width: 220, height: 220,
    colorDark:"#000", colorLight:"#fff", correctLevel: QRCode.CorrectLevel.H
  });

  layer.querySelector('#qrClose').onclick = ()=>layer.remove();
  layer.querySelector('#qrDown').onclick = ()=>{
    const img = layer.querySelector('#qrbox img');
    const a = document.createElement('a');
    a.href = img.src; a.download = `${code}.png`; a.click();
  };
}

/* ====== 6) ë©”ì¸ ì‹¤í–‰: ì´ë ¥ ë°˜ì˜ + QR ====== */
Promise.all([loadCSV('books.csv'), loadCSV('library.csv')]).then(([books, library])=>{
  /* --- ëŒ€ì¶œí˜„í™© í…Œì´ë¸” ë¨¼ì € ê·¸ë¦¬ê¸° --- */
  renderTable(books, 'loanTable');

  /* --- books.csv(ì´ë ¥) â†’ ì½”ë“œë³„ ìµœì‹  ìƒíƒœ/ìµœê·¼ë°˜ë‚©ì¼ êµ¬í•˜ê¸° --- */
  const bh = books[0].map(norm);
  const bDateIdx   = findColIndex(bh, ['ë“±ë¡ì¼','ëŒ€ì¶œì¼','ì¼ì']);
  const bCodeIdx   = findColIndex(bh, ['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
  const bStatusIdx = findColIndex(bh, ['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
  const bUserIdx   = findColIndex(bh, ['ëŒ€ì—¬ì','ëŒ€ì¶œì']);

  const latestByCode = {}; // {code:{status, borrower, lastReturn}}
  for(let i=1;i<books.length;i++){
    const date = norm(books[i][bDateIdx]);
    const code = norm(books[i][bCodeIdx]);
    const status = norm(books[i][bStatusIdx]);
    const borrower = norm(books[i][bUserIdx]);
    if(!code) continue;

    if(!latestByCode[code]) latestByCode[code] = {status:'', borrower:'', lastReturn:''};
    if(status.includes('ë°˜ë‚©')) latestByCode[code].lastReturn = date;
    // ì´ë ¥ì´ ì•„ë˜ë¡œ ëˆ„ì ëœë‹¤ê³  ê°€ì • â†’ "ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ ê°’"ì´ ìµœì‹ 
    latestByCode[code].status   = status;
    latestByCode[code].borrower = borrower;
  }

  /* --- library.csvì— ìµœì‹  ìƒíƒœ ë°˜ì˜ (+ìµœê·¼ë°˜ë‚©ì¼ ì—´ ìë™ ì¶”ê°€) --- */
  const lh = library[0].map(norm);
  const lCodeIdx   = findColIndex(lh, ['ì½”ë“œ','ì½”ë“œë²ˆí˜¸']);
  let   lStatusIdx = findColIndex(lh, ['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
  let   lUserIdx   = findColIndex(lh, ['ëŒ€ì—¬ì','ëŒ€ì¶œì']);
  let   lRetIdx    = findColIndex(lh, ['ìµœê·¼ë°˜ë‚©ì¼','ë°˜ë‚©ì¼']);

  if(lStatusIdx === -1){ library[0].push('ëŒ€ì¶œì—¬ë¶€'); lStatusIdx = library[0].length-1; }
  if(lUserIdx   === -1){ library[0].push('ëŒ€ì¶œì');   lUserIdx   = library[0].length-1; }
  if(lRetIdx    === -1){ library[0].push('ìµœê·¼ë°˜ë‚©ì¼');lRetIdx    = library[0].length-1; }

  for(let i=1;i<library.length;i++){
    const code = norm(library[i][lCodeIdx]);
    const rec  = latestByCode[code];
    if(!rec){
      library[i][lStatusIdx] = '';
      library[i][lUserIdx]   = '';
      library[i][lRetIdx]    = '';
      continue;
    }
    if(rec.status.includes('ë°˜ë‚©')){
      library[i][lStatusIdx] = 'ë°˜ë‚©';
      library[i][lUserIdx]   = '';
      library[i][lRetIdx]    = rec.lastReturn || '';
    }else{
      library[i][lStatusIdx] = rec.status || 'ëŒ€ì¶œ';
      library[i][lUserIdx]   = rec.borrower || '';
      library[i][lRetIdx]    = rec.lastReturn || '';
    }
  }

  /* --- ë°˜ì˜ëœ libraryë¡œ ë Œë”ë§(ì—¬ê¸°ì— QR ë²„íŠ¼ í¬í•¨) --- */
  renderTable(library, 'libraryTable', true);

  /* --- ê²€ìƒ‰ ì—°ê²° --- */
  addSearch('searchLoans','loanTable');
  addSearch('searchLibrary','libraryTable');

  /* --- "ëŒ€ì¶œ ì¤‘ë§Œ ë³´ê¸°" í•„í„° --- */
  const btn = document.getElementById('btnBorrowed');
  let on = false;
  btn.onclick = ()=>{
    on = !on; btn.classList.toggle('active', on);
    const header = library[0];
    const statusIdx = findColIndex(header, ['ìƒíƒœ','ëŒ€ì¶œì—¬ë¶€']);
    const trs = document.querySelectorAll('#libraryTable tr');
    for(let i=1;i<trs.length;i++){
      const td = trs[i].querySelectorAll('td')[statusIdx];
      const isBorrowed = td && /(ëŒ€ì¶œ|ëŒ€ì—¬)/.test(td.textContent);
      trs[i].style.display = (on && !isBorrowed) ? 'none' : '';
      trs[i].classList.toggle('borrowed', isBorrowed);
    }
  };
});

/* ====== 7) íƒ­ ì „í™˜ ====== */
document.getElementById('btnLoans').onclick = ()=>{
  document.getElementById('loanSection').classList.remove('hidden');
  document.getElementById('librarySection').classList.add('hidden');
  document.getElementById('btnLoans').classList.add('active');
  document.getElementById('btnLibrary').classList.remove('active');
};
document.getElementById('btnLibrary').onclick = ()=>{
  document.getElementById('librarySection').classList.remove('hidden');
  document.getElementById('loanSection').classList.add('hidden');
  document.getElementById('btnLibrary').classList.add('active');
  document.getElementById('btnLoans').classList.remove('active');
};
</script>
</body>
</html>
